var va=Object.defineProperty;var ya=(i,t,r)=>t in i?va(i,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[t]=r;var ae=(i,t,r)=>(ya(i,typeof t!="symbol"?t+"":t,r),r);import{u as ba,i as H,j as e,P as O,B as p,T as l,a as z,C as le,A as fe,b as We,c as De,G as m,L as nt,d as Oe,e as ee,f as tt,I as qe,M as wr,S as zi,D as he,F as rr,g as hr,h as Et,k as Sa,l as Je,r as wa,m as Lr,n as ja,o as _a,p as ka,q as Ia,s as Mi,t as _e,v as we,w as Ea,x as Ca,y as Ct,z as ve,E as yt,H as sn,J as Lt,K as Bt,N as Aa,O as fr,Q as Ra,R as jr,U as _r,V as an,W as Ee,Z as Ta,X as Pa,Y as $a,_ as Oa,$ as on,a0 as ut,a1 as Da,a2 as za,a3 as Ma,a4 as La,a5 as pr,a6 as Li,a7 as Ba,a8 as kr,a9 as Ir,aa as Er,ab as Cr,ac as Ua}from"./ui-c2c9966d.js";import{g as Na,r as g,a as At,S as Va,u as Ft,N as Ne,e as st,L as re,f as cn,h as Fa,H as Wa,i as qa,j as ue}from"./vendor-91e15b2e.js";import{a,s as Ga}from"./index-81c07cf2.js";import{g as A,e as ln,c as dn,v as Ha}from"./supabaseClient-510d7de7.js";import{c as un,_ as ge}from"./supabase-215a852a.js";var Br={},xr={};const Ya=Na(ba);var Bi;function Y(){return Bi||(Bi=1,function(i){"use client";Object.defineProperty(i,"__esModule",{value:!0}),Object.defineProperty(i,"default",{enumerable:!0,get:function(){return t.createSvgIcon}});var t=Ya}(xr)),xr}var Qa=H;Object.defineProperty(Br,"__esModule",{value:!0});var ar=Br.default=void 0,Ka=Qa(Y()),Za=e;ar=Br.default=(0,Ka.default)((0,Za.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var Ur={},Ja=H;Object.defineProperty(Ur,"__esModule",{value:!0});var gn=Ur.default=void 0,Xa=Ja(Y()),eo=e;gn=Ur.default=(0,Xa.default)((0,eo.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z"}),"Refresh");var Nr={},to=H;Object.defineProperty(Nr,"__esModule",{value:!0});var bt=Nr.default=void 0,ro=to(Y()),io=e;bt=Nr.default=(0,ro.default)((0,io.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle");var Vr={},no=H;Object.defineProperty(Vr,"__esModule",{value:!0});var Ut=Vr.default=void 0,so=no(Y()),ao=e;Ut=Vr.default=(0,so.default)((0,ao.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"}),"Error");var Fr={},oo=H;Object.defineProperty(Fr,"__esModule",{value:!0});var Wr=Fr.default=void 0,co=oo(Y()),lo=e;Wr=Fr.default=(0,co.default)((0,lo.jsx)("path",{d:"M1 21h22L12 2zm12-3h-2v-2h2zm0-4h-2v-4h2z"}),"Warning");var qr={},uo=H;Object.defineProperty(qr,"__esModule",{value:!0});var hn=qr.default=void 0,go=uo(Y()),ho=e;hn=qr.default=(0,go.default)((0,ho.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-6h2zm0-8h-2V7h2z"}),"Info");let fo=class{constructor(){ae(this,"services",{})}register(t,r){this.services[t]=r,a("ServiceRegistry",`Service "${t}" registered successfully`,"info"),console.log(`Service "${t}" registered successfully`)}get(t){if(!this.services[t])throw a("ServiceRegistry",`Service "${t}" not registered`,"error"),console.error(`Service "${t}" not registered`),new Error(`Service "${t}" not registered`);return this.services[t]}has(t){return!!this.services[t]}listServices(){return Object.keys(this.services)}async getOrInitialize(t,r){return this.has(t)?this.get(t):(await r.initializeService(t),this.get(t))}async withService(t,r,n){const s=await this.getOrInitialize(t,n);return r(s)}};const po=new fo,Md={ALICE:"alice-in-wonderland",ALICE_STRING:"alice-in-wonderland",ALICE_UUID:"550e8400-e29b-41d4-a716-446655440000"},xo={CHAT:"chat",DEFINITION:"definition",ANALYSIS:"analysis",SUMMARY:"summary"},G={AUTH_SERVICE:"authService",BOOK_SERVICE:"bookService",AI_SERVICE:"aiService",DICTIONARY_SERVICE:"dictionaryService",FEEDBACK_SERVICE:"feedbackService",TRIGGER_SERVICE:"triggerService",STATISTICS_SERVICE:"statisticsService",CONSULTANT_SERVICE:"consultantService",INTERACTION_SERVICE:"interactionService",MONITORING_SERVICE:"monitoringService",DATABASE_SERVICE:"databaseService",ANALYTICS_SERVICE:"analyticsService",SAMPLE_SERVICE:"sampleService"};var Fe=(i=>(i.UNKNOWN_ERROR="UNKNOWN_ERROR",i.NETWORK_ERROR="NETWORK_ERROR",i.TIMEOUT_ERROR="TIMEOUT_ERROR",i.SERVICE_ERROR="SERVICE_ERROR",i.SERVICE_UNAVAILABLE="SERVICE_UNAVAILABLE",i.SERVICE_INITIALIZATION_ERROR="SERVICE_INITIALIZATION_ERROR",i.AUTH_ERROR="AUTH_ERROR",i.UNAUTHORIZED="UNAUTHORIZED",i.DATA_ERROR="DATA_ERROR",i.NOT_FOUND="NOT_FOUND",i.VALIDATION_ERROR="VALIDATION_ERROR",i.SUPABASE_ERROR="SUPABASE_ERROR",i.SUPABASE_QUERY_ERROR="SUPABASE_QUERY_ERROR",i.SUPABASE_AUTH_ERROR="SUPABASE_AUTH_ERROR",i.API_ERROR="API_ERROR",i.API_RATE_LIMIT="API_RATE_LIMIT",i))(Fe||{});class ne extends Error{constructor(t,r,n,s,o){super(t),this.code=r,this.details=n,this.retry=s,this.originalError=o,this.name="AppError",Error.captureStackTrace&&Error.captureStackTrace(this,ne),a("AppError",t,"error",{code:r,details:n,retry:s,stack:this.stack})}toJSON(){return{name:this.name,message:this.message,code:this.code,details:this.details,retry:this.retry,stack:this.stack}}}function te(i,t,r){return console.error(`${t}.${r} error:`,i),i instanceof ne?i:i!=null&&i.code&&(i!=null&&i.message)&&(i!=null&&i.details)?new ne(`${t}.${r}: ${i.message}`,`SUPABASE_${i.code}`,{serviceName:t,operation:r,details:i.details},mo(i),i):fn(i)?new ne(`${t}.${r}: Network error`,"NETWORK_ERROR",{serviceName:t,operation:r},!0,i):pn(i)?new ne(`${t}.${r}: Request timed out`,"TIMEOUT_ERROR",{serviceName:t,operation:r},!0,i):new ne(i.message||`Error in ${t}.${r}`,"SERVICE_ERROR",{serviceName:t,operation:r},!1,i)}function fn(i){var r;if(!i)return!1;if(i.name==="NetworkError")return!0;const t=((r=i.message)==null?void 0:r.toLowerCase())||"";return t.includes("network")||t.includes("internet")||t.includes("offline")||t.includes("connection")||t.includes("unreachable")}function pn(i){var r;if(!i)return!1;if(i.name==="TimeoutError")return!0;const t=((r=i.message)==null?void 0:r.toLowerCase())||"";return t.includes("timeout")||t.includes("timed out")}function mo(i){return i?!!(fn(i)||pn(i)||i.status&&i.status>=500&&i.status<600||i.code==="503"):!1}const lt=class lt{constructor(){ae(this,"services",{});ae(this,"initializers",new Map);ae(this,"initializationInProgress",new Map)}static getInstance(){return lt.instance||(lt.instance=new lt),lt.instance}register(t,r){this.services[t]=r,a("ServiceRegistry",`Service "${t}" registered successfully`,"info")}registerInitializer(t,r){this.initializers.set(t,r),a("ServiceRegistry",`Initializer for service "${t}" registered successfully`,"info")}get(t){if(!this.has(t)){const r=new ne(`Service "${t}" not registered`,Fe.SERVICE_ERROR,{serviceName:t});throw a("ServiceRegistry",r.message,"error"),r}return this.services[t]}async getService(t){if(this.has(t))return this.get(t);if(this.initializationInProgress.has(t))return a("ServiceRegistry",`Waiting for service "${t}" initialization to complete`,"info"),await this.initializationInProgress.get(t),this.get(t);if(!this.hasInitializer(t)){const r=new ne(`No initializer registered for service "${t}"`,Fe.SERVICE_INITIALIZATION_ERROR,{serviceName:t});throw a("ServiceRegistry",r.message,"error"),r}try{a("ServiceRegistry",`Initializing service "${t}"`,"info");const r=this.initializers.get(t),n=(async()=>{try{const s=await r();return this.register(t,s),s}catch(s){const o=s instanceof ne?s:new ne(`Failed to initialize service "${t}": ${s instanceof Error?s.message:String(s)}`,Fe.SERVICE_INITIALIZATION_ERROR,{serviceName:t,originalError:s});throw a("ServiceRegistry",o.message,"error"),o}finally{this.initializationInProgress.delete(t)}})();return this.initializationInProgress.set(t,n),await n,this.get(t)}catch(r){throw r}}has(t){return!!this.services[t]}hasInitializer(t){return this.initializers.has(t)}listServices(){return Object.keys(this.services)}listInitializers(){return Array.from(this.initializers.keys())}async withService(t,r){const n=await this.getService(t);return r(n)}async getOrInitialize(t,r){if(a("ServiceRegistry","Warning: getOrInitialize is deprecated, use getService instead","warning"),this.has(t))return this.get(t);try{return this.hasInitializer(t)?await this.getService(t):(await r.initializeService(t),this.get(t))}catch(n){const s=n instanceof ne?n:new ne(`Failed to initialize service "${t}": ${n instanceof Error?n.message:String(n)}`,Fe.SERVICE_INITIALIZATION_ERROR,{serviceName:t,originalError:n});throw a("ServiceRegistry",s.message,"error"),s}}};ae(lt,"instance");let Ar=lt;const S=Ar.getInstance(),rt={authService:[],bookService:["authService"],dictionaryService:["bookService"],aiService:["bookService","dictionaryService"],feedbackService:["authService","bookService"],triggerService:["authService","bookService"],statisticsService:["bookService","authService"],consultantService:["authService","bookService","feedbackService","triggerService"],interactionService:["authService","bookService"],monitoringService:[],databaseService:["authService"],analyticsService:[],sampleService:["bookService"]};function vo(){a("ServiceDependencies","Service dependency graph:","info"),Object.entries(rt).forEach(([i,t])=>{a("ServiceDependencies",`${i} depends on: ${t.join(", ")||"none"}`,"debug")})}function xn(){const i=new Set,t=[],r=new Set;function n(s){if(r.has(s)){const c=Array.from(r).join(" -> ")+` -> ${s}`;a("InitOrder",`Circular dependency detected: ${c}`,"error"),console.error(`Circular dependency detected: ${c}`);return}if(i.has(s))return;r.add(s);const o=rt[s]||[];for(const c of o)n(c);i.add(s),r.delete(s),t.push(s)}for(const s of Object.keys(rt))i.has(s)||n(s);return a("InitOrder",`Initialization order: ${t.join(", ")}`,"info"),t}class yo{constructor(){ae(this,"initFunctions",new Map);ae(this,"dependencies",new Map);ae(this,"initialized",new Set);ae(this,"initializing",new Set)}register(t,r,n){console.log(`Registering initialization function for ${t}`),this.initFunctions.set(t,r);const s=n||rt[t]||[];this.dependencies.set(t,s),a("ServiceInitManager",`Registered initialization function for ${t}`,"info"),console.log(`Available services for initialization: ${Array.from(this.initFunctions.keys()).join(", ")}`)}async initializeService(t){if(console.log(`Attempting to initialize service: ${t}`),this.initialized.has(t)){a("ServiceInitManager",`Service ${t} already initialized`,"info"),console.log(`Service ${t} already initialized`);return}if(this.initializing.has(t)){a("ServiceInitManager",`Circular initialization detected for service: ${t}`,"warning"),console.warn(`Circular initialization detected for service: ${t}`);return}if(!this.initFunctions.has(t))throw console.error(`No initialization function registered for service: ${t}`),console.error(`Available services: ${Array.from(this.initFunctions.keys()).join(", ")}`),a("ServiceInitManager",`No initialization function registered for service: ${t}`,"error"),new Error(`No initialization function registered for service: ${t}`);a("ServiceInitManager",`Initializing service: ${t}`,"info"),console.log(`Initializing service: ${t}`),this.initializing.add(t);const r=this.dependencies.get(t)||[];for(const n of r)await this.initializeService(n);try{console.log(`Executing initialization function for ${t}`),await this.initFunctions.get(t)(),this.initialized.add(t),a("ServiceInitManager",`Service ${t} initialized successfully`,"success"),console.log(`Service ${t} initialized successfully`)}catch(n){throw a("ServiceInitManager",`Error initializing service ${t}: ${n.message}`,"error"),console.error(`Error initializing service ${t}:`,n),n}finally{this.initializing.delete(t)}}async initializeAll(t={}){a("ServiceInitManager","Initializing all services","info"),console.log("Initializing all services");let r;t.useTopologicalOrder?(r=xn().filter(n=>this.initFunctions.has(n)),a("ServiceInitManager",`Using topological order: ${r.join(", ")}`,"info")):(r=Array.from(this.initFunctions.keys()),a("ServiceInitManager",`Using registration order: ${r.join(", ")}`,"info")),console.log(`Services to initialize: ${r.join(", ")}`);for(const n of r)await this.initializeService(n);a("ServiceInitManager","All services initialized successfully","success"),console.log("All services initialized successfully")}isInitialized(t){return this.initialized.has(t)}getInitializedServices(){return Array.from(this.initialized)}hasInitFunction(t){return this.initFunctions.has(t)}getRegisteredServices(){return Array.from(this.initFunctions.keys())}}const P=new yo,Pe=[{id:"550e8400-e29b-41d4-a716-446655440000",title:"Alice in Wonderland",author:"Lewis Carroll",description:"The classic tale of a girl who falls through a rabbit hole into a fantasy world.",cover_image_url:null,total_pages:100,created_at:new Date().toISOString(),chapters:[{id:"c1",book_id:"550e8400-e29b-41d4-a716-446655440000",title:"Down the Rabbit-Hole",number:1,created_at:new Date().toISOString(),sections:[{id:"s1",chapter_id:"c1",title:"Beginning",content:'Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do: once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it, "and what is the use of a book," thought Alice "without pictures or conversations?"',start_page:1,end_page:3,number:1,created_at:new Date().toISOString()},{id:"s2",chapter_id:"c1",title:"The Rabbit",content:'There was nothing so very remarkable in that; nor did Alice think it so very much out of the way to hear the Rabbit say to itself, "Oh dear! Oh dear! I shall be late!" (when she thought it over afterwards, it occurred to her that she ought to have wondered at this, but at the time it all seemed quite natural).',start_page:4,end_page:6,number:2,created_at:new Date().toISOString()},{id:"s3",chapter_id:"c1",title:"Down the Hole",content:"In another moment down went Alice after it, never once considering how in the world she was to get out again. The rabbit-hole went straight on like a tunnel for some way, and then dipped suddenly down, so suddenly that Alice had not a moment to think about stopping herself before she found herself falling down a very deep well.",start_page:7,end_page:10,number:3,created_at:new Date().toISOString()}]},{id:"c2",book_id:"550e8400-e29b-41d4-a716-446655440000",title:"The Pool of Tears",number:2,created_at:new Date().toISOString(),sections:[{id:"s4",chapter_id:"c2",title:"Curiouser and Curiouser",content:`"Curiouser and curiouser!" cried Alice (she was so much surprised, that for the moment she quite forgot how to speak good English); "now I'm opening out like the largest telescope that ever was! Good-bye, feet!"`,start_page:11,end_page:14,number:1,created_at:new Date().toISOString()},{id:"s5",chapter_id:"c2",title:"The White Rabbit Again",content:`And she went on planning to herself how she would manage it. "They must go by the carrier," she thought; "and how funny it'll seem, sending presents to one's own feet!"`,start_page:15,end_page:18,number:2,created_at:new Date().toISOString()}]},{id:"c3",book_id:"550e8400-e29b-41d4-a716-446655440000",title:"A Caucus-Race and a Long Tale",number:3,created_at:new Date().toISOString(),sections:[{id:"s6",chapter_id:"c3",title:"The Mouse",content:'"O Mouse, do you know the way out of this pool? I am very tired of swimming about here, O Mouse!" Alice thought this must be the right way of speaking to a mouse.',start_page:19,end_page:22,number:1,created_at:new Date().toISOString()},{id:"s7",chapter_id:"c3",title:"The Caucus-Race",content:"They were indeed a queer-looking party that assembled on the bank—the birds with draggled feathers, the animals with their fur clinging close to them, and all dripping wet, cross, and uncomfortable.",start_page:23,end_page:26,number:2,created_at:new Date().toISOString()}]}]}],ot=[{code:"ALICE123",book_id:"550e8400-e29b-41d4-a716-446655440000",is_used:!1,used_by:null,created_at:new Date().toISOString(),books:{id:"550e8400-e29b-41d4-a716-446655440000",title:"Alice in Wonderland",author:"Lewis Carroll"}},{code:"WONDERLAND",book_id:"550e8400-e29b-41d4-a716-446655440000",is_used:!1,used_by:null,created_at:new Date().toISOString(),books:{id:"550e8400-e29b-41d4-a716-446655440000",title:"Alice in Wonderland",author:"Lewis Carroll"}}],bo={alice:"The main character of the story, a curious young girl.",rabbit:"A white rabbit with pink eyes that Alice follows down the rabbit hole.",wonderland:"The magical world Alice discovers after falling down the rabbit hole.",curiouser:'A made-up comparative form of "curious" that Alice uses, showing her confusion and wonder.',telescope:"Used as a metaphor for Alice growing taller, comparing her body to an extending telescope.","caucus-race":"A race with no clear rules or winner, used as a method to get dry after being soaked in tears.",mouse:'A character Alice meets in the pool of tears who tells a "dry" tale to help everyone get dry.',"pool of tears":"A body of water created by Alice's giant tears when she was 9 feet tall."},Zt={},Xe={},ke={},mr=[],So=[{id:"prompt1",prompt_text:"What did you find most interesting about this chapter?",prompt_type:"reflection",active:!0,created_at:new Date().toISOString()},{id:"prompt2",prompt_text:"Which character do you relate to most and why?",prompt_type:"character",active:!0,created_at:new Date().toISOString()}],Ui=[],vr=[],ct=[],Jt=[],Ve=[],Ni=[];let et=null,vt=null;const Z={auth:{getUser:()=>et,getSession:()=>({data:{session:vt},error:null}),signIn:(i,t)=>(et={id:"mock-user-id",email:i,aud:"authenticated",role:"authenticated",created_at:new Date().toISOString()},vt={access_token:"mock-access-token",refresh_token:"mock-refresh-token",expires_at:Date.now()+3600,user:et},{data:{user:et,session:vt},error:null}),signUp:(i,t,r,n)=>(et={id:"mock-user-id",email:i,aud:"authenticated",role:"authenticated",created_at:new Date().toISOString(),user_metadata:r&&n?{first_name:r,last_name:n}:{}},vt={access_token:"mock-access-token",refresh_token:"mock-refresh-token",expires_at:Date.now()+3600,user:et},r&&n&&(ke["mock-user-id"]={id:"mock-user-id",first_name:r,last_name:n,email:i,is_consultant:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:{user:et,session:vt},error:null}),signOut:()=>(et=null,vt=null,{error:null}),onAuthStateChange:i=>({data:{subscription:{unsubscribe:()=>{}}}})},profiles:{getUserProfile:i=>({data:ke[i]||null,error:null}),createUserProfile:(i,t,r,n)=>{const s={id:i,first_name:t,last_name:r,email:n,is_consultant:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return ke[i]=s,{data:s,error:null}},updateUserProfile:(i,t)=>ke[i]?(ke[i]={...ke[i],...t,updated_at:new Date().toISOString()},{data:ke[i],error:null}):{data:null,error:{message:"Profile not found"}}},books:{getBookContent:i=>({data:Pe.find(r=>r.id===i),error:null}),getAllBooks:()=>({data:Pe.map(i=>({id:i.id,title:i.title,author:i.author,description:i.description,cover_image_url:i.cover_image_url,total_pages:i.total_pages,created_at:i.created_at})),error:null}),getSectionsForPage:(i,t)=>{const r=Pe.find(s=>s.id===i);if(!r)return{data:[],error:null};const n=[];return r.chapters.forEach(s=>{s.sections.forEach(o=>{t>=o.start_page&&t<=o.end_page&&n.push({...o,chapter_title:s.title,chapter_number:s.number})})}),{data:n,error:null}},getDefinition:(i,t,r,n)=>({data:bo[t.toLowerCase()]||null,error:null}),verifyBookCode:i=>{const t=ot.find(n=>n.code===i.toUpperCase());if(t)return{data:t,error:null};const r={code:i.toUpperCase(),book_id:"550e8400-e29b-41d4-a716-446655440000",is_used:!1,used_by:null,created_at:new Date().toISOString(),books:{id:"550e8400-e29b-41d4-a716-446655440000",title:"Alice in Wonderland",author:"Lewis Carroll"}};return ot.push(r),{data:r,error:null}},markCodeAsUsed:(i,t)=>{const r=ot.findIndex(n=>n.code===i.toUpperCase());if(r===-1){const n={code:i.toUpperCase(),book_id:"550e8400-e29b-41d4-a716-446655440000",is_used:!0,used_by:t,created_at:new Date().toISOString(),books:{id:"550e8400-e29b-41d4-a716-446655440000",title:"Alice in Wonderland",author:"Lewis Carroll"}};return ot.push(n),{data:n,error:null}}return ot[r]={...ot[r],is_used:!0,used_by:t},{data:ot[r],error:null}}},progress:{saveReadingProgress:(i,t,r,n)=>{var c;const s=`${i}:${t}`,o=new Date().toISOString();return Zt[s]={id:`progress-${s}`,user_id:i,book_id:t,section_id:r,last_position:n||null,last_read_at:o,created_at:((c=Zt[s])==null?void 0:c.created_at)||o,updated_at:o},{data:Zt[s],error:null}},getReadingProgress:(i,t)=>{const r=`${i}:${t}`,n=Zt[r];if(!n)return{data:null,error:null};const s=Pe.find(h=>h.id===t);if(!s)return{data:null,error:{message:"Book not found"}};let o="",c="",d=0;for(const h of s.chapters){const u=h.sections.find(f=>f.id===n.section_id);if(u){o=u.title,c=h.title,d=u.start_page;break}}return{data:{section_id:n.section_id,last_position:n.last_position,section_title:o,chapter_title:c,page_number:d},error:null}},updateReadingStats:(i,t,r,n)=>{const s=`${i}:${t}`,o=new Date().toISOString();return Xe[s]?Xe[s]={...Xe[s],total_reading_time:Xe[s].total_reading_time+r,pages_read:Math.max(Xe[s].pages_read,n),last_session_date:o,updated_at:o}:Xe[s]={id:`stats-${s}`,user_id:i,book_id:t,total_reading_time:r,pages_read:n,last_session_date:o,created_at:o,updated_at:o},{data:Xe[s],error:null}},getReadingStats:(i,t)=>{const r=`${i}:${t}`,n=Xe[r];if(!n)return{data:null,error:null};const s=Pe.find(o=>o.id===t);return s?{data:{...n,percentage_complete:Math.round(n.pages_read/s.total_pages*100)},error:null}:{data:null,error:{message:"Book not found"}}}},ai:{saveAiInteraction:(i,t,r,n,s,o)=>{const c={id:`ai-${mr.length+1}`,user_id:i,book_id:t,section_id:s||null,question:r,context:o||null,response:n,created_at:new Date().toISOString()};return mr.push(c),{data:c,error:null}},getAiInteractions:(i,t)=>({data:mr.filter(n=>n.user_id===i&&n.book_id===t),error:null}),getAiPrompts:i=>({data:So.filter(r=>r.prompt_type===i&&r.active),error:null}),savePromptResponse:(i,t,r)=>{const n={id:`response-${Ui.length+1}`,user_id:i,prompt_id:t,response:r,created_at:new Date().toISOString()};return Ui.push(n),{data:n,error:null}}},consultant:{getConsultantAssignments:i=>({data:vr.filter(r=>r.consultant_id===i&&r.active),error:null}),assignConsultant:(i,t,r)=>{const n={id:`assignment-${vr.length+1}`,consultant_id:i,user_id:t,book_id:r,active:!0,created_at:new Date().toISOString()};return vr.push(n),{data:n,error:null}},createTrigger:(i,t,r,n,s)=>{const o={id:`trigger-${ct.length+1}`,consultant_id:s||null,user_id:i,book_id:t,trigger_type:r,message:n||null,is_processed:!1,created_at:new Date().toISOString()};return ct.push(o),{data:o,error:null}},getTriggers:i=>({data:ct.filter(r=>r.consultant_id===i&&!r.is_processed),error:null}),markTriggerProcessed:i=>{const t=ct.findIndex(n=>n.id===i);if(t===-1)return{data:null,error:{message:"Trigger not found"}};const r=new Date().toISOString();return ct[t]={...ct[t],is_processed:!0,processed_at:r},{data:ct[t],error:null}},isConsultant:i=>{const t=ke[i];return t!=null&&t.is_consultant?{data:!0,error:null}:i==="mock-consultant-id"||i==="mock-user-id"?{data:!0,error:null}:{data:!1,error:null}},submitFeedback:(i,t,r,n,s,o=!1)=>{const c={id:`feedback-${Jt.length+1}`,user_id:i,book_id:t,section_id:s||null,feedback_type:r,content:n,is_public:o,created_at:new Date().toISOString()};return Jt.push(c),{data:c,error:null}},getUserFeedback:(i,t)=>({data:Jt.filter(s=>s.user_id===i&&s.book_id===t).map(s=>{if(!s.section_id)return s;let o="",c="";for(const d of Pe)if(d.id===t){for(const h of d.chapters){for(const u of h.sections)if(u.id===s.section_id){o=u.title,c=h.title;break}if(o)break}if(o)break}return{...s,section:{title:o,chapter_title:c}}}),error:null}),getPublicFeedback:i=>({data:Jt.filter(n=>n.book_id===i&&n.is_public).map(n=>{const s=ke[n.user_id];let o="",c="";if(n.section_id){for(const d of Pe)if(d.id===i){for(const h of d.chapters){for(const u of h.sections)if(u.id===n.section_id){o=u.title,c=h.title;break}if(o)break}if(o)break}}return{...n,user:s,section:n.section_id?{title:o,chapter_title:c}:void 0}}),error:null}),submitHelpRequest:(i,t,r,n,s)=>{const o={id:`help-${Ve.length+1}`,user_id:i,book_id:t,section_id:n||null,status:"PENDING",content:r,context:s||null,assigned_to:null,resolved_at:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return Ve.push(o),{data:o,error:null}},getUserHelpRequests:(i,t)=>({data:Ve.filter(s=>s.user_id===i&&s.book_id===t).map(s=>{const o=s.assigned_to?ke[s.assigned_to]:null;let c="",d="";if(s.section_id){for(const h of Pe)if(h.id===t){for(const u of h.chapters){for(const f of u.sections)if(f.id===s.section_id){c=f.title,d=u.title;break}if(c)break}if(c)break}}return{...s,consultant:o,section:s.section_id?{title:c,chapter_title:d}:void 0}}),error:null}),getConsultantHelpRequests:i=>({data:Ve.filter(n=>n.assigned_to===i).map(n=>{const s=ke[n.user_id];let o="",c="";if(n.section_id){for(const d of Pe)if(d.id===n.book_id){for(const h of d.chapters){for(const u of h.sections)if(u.id===n.section_id){o=u.title,c=h.title;break}if(o)break}if(o)break}}return{...n,user:s,section:n.section_id?{title:o,chapter_title:c}:void 0}}),error:null}),getPendingHelpRequests:()=>({data:Ve.filter(r=>r.status==="PENDING"&&!r.assigned_to).map(r=>{const n=ke[r.user_id];let s="",o="";if(r.section_id){for(const c of Pe)if(c.id===r.book_id){for(const d of c.chapters){for(const h of d.sections)if(h.id===r.section_id){s=h.title,o=d.title;break}if(s)break}if(s)break}}return{...r,user:n,section:r.section_id?{title:s,chapter_title:o}:void 0}}),error:null}),updateHelpRequestStatus:(i,t,r)=>{const n=Ve.findIndex(o=>o.id===i);if(n===-1)return{data:null,error:{message:"Help request not found"}};const s={status:t,updated_at:new Date().toISOString()};return t==="IN_PROGRESS"&&r&&(s.assigned_to=r),t==="RESOLVED"&&(s.resolved_at=new Date().toISOString()),Ve[n]={...Ve[n],...s},{data:Ve[n],error:null}},logConsultantAction:(i,t,r,n)=>{const s={id:`action-${Ni.length+1}`,consultant_id:i,user_id:t,action_type:r,details:n||null,created_at:new Date().toISOString()};return Ni.push(s),{data:s,error:null}}}};console.log("Backend status: Using REAL Supabase backend");const wo=!1,jo=!wo;console.log("Backend status: Using REAL Supabase backend");var jt=(i=>(i.LOGIN="LOGIN",i.PAGE_SYNC="PAGE_SYNC",i.SECTION_SYNC="SECTION_SYNC",i.DEFINITION_LOOKUP="DEFINITION_LOOKUP",i.AI_QUERY="AI_QUERY",i.HELP_REQUEST="HELP_REQUEST",i.FEEDBACK_SUBMISSION="FEEDBACK_SUBMISSION",i.QUIZ_ATTEMPT="QUIZ_ATTEMPT",i.NOTE_CREATION="NOTE_CREATION",i))(jt||{});const _o=async()=>(a("LoggingService","Creating logging service","info"),{logInteraction:async(t,r,n={})=>{try{a("LoggingService",`Logging interaction: ${r}`,"info",{userId:t,...n});const{bookId:s,sectionId:o,pageNumber:c,content:d,...h}=n,u=Object.keys(h).length>0?h:null,f=await A(),{error:x}=await f.from("interactions").insert({user_id:t,event_type:r,book_id:s||null,section_id:o||null,page_number:c||null,content:d||null,context:u?JSON.stringify(u):null});return x?(a("LoggingService",`Error logging interaction: ${x.message}`,"error",x),!1):!0}catch(s){return a("LoggingService","Error logging interaction","error",s),!1}},getUserInteractions:async(t,r={})=>{try{const{eventType:n,bookId:s,limit:o=100,offset:c=0}=r;a("LoggingService","Getting user interactions","info",{userId:t,eventType:n,bookId:s,limit:o,offset:c});let h=(await A()).from("interactions").select("*").eq("user_id",t).order("created_at",{ascending:!1}).range(c,c+o-1);n&&(h=h.eq("event_type",n)),s&&(h=h.eq("book_id",s));const{data:u,error:f}=await h;return f?(a("LoggingService",`Error getting user interactions: ${f.message}`,"error",f),[]):u||[]}catch(n){return a("LoggingService","Error getting user interactions","error",n),[]}},getInteractionStats:async(t,r={})=>{try{const{bookId:n,startDate:s,endDate:o}=r;a("LoggingService","Getting interaction stats","info",{userId:t,bookId:n,startDate:s,endDate:o});let d=(await A()).from("interactions").select("event_type").eq("user_id",t);n&&(d=d.eq("book_id",n)),s&&(d=d.gte("created_at",s.toISOString())),o&&(d=d.lte("created_at",o.toISOString()));const{data:h,error:u}=await d;if(u)return a("LoggingService",`Error getting interaction stats: ${u.message}`,"error",u),{total:0};const f={total:(h==null?void 0:h.length)||0,byType:{}};return h==null||h.forEach(x=>{const k=x.event_type;f.byType[k]=(f.byType[k]||0)+1}),f}catch(n){return a("LoggingService","Error getting interaction stats","error",n),{total:0}}}});P.register("loggingService",async()=>{const i=await _o();S.register("loggingService",i)});const Nt=async(i,t,r)=>(await S.getOrInitialize("loggingService",P)).logInteraction(i,t,r),mn=async()=>{a("AuthService","Creating auth service","info");const i=async()=>await jo();return{signIn:async(r,n)=>{var s;try{if(a("AuthService","Signing in user","info"),await i()){const c=await(await A()).auth.signInWithPassword({email:r,password:n});if(c.error)throw c.error;return(s=c.data)!=null&&s.user&&await Nt(c.data.user.id,jt.LOGIN,{content:"User logged in successfully"}).catch(d=>{a("AuthService","Error logging login interaction","error",d)}),c}else return Z.auth.signIn(r,n)}catch(o){throw te(o,"authService","signIn")}},signUp:async(r,n,s,o)=>{try{if(a("AuthService","Signing up user","info"),await i()){const c=await A(),d=s&&o?{data:{first_name:s,last_name:o}}:void 0,h=await c.auth.signUp({email:r,password:n,options:d});if(h.error)throw h.error;return h}else return Z.auth.signUp(r,n)}catch(c){throw te(c,"authService","signUp")}},signOut:async()=>{try{if(a("AuthService","Signing out user","info"),await i()){const n=await(await A()).auth.signOut();if(n.error)throw n.error;return n}else return Z.auth.signOut()}catch(r){throw te(r,"authService","signOut")}},getSession:async()=>{try{if(a("AuthService","Getting session","info"),await i()){const n=await(await A()).auth.getSession();if(n.error)throw n.error;return n}else return Z.auth.getSession()}catch(r){throw te(r,"authService","getSession")}},getUser:async()=>{try{if(a("AuthService","Getting user","info"),await i()){const r=await A(),{data:n,error:s}=await r.auth.getUser();if(s)throw s;return{data:n,error:null}}else return Z.auth.getUser()}catch(r){throw te(r,"authService","getUser")}},getUserProfile:async r=>{try{if(a("AuthService",`Getting user profile for ${r}`,"info"),await i()){const n=await A(),{data:s,error:o}=await n.from("profiles").select("*").eq("id",r).single();if(o)throw a("AuthService",`Error fetching profile for user ${r}:`,"error",o.message),o;return a("AuthService",`Profile fetched successfully for user ${r}`,"success"),{data:s,error:null}}else return Z.auth.getUserProfile(r)}catch(n){throw te(n,"authService","getUserProfile")}},createUserProfile:async(r,n)=>{try{if(a("AuthService",`Creating user profile for ${r}`,"info"),await i()){const s=await A(),{data:o,error:c}=await s.from("profiles").insert({id:r,...n,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(c)throw c;return{data:o,error:null}}else return Z.auth.createUserProfile(r,n)}catch(s){throw te(s,"authService","createUserProfile")}},updateUserProfile:async(r,n)=>{try{if(a("AuthService",`Updating user profile for ${r}`,"info"),await i()){const s=await A(),{data:o,error:c}=await s.from("profiles").update({...n,updated_at:new Date().toISOString()}).eq("id",r).select().single();if(c)throw c;return{data:o,error:null}}else return Z.auth.updateUserProfile(r,n)}catch(s){throw te(s,"authService","updateUserProfile")}},onAuthStateChange:r=>{try{return a("AuthService","Setting up auth state change listener","info"),i()?A().auth.onAuthStateChange(r):Z.auth.onAuthStateChange(r)}catch(n){throw te(n,"authService","onAuthStateChange")}},resetPassword:async r=>{try{if(a("AuthService",`Sending password reset email to ${r}`,"info"),await i()){const n=await A(),{data:s,error:o}=await n.auth.resetPasswordForEmail(r);if(o)throw o;return{data:s,error:null}}else return Z.auth.resetPassword(r)}catch(n){throw te(n,"authService","resetPassword")}},verifyBookCode:async r=>{try{if(a("AuthService",`Verifying book code: ${r}`,"info"),await i()){const n=await A(),{data:s,error:o}=await n.from("verification_codes").select("*").eq("code",r).eq("is_used",!1).single();if(o)throw o;return{data:s,error:null}}else return Z.auth.verifyBookCode(r)}catch(n){throw te(n,"authService","verifyBookCode")}}}};P.register("authService",async()=>{const i=await mn();S.register("authService",i)});const vn=async(i,t)=>(await S.getOrInitialize("authService",P)).signIn(i,t),yn=async(i,t,r,n)=>(await S.getOrInitialize("authService",P)).signUp(i,t,r,n),bn=async()=>(await S.getOrInitialize("authService",P)).signOut(),Sn=async()=>(await S.getOrInitialize("authService",P)).getSession(),wn=async()=>(await S.getOrInitialize("authService",P)).getUser(),jn=async i=>(await S.getOrInitialize("authService",P)).getUserProfile(i),_n=async(i,t)=>(await S.getOrInitialize("authService",P)).createUserProfile(i,t),kn=async(i,t)=>(await S.getOrInitialize("authService",P)).updateUserProfile(i,t),In=i=>S.get("authService").onAuthStateChange(i),En=async i=>(await S.getOrInitialize("authService",P)).resetPassword(i),Cn=async i=>(await S.getOrInitialize("authService",P)).verifyBookCode(i),ko={signIn:vn,signUp:yn,signOut:bn,getSession:Sn,getUser:wn,getUserProfile:jn,createUserProfile:_n,updateUserProfile:kn,onAuthStateChange:In,resetPassword:En,verifyBookCode:Cn},An=Object.freeze(Object.defineProperty({__proto__:null,createAuthService:mn,createUserProfile:_n,default:ko,getSession:Sn,getUser:wn,getUserProfile:jn,onAuthStateChange:In,resetPassword:En,signIn:vn,signOut:bn,signUp:yn,updateUserProfile:kn,verifyBookCode:Cn},Symbol.toStringTag,{value:"Module"}));console.log("Loading bookService module");const Rn=async()=>(a("BookService","Creating book service","info"),console.log("Creating book service"),{getBook:async t=>{try{return a("BookService",`Getting book with ID ${t}`,"info"),console.log(`BookService: Getting book with ID ${t}`),{id:t,title:"Alice in Wonderland",author:"Lewis Carroll",description:"Alice's Adventures in Wonderland is an 1865 novel by English author Lewis Carroll. It tells of a young girl named Alice, who falls through a rabbit hole into a subterranean fantasy world populated by peculiar, anthropomorphic creatures.",coverImage:"https://m.media-amazon.com/images/I/71pmz7EqjdL._AC_UF1000,1000_QL80_.jpg",totalPages:100,chapters:[{id:"ch1",chapter_number:1,title:"Down the Rabbit-Hole"},{id:"ch2",chapter_number:2,title:"The Pool of Tears"},{id:"ch3",chapter_number:3,title:"A Caucus-Race and a Long Tale"}]}}catch(r){return a("BookService",`Error getting book: ${r.message}`,"error"),console.error(`BookService: Error getting book: ${r.message}`),null}},getPage:async(t,r)=>{try{a("BookService",`Getting page ${r} for book ${t}`,"info"),console.log(`BookService: Getting page ${r} for book ${t}`);const n=Math.ceil(r/10),s=n===1?"Down the Rabbit-Hole":n===2?"The Pool of Tears":"A Caucus-Race and a Long Tale";return{id:`page-${r}`,bookId:t,pageNumber:r,title:`Chapter ${n}: ${s}`,content:`This is the content for page ${r} of Alice in Wonderland. 

Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do: once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it, 'and what is the use of a book,' thought Alice 'without pictures or conversations?'

So she was considering in her own mind (as well as she could, for the hot day made her feel very sleepy and stupid), whether the pleasure of making a daisy-chain would be worth the trouble of getting up and picking the daisies, when suddenly a White Rabbit with pink eyes ran close by her.

There was nothing so very remarkable in that; nor did Alice think it so very much out of the way to hear the Rabbit say to itself, 'Oh dear! Oh dear! I shall be late!' (when she thought it over afterwards, it occurred to her that she ought to have wondered at this, but at the time it all seemed quite natural); but when the Rabbit actually took a watch out of its waistcoat-pocket, and looked at it, and then hurried on, Alice started to her feet, for it flashed across her mind that she had never before seen a rabbit with either a waistcoat-pocket, or a watch to take out of it, and burning with curiosity, she ran across the field after it, and fortunately was just in time to see it pop down a large rabbit-hole under the hedge.`}}catch(n){return a("BookService",`Error getting page: ${n.message}`,"error"),console.error(`BookService: Error getting page: ${n.message}`),null}},getBookDetails:async t=>{try{a("BookService",`Getting book details for ${t}`,"info");const r=await A();return{id:t,title:"Alice in Wonderland",author:"Lewis Carroll",description:"Alice's Adventures in Wonderland is an 1865 novel by English author Lewis Carroll. It tells of a young girl named Alice, who falls through a rabbit hole into a subterranean fantasy world populated by peculiar, anthropomorphic creatures.",chapters:[{id:"ch1",chapter_number:1,title:"Down the Rabbit-Hole"},{id:"ch2",chapter_number:2,title:"The Pool of Tears"},{id:"ch3",chapter_number:3,title:"A Caucus-Race and a Long Tale"}]}}catch(r){return a("BookService",`Error getting book details: ${r.message}`,"error"),null}},getSectionDetails:async t=>{try{return a("BookService",`Getting section details for ${t}`,"info"),{id:t,title:"Section Title",content:"Section content goes here"}}catch(r){return a("BookService",`Error getting section details: ${r.message}`,"error"),null}},getBookContent:async t=>{try{return a("BookService",`Getting book content for ${t}`,"info"),{id:t,title:"Alice in Wonderland",content:"Mock content for Alice in Wonderland",currentPage:1,totalPages:100}}catch(r){return a("BookService",`Error getting book content: ${r.message}`,"error"),null}},getSectionByPage:async(t,r)=>{try{return a("BookService",`Getting section for page ${r}`,"info"),{id:`section_${r}`,title:`Section for page ${r}`,content:`Content for page ${r}`}}catch(n){return a("BookService",`Error getting section by page: ${n.message}`,"error"),null}},saveReadingProgress:async(t,r,n,s)=>{try{return a("BookService",`Saving reading progress for user ${t}`,"info"),!0}catch(o){return a("BookService",`Error saving reading progress: ${o.message}`,"error"),!1}},getReadingProgress:async(t,r)=>{try{return a("BookService",`Getting reading progress for user ${t}`,"info"),{userId:t,bookId:r,sectionId:"section_1",lastPosition:"10",lastReadAt:new Date().toISOString()}}catch(n){return a("BookService",`Error getting reading progress: ${n.message}`,"error"),null}},getReadingStats:async(t,r)=>{try{return a("BookService",`Getting reading stats for user ${t}`,"info"),{userId:t,bookId:r,totalReadingTime:120,pagesRead:10,percentageComplete:.1,lastSessionDate:new Date().toISOString()}}catch(n){return a("BookService",`Error getting reading stats: ${n.message}`,"error"),null}},updateReadingStats:async(t,r,n)=>{try{return a("BookService",`Updating reading stats for user ${t}`,"info"),!0}catch(s){return a("BookService",`Error updating reading stats: ${s.message}`,"error"),!1}},updateReadingProgress:async(t,r,n,s)=>{try{return a("BookService",`Updating reading progress for user ${t}, book ${r}, page ${n}, time ${s}s`,"info"),console.log(`BookService: Updating reading progress for user ${t}, book ${r}, page ${n}, time ${s}s`),await Nt(t,jt.PAGE_SYNC,{bookId:r,pageNumber:n,content:`User synced to page ${n}`,readingTime:s}).catch(o=>{a("BookService","Error logging page sync interaction","error",o)}),!0}catch(o){return a("BookService",`Error updating reading progress: ${o.message}`,"error"),console.error(`BookService: Error updating reading progress: ${o.message}`),!1}}});console.log(`Registering initialization function for ${G.BOOK_SERVICE}`);P.register(G.BOOK_SERVICE,async()=>{console.log("Creating book service for registration");const i=await Rn();console.log("Registering book service in registry"),S.register(G.BOOK_SERVICE,i),console.log("Book service registered successfully")},[]);const Ce=i=>async(...t)=>(S.has(G.BOOK_SERVICE)||await P.initializeService(G.BOOK_SERVICE),S.get(G.BOOK_SERVICE)[i](...t)),Tn=Ce("getBook"),Pn=Ce("getPage"),$n=Ce("getBookDetails"),On=Ce("getSectionDetails"),Dn=Ce("getBookContent"),zn=Ce("getSectionByPage"),Mn=Ce("saveReadingProgress"),Ln=Ce("getReadingProgress"),Bn=Ce("getReadingStats"),Un=Ce("updateReadingStats"),Nn=Ce("updateReadingProgress"),Io={getBook:Tn,getPage:Pn,getBookDetails:$n,getSectionDetails:On,getBookContent:Dn,getSectionByPage:zn,saveReadingProgress:Mn,getReadingProgress:Ln,getReadingStats:Bn,updateReadingStats:Un,updateReadingProgress:Nn};console.log("bookService module loaded");const Vn=Object.freeze(Object.defineProperty({__proto__:null,createBookService:Rn,default:Io,getBook:Tn,getBookContent:Dn,getBookDetails:$n,getPage:Pn,getReadingProgress:Ln,getReadingStats:Bn,getSectionByPage:zn,getSectionDetails:On,saveReadingProgress:Mn,updateReadingProgress:Nn,updateReadingStats:Un},Symbol.toStringTag,{value:"Module"})),Vi=xo,Eo=async()=>{a("AIService","Creating AI service","info");const i={createConversation:(t,r,n)=>{a("AIService","Creating conversation","info");const s=new Date().toISOString();return{id:`conv_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,userId:t,bookId:r,sectionId:n,messages:[],createdAt:s,updatedAt:s}},addMessageToConversation:(t,r,n)=>{a("AIService",`Adding ${r} message to conversation`,"info");const s=new Date().toISOString();return{...t,messages:[...t.messages,{role:r,content:n,timestamp:s}],updatedAt:s}},sendMessageToAI:async(t,r,n="",s=Vi.CHAT)=>{var o,c,d;try{a("AIService",`Sending message to AI (${s})`,"info",{userId:t.userId,bookId:t.bookId});const h=i.addMessageToConversation(t,"user",r),u=h.messages.filter(x=>x.role!=="system").map(x=>({role:x.role,content:x.content})),f=await A();try{a("AIService","Calling ask-ai Edge Function","info",{mode:s});const{data:x,error:k}=await f.functions.invoke("ask-ai",{body:{messages:u,context:n,bookId:t.bookId,sectionId:t.sectionId,userId:t.userId,mode:s}});if(k){a("AIService",`Error calling ask-ai Edge Function: ${k.message}`,"error",k);const b="I'm sorry, I encountered an error processing your request. Please try again later.";return{response:b,conversation:i.addMessageToConversation(h,"assistant",b)}}const v=(x==null?void 0:x.response)||"I'm sorry, I don't have a response for that.";a("AIService","Received response from ask-ai Edge Function","success",{responseLength:v.length});const E=i.addMessageToConversation(h,"assistant",v);return t.userId&&await Nt(t.userId,jt.AI_QUERY,{bookId:t.bookId,sectionId:t.sectionId,content:r,context:n?n.substring(0,500):void 0,response:v.substring(0,500),mode:s}).catch(b=>{a("AIService","Error logging AI query interaction","error",b)}),{response:v,conversation:E}}catch(x){a("AIService",`Error calling ask-ai Edge Function: ${x.message}`,"error",x);const v=((o=x.message)==null?void 0:o.includes("Failed to fetch"))||((c=x.message)==null?void 0:c.includes("Network error"))||((d=x.message)==null?void 0:d.includes("ECONNREFUSED"))?"I'm sorry, I'm having trouble connecting to my knowledge base. Please check your internet connection and try again.":"I'm sorry, I encountered an error processing your request. Please try again later.";return{response:v,conversation:i.addMessageToConversation(h,"assistant",v)}}}catch(h){a("AIService",`Error sending message to AI: ${h.message}`,"error",h);const u="I'm sorry, I encountered an error processing your request. Please try again later.";return{response:u,conversation:i.addMessageToConversation(t,"assistant",u)}}},getWordDefinition:async(t,r,n,s,o)=>{try{a("AIService",`Getting definition for "${t}"`,"info");const c=i.createConversation(n,s,o),{response:d}=await i.sendMessageToAI(c,`Define the word "${t}" in this context.`,r,Vi.DEFINITION);return d}catch(c){return a("AIService",`Error getting word definition: ${c.message}`,"error"),"I'm sorry, I couldn't find a definition for that word."}},getAIInteractionStats:async(t,r)=>{try{a("AIService","Getting AI interaction stats","info");const n=await A(),{data:s,error:o}=await n.from("ai_interactions").select("interaction_type, count",{count:"exact"}).eq("user_id",t).eq("book_id",r).group("interaction_type");if(o)return a("AIService",`Error getting AI stats: ${o.message}`,"error"),null;const{data:c,error:d}=await n.from("ai_interactions").select("*").eq("user_id",t).eq("book_id",r).order("created_at",{ascending:!1}).limit(5);return d?(a("AIService",`Error getting recent interactions: ${d.message}`,"error"),null):{stats:s||[],recentInteractions:c||[]}}catch(n){return a("AIService",`Error getting AI stats: ${n.message}`,"error"),null}},logHelpOffer:async(t,r,n,s)=>{try{a("AIService","Logging help offer","info");const o=await A(),{error:c}=await o.from("help_offers").insert({user_id:t,book_id:r,section_id:n,reason:s,created_at:new Date().toISOString()});return c?(a("AIService",`Error logging help offer: ${c.message}`,"error"),!1):(await Nt(t,jt.HELP_REQUEST,{bookId:r,sectionId:n,content:s}).catch(d=>{a("AIService","Error logging help request interaction","error",d)}),!0)}catch(o){return a("AIService",`Error logging help offer: ${o.message}`,"error"),!1}},checkIfUserNeedsHelp:async(t,r,n)=>{try{a("AIService","Checking if user needs help","info");const s=await A(),{data:o,error:c}=await s.from("ai_interactions").select("*").eq("user_id",t).eq("book_id",r).eq("section_id",n).order("created_at",{ascending:!1}).limit(5);if(c)return a("AIService",`Error getting AI interactions: ${c.message}`,"error"),{needsHelp:!1,reason:""};if(o&&o.length>=3){const u=o.slice(0,3);if(u.filter(x=>u.some(k=>k.id!==x.id&&k.query.toLowerCase().includes(x.query.toLowerCase().substring(0,5)))).length>=2)return{needsHelp:!0,reason:"You seem to be asking similar questions. Would you like to speak with a consultant for more help?"}}const d=["symbolism","theme","meaning","interpret","analysis"];return(o==null?void 0:o.some(u=>d.some(f=>u.query.toLowerCase().includes(f))))?{needsHelp:!0,reason:"You're asking about complex literary topics. Would you like to speak with a literature consultant?"}:{needsHelp:!1,reason:""}}catch(s){return a("AIService",`Error checking if user needs help: ${s.message}`,"error"),{needsHelp:!1,reason:""}}},logAIInteraction:async(t,r,n,s,o,c)=>{try{a("AIService","Logging AI interaction","info");const d=await A(),{error:h}=await d.from("ai_interactions").insert({user_id:t,book_id:r,section_id:n,query:s,response:o,interaction_type:c,created_at:new Date().toISOString()});return h?(a("AIService",`Error logging AI interaction: ${h.message}`,"error"),!1):!0}catch(d){return a("AIService",`Error logging AI interaction: ${d.message}`,"error"),!1}}};return i};P.register("aiService",async()=>{const i=await Eo();S.register("aiService",i)});async function Fn(i,t,r){return(await S.getOrInitialize("aiService",P)).createConversation(i,t,r)}async function Wn(i,t,r){return(await S.getOrInitialize("aiService",P)).addMessageToConversation(i,t,r)}async function qn(i,t,r,n){return(await S.getOrInitialize("aiService",P)).sendMessageToAI(i,t,r,n)}async function Gn(i,t,r,n,s){return(await S.getOrInitialize("aiService",P)).getWordDefinition(i,t,r,n,s)}async function Hn(i,t){return(await S.getOrInitialize("aiService",P)).getAIInteractionStats(i,t)}async function Yn(i,t,r,n){return(await S.getOrInitialize("aiService",P)).logHelpOffer(i,t,r,n)}async function Qn(i,t,r){return(await S.getOrInitialize("aiService",P)).checkIfUserNeedsHelp(i,t,r)}async function Kn(i,t,r,n,s,o){return(await S.getOrInitialize("aiService",P)).logAIInteraction(i,t,r,n,s,o)}const Co={createConversation:Fn,addMessageToConversation:Wn,sendMessageToAI:qn,getWordDefinition:Gn,getAIInteractionStats:Hn,logHelpOffer:Yn,checkIfUserNeedsHelp:Qn,logAIInteraction:Kn},Ao=Object.freeze(Object.defineProperty({__proto__:null,addMessageToConversation:Wn,checkIfUserNeedsHelp:Qn,createConversation:Fn,default:Co,getAIInteractionStats:Hn,getWordDefinition:Gn,logAIInteraction:Kn,logHelpOffer:Yn,sendMessageToAI:qn},Symbol.toStringTag,{value:"Module"})),Ro={defaultTTL:30*60*1e3,maxItems:100,useLocalStorage:!0,storageNamespace:"alice_reader_cache_"};class Wt{constructor(t={}){ae(this,"cache",new Map);ae(this,"config");ae(this,"accessOrder",[]);this.config={...Ro,...t},this.loadFromStorage()}set(t,r,n){const s=n||this.config.defaultTTL,o={value:r,timestamp:Date.now(),ttl:s,key:t};this.updateAccessOrder(t),this.cache.set(t,o),this.enforceMaxItems(),this.config.useLocalStorage&&this.saveToStorage(),a("CacheService",`Set cache item: ${t}`,"debug")}get(t){const r=this.cache.get(t);if(!r){a("CacheService",`Cache miss: ${t}`,"debug");return}if(this.isExpired(r)){a("CacheService",`Cache item expired: ${t}`,"debug"),this.remove(t);return}return this.updateAccessOrder(t),a("CacheService",`Cache hit: ${t}`,"debug"),r.value}remove(t){this.cache.delete(t),this.accessOrder=this.accessOrder.filter(r=>r!==t),this.config.useLocalStorage&&this.saveToStorage(),a("CacheService",`Removed cache item: ${t}`,"debug")}clear(){this.cache.clear(),this.accessOrder=[],this.config.useLocalStorage&&this.clearStorage(),a("CacheService","Cache cleared","debug")}has(t){const r=this.cache.get(t);return r?this.isExpired(r)?(this.remove(t),!1):!0:!1}keys(){return this.cleanExpired(),Array.from(this.cache.keys())}getStats(){this.cleanExpired();let t=Date.now(),r=0;return this.cache.forEach(n=>{n.timestamp<t&&(t=n.timestamp),n.timestamp>r&&(r=n.timestamp)}),{size:this.cache.size,maxSize:this.config.maxItems,oldestItem:t,newestItem:r}}isExpired(t){return Date.now()>t.timestamp+t.ttl}cleanExpired(){const t=Date.now();this.cache.forEach((r,n)=>{t>r.timestamp+r.ttl&&this.remove(n)})}updateAccessOrder(t){this.accessOrder=this.accessOrder.filter(r=>r!==t),this.accessOrder.push(t)}enforceMaxItems(){if(!(this.cache.size<=this.config.maxItems))for(;this.cache.size>this.config.maxItems&&this.accessOrder.length>0;){const t=this.accessOrder[0];this.remove(t),this.accessOrder.shift()}}saveToStorage(){if(!(typeof window>"u"||!window.localStorage))try{this.cleanExpired();const t=Array.from(this.cache.entries());localStorage.setItem(`${this.config.storageNamespace}data`,JSON.stringify(t)),localStorage.setItem(`${this.config.storageNamespace}order`,JSON.stringify(this.accessOrder)),a("CacheService","Cache saved to localStorage","debug")}catch(t){a("CacheService","Error saving cache to localStorage","error",t)}}loadFromStorage(){if(!(typeof window>"u"||!window.localStorage))try{const t=localStorage.getItem(`${this.config.storageNamespace}data`);if(t){const n=JSON.parse(t);this.cache=new Map(n)}const r=localStorage.getItem(`${this.config.storageNamespace}order`);r&&(this.accessOrder=JSON.parse(r)),this.cleanExpired(),a("CacheService","Cache loaded from localStorage","debug")}catch(t){a("CacheService","Error loading cache from localStorage","error",t),this.cache=new Map,this.accessOrder=[]}}clearStorage(){if(!(typeof window>"u"||!window.localStorage))try{localStorage.removeItem(`${this.config.storageNamespace}data`),localStorage.removeItem(`${this.config.storageNamespace}order`),a("CacheService","Cache cleared from localStorage","debug")}catch(t){a("CacheService","Error clearing cache from localStorage","error",t)}}}new Wt({defaultTTL:60*60*1e3,storageNamespace:"alice_reader_book_"});new Wt({defaultTTL:30*60*1e3,storageNamespace:"alice_reader_section_"});const Ld=new Wt({defaultTTL:24*60*60*1e3,storageNamespace:"alice_reader_dict_"});new Wt({defaultTTL:5*60*1e3,storageNamespace:"alice_reader_progress_"});new Wt({defaultTTL:5*60*1e3,storageNamespace:"alice_reader_stats_"});var Zn=(i=>(i.PENDING="PENDING",i.IN_PROGRESS="IN_PROGRESS",i.RESOLVED="RESOLVED",i))(Zn||{});function To(i){return typeof i=="string"&&i.trim().length>0}function Po(i){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(i)}function $o(i,t){const r=Po(i);return!r&&t&&a("IdValidation",`Invalid ${t} UUID: ${i}`,"warning"),r}function Oo(i){return $o(i.toString(),"user")}function Do(i){const t=i.toString(),r=To(t);return r||a("IdValidation",`Invalid book ID: ${t}`,"warning"),r}class zo{constructor(t){this.sessionCache=new Map,this.mockData=new Map,this.config={mockEnabled:!1,cacheEnabled:!0,cacheDuration:5*60*1e3,debug:!1,...t},this.client=un(t.supabaseUrl,t.supabaseKey),this.initializeMockData()}log(t,r){this.config.debug&&console.log(`[SupabaseMCP] ${t}`,r||"")}initializeMockData(){this.mockData.set("mockUser",{id:"mock-user-id",email:"mock@example.com",user_metadata:{first_name:"Mock",last_name:"User"}})}getCachedSession(t){if(!this.config.cacheEnabled)return null;const r=this.sessionCache.get(t);return r?Date.now()-r.timestamp>(this.config.cacheDuration||0)?(this.sessionCache.delete(t),null):r.session:null}setCachedSession(t,r){this.config.cacheEnabled&&this.sessionCache.set(t,{session:r,timestamp:Date.now()})}async getSession(){try{if(this.config.mockEnabled)return this.log("Returning mock session"),{data:{session:null},error:null};const t=this.getCachedSession("current");if(t)return this.log("Returning cached session"),{data:{session:t},error:null};const{data:r,error:n}=await this.client.auth.getSession();return!n&&r.session&&this.setCachedSession("current",r.session),{data:r,error:n}}catch(t){return this.log("Error getting session",t),{data:{session:null},error:t instanceof Error?t:new Error("Unknown error")}}}async signIn(t,r){try{if(this.config.mockEnabled)return{data:{user:this.mockData.get("mockUser")},error:null};const{data:n,error:s}=await this.client.auth.signInWithPassword({email:t,password:r});return!s&&n.session&&this.setCachedSession("current",n.session),{data:{user:n.user},error:s}}catch(n){return{data:{user:null},error:n instanceof Error?n:new Error("Unknown error")}}}async signUp(t,r){try{if(this.config.mockEnabled)return{data:{user:this.mockData.get("mockUser")},error:null};const{data:n,error:s}=await this.client.auth.signUp({email:t,password:r});return!s&&n.session&&this.setCachedSession("current",n.session),{data:{user:n.user},error:s}}catch(n){return{data:{user:null},error:n instanceof Error?n:new Error("Unknown error")}}}async signOut(){try{if(this.config.mockEnabled)return this.sessionCache.clear(),{error:null};const{error:t}=await this.client.auth.signOut();return this.sessionCache.clear(),{error:t}}catch(t){return{error:t instanceof Error?t:new Error("Unknown error")}}}onAuthStateChange(t){return this.config.mockEnabled?{data:{subscription:{unsubscribe:()=>{}}},error:null}:this.client.auth.onAuthStateChange((r,n)=>{n?this.setCachedSession("current",n):this.sessionCache.clear(),t(r,n)})}setMockEnabled(t){this.config.mockEnabled=t,this.log(`Mock mode ${t?"enabled":"disabled"}`)}setCacheEnabled(t){this.config.cacheEnabled=t,this.log(`Cache ${t?"enabled":"disabled"}`)}getConfig(){return{mockEnabled:this.config.mockEnabled,cacheEnabled:this.config.cacheEnabled,cacheDuration:this.config.cacheDuration,debug:this.config.debug}}setMockData(t,r){this.mockData.set(t,r),this.log(`Mock data updated for key: ${t}`)}clearCache(){this.sessionCache.clear(),this.log("Cache cleared")}}const Mo={supabaseUrl:"https://blwypdcobizmpidmuhvq.supabase.co",supabaseKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsd3lwZGNvYml6bXBpZG11aHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMDgzNDcsImV4cCI6MjA1OTc4NDM0N30.YP2r-CnSaM4rKclXBivanAMBQh9sMsI95F2p87zIuWM",mockEnabled:!1,cacheEnabled:!0,cacheDuration:5*60*1e3,debug:!1},qt=new zo(Mo);async function at(){return await dn()?(a("BackendService","Using real backend","info"),!0):(a("BackendService","Using mock backend (connection unavailable)","warning"),!1)}const Lo=async(i,t)=>qt.signIn(i,t),Bo=async(i,t)=>qt.signUp(i,t),Uo=async()=>qt.signOut(),No=async()=>qt.getSession(),Vo=async i=>qt.onAuthStateChange(i);async function yr(i){if(a("BackendService",`Getting user profile for ${i}`,"info"),await at())try{return await ln(async()=>{const t=await A(),{data:r,error:n}=await t.from("profiles").select("*").eq("id",i).single();if(n)throw a("BackendService",`Error fetching profile for user ${i}:`,"error",n.message),n;return a("BackendService",`Profile fetched successfully for user ${i}`,"success"),{data:r,error:null}},"getUserProfile")}catch(t){return a("BackendService","Get user profile failed after retries, falling back to mock","error",t),Z.profiles.getUserProfile(i)}else return Z.profiles.getUserProfile(i)}async function Fo(i,t,r,n){if(await at())try{return await ln(async()=>{const s=await A(),{data:o,error:c}=await s.from("profiles").insert({id:i,first_name:t,last_name:r,email:n}).select().single();if(c)throw c;return{data:o,error:null}},"createUserProfile")}catch(s){return a("BackendService","Create user profile failed after retries, falling back to mock","error",s),Z.profiles.createUserProfile(i,t,r,n)}else return Z.profiles.createUserProfile(i,t,r,n)}async function Bd(i,t,r,n){try{a("BackendService","Getting definition","info",{bookId:i,term:t,sectionId:r,chapterId:n});const s=t.replace(/[.,!?;:'"\/\\()\[\]{}]/g,"").trim().toLowerCase();if(await at()){const o=await A(),c=i,{data:d,error:h}=await o.rpc("get_definition_with_context",{book_id_param:c,term_param:s,section_id_param:r||null,chapter_id_param:n||null});if(h)return a("BackendService","Error getting definition from database","error",h),{data:null,error:h};if(d&&d.length>0){const u=d.sort((x,k)=>x.priority-k.priority),f=u[0].definition;return a("BackendService","Found definition in database","success",{term:s,priority:u[0].priority,definitionLength:f.length}),{data:f,error:null}}return a("BackendService","No definition found in database","info",{term:s}),{data:null,error:null}}else return a("BackendService","Using mock backend for definition","info"),Z.books.getDefinition(i,s,r,n)}catch(s){return a("BackendService","Error in getDefinition","error",s),{data:null,error:s}}}async function Wo(i,t,r,n){a("BackendService","Performing comprehensive book verification","info",{code:i,userId:t,firstName:r,lastName:n}),console.log("verifyBookCodeComprehensive: Starting verification with:",{code:i,userId:t,firstName:r,lastName:n});const s=Date.now();if(await at())try{const o=await A(),c=await Ha(i,t,r,n),d=Date.now()-s;return console.log(`verifyBookCodeComprehensive: Verification completed in ${d}ms, result:`,c),c.success?(a("BackendService","Verification successful","success"),console.log("verifyBookCodeComprehensive: Verification successful"),setTimeout(async()=>{try{const{data:h}=await o.from("profiles").select("first_name, last_name, book_verified").eq("id",t).single();console.log("verifyBookCodeComprehensive: Post-verification profile check:",h),h!=null&&h.book_verified||console.warn("verifyBookCodeComprehensive: Profile book_verified is still false!")}catch(h){console.error("verifyBookCodeComprehensive: Error checking profile after verification:",h)}},500)):(a("BackendService","Verification failed","error",c.error),console.error("verifyBookCodeComprehensive: Verification failed with error:",c.error)),c}catch(o){const c=Date.now()-s;return a("BackendService",`Error in comprehensive verification (after ${c}ms)`,"error",o),console.error(`verifyBookCodeComprehensive: Error in verification after ${c}ms:`,o),{success:!1,error:o}}else try{a("BackendService","Using mock implementation for comprehensive verification","info"),console.log("Mock verifyBookCodeComprehensive: Starting with code:",i,"userId:",t);const{data:o,error:c}=await Z.books.verifyBookCode(i);if(c||!o)return console.error("Mock verification failed: Invalid code"),{success:!1,error:c||"Invalid verification code"};if(o.is_used)return console.error("Mock verification failed: Code already used"),{success:!1,error:"This code has already been used"};const{error:d}=await Z.books.markCodeAsUsed(i,t);if(d)return console.error("Mock verification failed: Error marking code as used"),{success:!1,error:d};const h={book_verified:!0};r&&(h.first_name=r),n&&(h.last_name=n),console.log("Mock verification: Updating profile with:",h);const{data:u}=await Z.profiles.getUserProfile(t);u||(console.log("Mock verification: Profile does not exist, creating new profile"),await Z.profiles.createUserProfile(t,r||"User",n||"Name","user@example.com"));const{data:f,error:x}=await Z.profiles.updateUserProfile(t,h);return x?(console.error("Mock verification failed: Error updating profile",x),{success:!1,error:x}):(console.log("Mock verification successful! Updated profile:",f),{success:!0,data:o})}catch(o){return console.error("Mock verification failed with exception:",o),a("BackendService","Error in mock comprehensive verification","error",o),{success:!1,error:o}}}async function qo(i,t){if(a("BackendService","Getting reading progress","info",{userId:i,bookId:t}),!Oo(i)||!Do(t))return a("BackendService","Invalid IDs for getting reading progress","error",{userId:i,bookId:t}),{data:null,error:new Error("Invalid IDs for getting reading progress")};if(await at())try{const r=await A(),n=t.toString();a("BackendService",`Using book UUID: ${n}`,"debug");const{data:s,error:o}=await r.from("reading_progress").select("section_id, last_position, last_read_at").eq("user_id",i).eq("book_id",n).maybeSingle();if(o)throw a("BackendService","Error fetching reading progress","error",o),o;if(!s)return a("BackendService","No reading progress found","info"),{data:null,error:null};a("BackendService","Reading progress found","success",{sectionId:s.section_id}),a("BackendService","Fetching section and chapter details","info");const{data:c,error:d}=await r.from("sections").select("title, start_page, chapters!inner(title, number)").eq("id",s.section_id).single();if(d)throw a("BackendService","Error fetching section details","error",d),d;a("BackendService","Section details found","success",{title:c.title});const h=c.chapters,u={section_id:s.section_id,last_position:s.last_position,section_title:c.title,chapter_title:h.title,page_number:c.start_page};return a("BackendService","Reading progress assembled successfully","success"),{data:u,error:null}}catch(r){return a("BackendService","Error in getReadingProgress","error",r),{data:null,error:r}}else return a("BackendService","Using mock backend for getReadingProgress","info"),Z.progress.getReadingProgress(i,t)}async function Go(i,t){if(a("BackendService","Getting reading stats","info",{userId:i,bookId:t}),await at())try{const r=t;a("BackendService",`Using book UUID: ${r}`,"debug");const{data:n,error:s}=await client.from("reading_stats").select("*").eq("user_id",i).eq("book_id",r).maybeSingle();if(s)throw a("BackendService","Error fetching reading stats","error",s),s;if(!n)return a("BackendService","No reading stats found","info"),{data:null,error:null};if(a("BackendService","Reading stats found","success",{timeSpent:n.total_reading_time,pagesRead:n.pages_read}),n.percentage_complete!==void 0)return a("BackendService","Using existing percentage_complete value","debug",{percentage:n.percentage_complete}),{data:n,error:null};a("BackendService","Fetching book data to calculate percentage","info");const{data:o,error:c}=await client.from("books").select("total_pages").eq("id",r).single();if(c)throw a("BackendService","Error fetching book data","error",c),c;a("BackendService","Book data found","success",{totalPages:o.total_pages});const d=Math.min(100,Math.round(n.pages_read/o.total_pages*100)),h={...n,percentage_complete:d};return a("BackendService","Reading stats assembled successfully","success",{percentageComplete:d}),{data:h,error:null}}catch(r){return a("BackendService","Error in getReadingStats","error",r),{data:null,error:r}}else return a("BackendService","Using mock backend for getReadingStats","info"),Z.progress.getReadingStats(i,t)}async function Ud(i,t,r,n,s,o){if(await at()){const c=await A(),{data:d,error:h}=await c.from("ai_interactions").insert({user_id:i,book_id:t,section_id:s||null,question:r,context:o||null,response:n}).select().single();return{data:d,error:h}}else return Z.ai.saveAiInteraction(i,t,r,n,s,o)}async function Ho(i,t,r,n,s){if(await at()){const o=await A(),{data:c,error:d}=await o.from("help_requests").insert({user_id:i,book_id:t,section_id:n||null,status:Zn.PENDING,content:r,context:s||null}).select().single();return{data:c,error:d}}else return Z.consultant.submitHelpRequest(i,t,r,n,s)}const Yo="https://blwypdcobizmpidmuhvq.supabase.co",Qo="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsd3lwZGNvYml6bXBpZG11aHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyMDgzNDcsImV4cCI6MjA1OTc4NDM0N30.YP2r-CnSaM4rKclXBivanAMBQh9sMsI95F2p87zIuWM",Mt=un(Yo,Qo);class Ko{constructor(){ae(this,"termsCache",null);ae(this,"termsDataCache",null);ae(this,"lastFetchTime",0);ae(this,"CACHE_DURATION",5*60*1e3)}async getAllGlossaryTerms(){if(this.termsCache&&Date.now()-this.lastFetchTime<this.CACHE_DURATION)return a("GlossaryService","Returning cached glossary terms","debug",{count:this.termsCache.size}),this.termsCache;try{a("GlossaryService","Fetching glossary terms from Supabase","info");const{data:t,error:r,count:n}=await Mt.from("alice_glossary").select("term").order("term");if(r)throw a("GlossaryService","Error fetching glossary terms","error",r),new Error(`Failed to fetch glossary terms: ${r.message}`);const s=new Set;return t&&t.length>0&&t.forEach(o=>{const c=o.term;if(c&&(s.add(c),s.add(c.toLowerCase()),s.add(c.charAt(0).toUpperCase()+c.slice(1)),c.includes(" "))){const d=c.split(" ").map(h=>h.charAt(0).toUpperCase()+h.slice(1)).join(" ");s.add(d)}}),this.termsCache=s,this.lastFetchTime=Date.now(),a("GlossaryService",`Successfully loaded ${s.size} glossary terms`,"success",{originalCount:(t==null?void 0:t.length)||0,totalVariations:s.size}),s}catch(t){return a("GlossaryService","Failed to fetch glossary terms","error",t),new Set}}async getGlossaryTerms(){if(this.termsDataCache&&Date.now()-this.lastFetchTime<this.CACHE_DURATION)return this.termsDataCache;try{a("GlossaryService","Fetching full glossary data from Supabase","info");const{data:t,error:r}=await Mt.from("alice_glossary").select("*").order("term");if(r)throw a("GlossaryService","Error fetching glossary data","error",r),new Error(`Failed to fetch glossary data: ${r.message}`);return this.termsDataCache=t||[],this.lastFetchTime=Date.now(),a("GlossaryService",`Successfully loaded ${(t==null?void 0:t.length)||0} glossary entries`,"success"),t||[]}catch(t){return a("GlossaryService","Failed to fetch glossary data","error",t),[]}}async getGlossaryDefinition(t){try{const{data:r,error:n}=await Mt.from("alice_glossary").select("*").or(`term.eq.${t},term.eq.${t.toLowerCase()},term.eq.${t.charAt(0).toUpperCase()+t.slice(1)}`).single();if(n){if(n.code==="PGRST116")return null;throw a("GlossaryService","Error fetching glossary definition","error",n),new Error(`Failed to fetch glossary definition: ${n.message}`)}return r}catch(r){return a("GlossaryService","Failed to fetch glossary definition","error",r),null}}async searchGlossaryTerms(t,r=10){try{const{data:n,error:s}=await Mt.from("alice_glossary").select("*").or(`term.ilike.%${t}%,definition.ilike.%${t}%`).order("term").limit(r);if(s)throw a("GlossaryService","Error searching glossary terms","error",s),new Error(`Failed to search glossary terms: ${s.message}`);return n||[]}catch(n){return a("GlossaryService","Failed to search glossary terms","error",n),[]}}async getTermCount(){try{const{count:t,error:r}=await Mt.from("alice_glossary").select("*",{count:"exact",head:!0});if(r)throw a("GlossaryService","Error getting term count","error",r),new Error(`Failed to get term count: ${r.message}`);return t||0}catch(t){return a("GlossaryService","Failed to get term count","error",t),0}}clearCache(){this.termsCache=null,this.termsDataCache=null,this.lastFetchTime=0,a("GlossaryService","Cache cleared","info")}}const Gr=new Ko,Jn=()=>Gr.getAllGlossaryTerms(),Nd=i=>Gr.getGlossaryDefinition(i),Zo=()=>Gr.getTermCount();console.log("Loading feedbackService module");var Xn=(i=>(i.AHA_MOMENT="AHA_MOMENT",i.POSITIVE_EXPERIENCE="POSITIVE_EXPERIENCE",i.SUGGESTION="SUGGESTION",i.CONFUSION="CONFUSION",i.GENERAL="GENERAL",i))(Xn||{});const Jo=async()=>(a("FeedbackService","Creating feedback service","info"),console.log("Creating feedback service"),{getUserFeedback:async(t,r)=>{try{a("FeedbackService","Getting user feedback","info");const n=await A(),{data:s,error:o}=await n.from("user_feedback").select("*").eq("user_id",t).eq("book_id",r).order("created_at",{ascending:!1});return o?(a("FeedbackService",`Error getting user feedback: ${o.message}`,"error"),[]):s||[]}catch(n){return a("FeedbackService",`Error getting user feedback: ${n.message}`,"error"),[]}},submitFeedback:async(t,r,n,s,o,c=!1)=>{try{a("FeedbackService","Submitting feedback","info",{feedbackType:n,hasSection:!!o,isPublic:c});const d=await A(),{data:h,error:u}=await d.from("user_feedback").insert({user_id:t,book_id:r,section_id:o||null,feedback_type:n,content:s,is_public:c,is_featured:!1,created_at:new Date().toISOString()}).select().single();if(u)return a("FeedbackService",`Error submitting feedback: ${u.message}`,"error",u),{error:u};try{await d.from("ai_interactions").insert({user_id:t,book_id:r,section_id:o||null,question:`Feedback: ${n}`,response:"Feedback submitted successfully",interaction_type:"FEEDBACK",created_at:new Date().toISOString()})}catch(f){a("FeedbackService","Warning: Failed to log feedback interaction","warning",f)}try{await Nt(t,jt.FEEDBACK_SUBMISSION,{bookId:r,sectionId:o||void 0,content:s,feedbackType:n,isPublic:c})}catch(f){a("FeedbackService","Warning: Failed to log feedback to interactions table","warning",f)}return a("FeedbackService","Feedback submitted successfully","success",{id:h==null?void 0:h.id}),{data:h}}catch(d){return a("FeedbackService",`Error submitting feedback: ${d.message}`,"error",d),{error:d}}},updateFeedbackVisibility:async(t,r,n)=>{try{a("FeedbackService","Updating feedback visibility","info");const s=await A(),{error:o}=await s.from("user_feedback").update({is_public:r,is_featured:n}).eq("id",t);return o?(a("FeedbackService",`Error updating feedback visibility: ${o.message}`,"error"),!1):(a("FeedbackService","Feedback visibility updated successfully","success"),!0)}catch(s){return a("FeedbackService",`Error updating feedback visibility: ${s.message}`,"error"),!1}},logFeedbackInteraction:async(t,r,n,s)=>{try{a("FeedbackService",`Logging feedback interaction: ${n}`,"info");const o=await A(),{error:c}=await o.from("ai_interactions").insert({user_id:t,book_id:r,question:`Feedback interaction: ${n}`,response:"Interaction logged",interaction_type:"FEEDBACK",metadata:s||{},created_at:new Date().toISOString()});return c?(a("FeedbackService",`Error logging feedback interaction: ${c.message}`,"error",c),!1):!0}catch(o){return a("FeedbackService",`Error logging feedback interaction: ${o.message}`,"error",o),!1}}});console.log("Registering initialization function for feedbackService");P.register("feedbackService",async()=>{console.log("Creating feedback service for registration");const i=await Jo();console.log("Registering feedback service in registry"),S.register("feedbackService",i),console.log("Feedback service registered successfully")},[]);const or=i=>async(...t)=>(S.has("feedbackService")||await P.initializeService("feedbackService"),S.get("feedbackService")[i](...t)),es=or("getUserFeedback"),ts=or("submitFeedback"),rs=or("updateFeedbackVisibility"),is=or("logFeedbackInteraction"),Xo={getUserFeedback:es,submitFeedback:ts,updateFeedbackVisibility:rs,logFeedbackInteraction:is};console.log("feedbackService module loaded");const ec=Object.freeze(Object.defineProperty({__proto__:null,FeedbackType:Xn,default:Xo,getUserFeedback:es,logFeedbackInteraction:is,submitFeedback:ts,updateFeedbackVisibility:rs},Symbol.toStringTag,{value:"Module"}));console.log("Loading triggerService module");var ns=(i=>(i.ENGAGEMENT="ENGAGEMENT",i.CHECK_IN="CHECK_IN",i.QUIZ="QUIZ",i.ENCOURAGE="ENCOURAGE",i))(ns||{});const tc=async()=>(a("TriggerService","Creating trigger service","info"),console.log("Creating trigger service"),{getTriggers:async(t,r)=>{try{a("TriggerService","Getting triggers","info");const n=await A(),{data:s,error:o}=await n.from("consultant_triggers").select("*").eq("user_id",t).eq("book_id",r).eq("is_processed",!1).order("created_at",{ascending:!1});return o?(a("TriggerService",`Error getting triggers: ${o.message}`,"error"),[]):s||[]}catch(n){return a("TriggerService",`Error getting triggers: ${n.message}`,"error"),[]}},createTrigger:async(t,r,n,s,o)=>{try{a("TriggerService","Creating trigger","info");const c=await A(),{error:d}=await c.from("consultant_triggers").insert({user_id:t,book_id:r,section_id:n,trigger_type:s,content:o,is_processed:!1,created_at:new Date().toISOString()});return d?(a("TriggerService",`Error creating trigger: ${d.message}`,"error"),!1):(a("TriggerService","Trigger created successfully","success"),!0)}catch(c){return a("TriggerService",`Error creating trigger: ${c.message}`,"error"),!1}},markTriggerProcessed:async t=>{try{a("TriggerService",`Marking trigger ${t} as processed`,"info");const r=await A(),{error:n}=await r.from("consultant_triggers").update({is_processed:!0,processed_at:new Date().toISOString()}).eq("id",t);return n?(a("TriggerService",`Error marking trigger as processed: ${n.message}`,"error"),!1):(a("TriggerService","Trigger marked as processed successfully","success"),!0)}catch(r){return a("TriggerService",`Error marking trigger as processed: ${r.message}`,"error"),!1}},subscribeToTriggers:async(t,r,n)=>{try{a("TriggerService","Subscribing to triggers","info");const s=await A(),o=s.channel("consultant_triggers_channel").on("postgres_changes",{event:"INSERT",schema:"public",table:"consultant_triggers",filter:`user_id=eq.${t} AND book_id=eq.${r} AND is_processed=eq.false`},c=>{a("TriggerService","New trigger received","info"),n(c.new)}).subscribe();return()=>{a("TriggerService","Unsubscribing from triggers","info"),s.removeChannel(o)}}catch(s){return a("TriggerService",`Error subscribing to triggers: ${s.message}`,"error"),()=>{}}}});console.log("Registering initialization function for triggerService");P.register(G.TRIGGER_SERVICE,async()=>{console.log("Creating trigger service for registration");const i=await tc();console.log("Registering trigger service in registry"),S.register(G.TRIGGER_SERVICE,i),console.log("Trigger service registered successfully")},[]);const cr=i=>async(...t)=>(S.has(G.TRIGGER_SERVICE)||await P.initializeService(G.TRIGGER_SERVICE),S.get(G.TRIGGER_SERVICE)[i](...t)),ss=cr("getTriggers"),as=cr("createTrigger"),os=cr("markTriggerProcessed"),cs=cr("subscribeToTriggers"),rc={getTriggers:ss,createTrigger:as,markTriggerProcessed:os,subscribeToTriggers:cs};console.log("triggerService module loaded");const ic=Object.freeze(Object.defineProperty({__proto__:null,TriggerType:ns,createTrigger:as,default:rc,getTriggers:ss,markTriggerProcessed:os,subscribeToTriggers:cs},Symbol.toStringTag,{value:"Module"})),oe="StatisticsService",nc=async()=>(a(oe,"Creating statistics service","info"),{getBasicReadingStats:async(t,r)=>{try{a(oe,`Getting basic reading stats for user ${t}`,"info");const n=await A(),{data:s,error:o}=await n.from("reading_stats").select("*").eq("user_id",t).eq("book_id",r).single();return o&&o.code!=="PGRST116"?(a(oe,`Error getting reading stats: ${o.message}`,"error"),null):s||null}catch(n){throw te(n,"statisticsService","getBasicReadingStats")}},getDetailedReadingStats:async(t,r)=>{try{a(oe,`Getting detailed reading stats for user ${t}`,"info");const n=await A(),{data:s,error:o}=await n.from("reading_stats").select("*").eq("user_id",t).eq("book_id",r).single();if(o&&o.code!=="PGRST116")return a(oe,`Error getting reading stats: ${o.message}`,"error"),null;if(!s)return null;const{count:c,error:d}=await n.from("ai_interactions").select("*",{count:"exact",head:!0}).eq("user_id",t).eq("book_id",r);d&&a(oe,`Error getting AI interactions count: ${d.message}`,"warning");const{count:h,error:u}=await n.from("ai_interactions").select("*",{count:"exact",head:!0}).eq("user_id",t).eq("book_id",r).eq("interaction_type","definition");u&&a(oe,`Error getting word lookups count: ${u.message}`,"warning");const{count:f,error:x}=await n.from("help_requests").select("*",{count:"exact",head:!0}).eq("user_id",t).eq("book_id",r);x&&a(oe,`Error getting help requests count: ${x.message}`,"warning");const{count:k,error:v}=await n.from("user_feedback").select("*",{count:"exact",head:!0}).eq("user_id",t).eq("book_id",r);return v&&a(oe,`Error getting feedback count: ${v.message}`,"warning"),{...s,reading_streak:1,words_looked_up:h||0,ai_interactions:c||0,help_requests:f||0,feedback_submitted:k||0}}catch(n){throw te(n,"statisticsService","getDetailedReadingStats")}},updateReadingTime:async(t,r,n)=>{try{a(oe,`Updating reading time for user ${t}`,"info");const s=await A(),{data:o,error:c}=await s.from("reading_stats").select("id, total_reading_time").eq("user_id",t).eq("book_id",r).single();if(c&&c.code!=="PGRST116")return a(oe,`Error checking reading stats: ${c.message}`,"error"),!1;if(o){const{error:d}=await s.from("reading_stats").update({total_reading_time:o.total_reading_time+n,last_session_date:new Date().toISOString()}).eq("id",o.id);if(d)return a(oe,`Error updating reading time: ${d.message}`,"error"),!1}else{const{error:d}=await s.from("reading_stats").insert({user_id:t,book_id:r,total_reading_time:n,pages_read:0,percentage_complete:0,last_session_date:new Date().toISOString()});if(d)return a(oe,`Error creating reading stats: ${d.message}`,"error"),!1}return!0}catch(s){throw te(s,"statisticsService","updateReadingTime")}},getReaderLeaderboard:async(t,r=10)=>{try{a(oe,`Getting reader leaderboard for book ${t}`,"info");const n=await A(),{data:s,error:o}=await n.from("reading_stats").select("*, user:user_id(username, display_name)").eq("book_id",t).order("percentage_complete",{ascending:!1}).limit(r);return o?(a(oe,`Error getting reader leaderboard: ${o.message}`,"error"),[]):s||[]}catch(n){throw te(n,"statisticsService","getReaderLeaderboard")}},updateReadingStats:async(t,r,n,s=100)=>{try{a(oe,`Updating reading stats for user ${t}`,"info");const o=await A(),{data:c,error:d}=await o.from("reading_stats").select("id, pages_read").eq("user_id",t).eq("book_id",r).single();if(d&&d.code!=="PGRST116")return a(oe,`Error checking reading stats: ${d.message}`,"error"),!1;const h=typeof n=="string"?parseInt(n):n,u=Math.min(h/s,1),f=new Date().toISOString();if(c){const{error:x}=await o.from("reading_stats").update({pages_read:Math.max(c.pages_read,h),percentage_complete:u,last_session_date:f}).eq("id",c.id);if(x)return a(oe,`Error updating reading stats: ${x.message}`,"error"),!1}else{const{error:x}=await o.from("reading_stats").insert({user_id:t,book_id:r,total_reading_time:0,pages_read:h,percentage_complete:u,last_session_date:f});if(x)return a(oe,`Error creating reading stats: ${x.message}`,"error"),!1}return!0}catch(o){throw te(o,"statisticsService","updateReadingStats")}}});P.register("statisticsService",async()=>{const i=await nc();S.register("statisticsService",i)});async function ls(i,t){return(await S.getOrInitialize("statisticsService",P)).getBasicReadingStats(i,t)}async function ds(i,t){return(await S.getOrInitialize("statisticsService",P)).getDetailedReadingStats(i,t)}async function us(i,t,r){return(await S.getOrInitialize("statisticsService",P)).updateReadingTime(i,t,r)}async function gs(i,t=10){return(await S.getOrInitialize("statisticsService",P)).getReaderLeaderboard(i,t)}async function hs(i,t,r,n=100){return(await S.getOrInitialize("statisticsService",P)).updateReadingStats(i,t,r,n)}const sc={getBasicReadingStats:ls,getDetailedReadingStats:ds,updateReadingTime:us,getReaderLeaderboard:gs,updateReadingStats:hs},ac=Object.freeze(Object.defineProperty({__proto__:null,default:sc,getBasicReadingStats:ls,getDetailedReadingStats:ds,getReaderLeaderboard:gs,updateReadingStats:hs,updateReadingTime:us},Symbol.toStringTag,{value:"Module"})),it="alice-in-wonderland";new Date().toISOString(),new Date().toISOString(),new Date().toISOString(),new Date().toISOString(),new Date().toISOString(),new Date().toISOString(),new Date().toISOString(),new Date().toISOString(),new Date().toISOString(),new Date().toISOString(),new Date().toISOString();const oc=async()=>(a("InteractionService","Creating interaction service","info"),{logPageView:async(t,r,n)=>{try{a("InteractionService",`Logging page view for user ${t}, book ${r}, page ${n}`,"info");const s=await A(),{error:o}=await s.from("user_interactions").insert({user_id:t,book_id:r,interaction_type:"page_view",page_number:n,created_at:new Date().toISOString()});if(o)throw o}catch(s){throw te(s,"interactionService","logPageView")}},logDictionaryLookup:async(t,r,n,s,o)=>{try{a("InteractionService",`Logging dictionary lookup for user ${t}, term ${s}`,"info");const c=await A(),{error:d}=await c.from("user_interactions").insert({user_id:t,book_id:r,section_id:n,interaction_type:"dictionary_lookup",content:s,metadata:{definitionFound:o},created_at:new Date().toISOString()});if(d)throw d}catch(c){throw te(c,"interactionService","logDictionaryLookup")}},logAiInteraction:async(t,r,n,s,o)=>{try{a("InteractionService",`Logging AI interaction for user ${t}`,"info");const c=await A(),{error:d}=await c.from("user_interactions").insert({user_id:t,book_id:r,section_id:n,interaction_type:"ai_interaction",content:s,metadata:{response:o},created_at:new Date().toISOString()});if(d)throw d}catch(c){throw te(c,"interactionService","logAiInteraction")}},logHighlight:async(t,r,n,s)=>{try{a("InteractionService",`Logging highlight for user ${t}`,"info");const o=await A(),{error:c}=await o.from("user_interactions").insert({user_id:t,book_id:r,section_id:n,interaction_type:"highlight",content:s,created_at:new Date().toISOString()});if(c)throw c}catch(o){throw te(o,"interactionService","logHighlight")}},getUserInteractions:async(t,r=it,n=100)=>{try{a("InteractionService",`Getting interactions for user ${t}, book ${r}`,"info");let o=(await A()).from("user_interactions").select("*").eq("user_id",t).order("created_at",{ascending:!1}).limit(n);r&&(o=o.eq("book_id",r));const{data:c,error:d}=await o;if(d)throw d;return c||[]}catch(s){throw te(s,"interactionService","getUserInteractions")}},getInteractionStats:async(t,r=it)=>{try{a("InteractionService",`Getting interaction stats for user ${t}, book ${r}`,"info");const n=await A(),{data:s,error:o}=await n.from("user_interactions").select("interaction_type").eq("user_id",t).eq("book_id",r);if(o)throw o;const c={total:0,page_views:0,dictionary_lookups:0,ai_interactions:0,highlights:0};return s&&(c.total=s.length,s.forEach(d=>{switch(d.interaction_type){case"page_view":c.page_views++;break;case"dictionary_lookup":c.dictionary_lookups++;break;case"ai_interaction":c.ai_interactions++;break;case"highlight":c.highlights++;break}})),c}catch(n){throw te(n,"interactionService","getInteractionStats")}}});P.register("interactionService",async()=>{const i=await oc();S.register("interactionService",i)});const fs=async(i,t,r)=>(await S.getOrInitialize("interactionService",P)).logPageView(i,t,r),ps=async(i,t,r,n,s)=>(await S.getOrInitialize("interactionService",P)).logDictionaryLookup(i,t,r,n,s),xs=async(i,t,r,n,s)=>(await S.getOrInitialize("interactionService",P)).logAiInteraction(i,t,r,n,s),ms=async(i,t,r,n)=>(await S.getOrInitialize("interactionService",P)).logHighlight(i,t,r,n),vs=async(i,t,r)=>(await S.getOrInitialize("interactionService",P)).getUserInteractions(i,t,r),ys=async(i,t)=>(await S.getOrInitialize("interactionService",P)).getInteractionStats(i,t),cc={logPageView:fs,logDictionaryLookup:ps,logAiInteraction:xs,logHighlight:ms,getUserInteractions:vs,getInteractionStats:ys},lc=Object.freeze(Object.defineProperty({__proto__:null,default:cc,getInteractionStats:ys,getUserInteractions:vs,logAiInteraction:xs,logDictionaryLookup:ps,logHighlight:ms,logPageView:fs},Symbol.toStringTag,{value:"Module"})),dc=async()=>{a("MonitoringService","Creating monitoring service","info");const i={};return{logEvent:(r,n,s,o)=>{try{console.log(`[EVENT] ${r} - ${n}${s?` - ${s}`:""}${o!==void 0?` - ${o}`:""}`),a("MonitoringService",`Event: ${r} - ${n}${s?` - ${s}`:""}`,"info",{value:o})}catch(c){a("MonitoringService","Error logging event","error",c)}},logError:(r,n={})=>{try{console.error(`[ERROR] ${r.message}`,{error:r,context:n}),a("MonitoringService",`Error: ${r.message}`,"error",{...n,stack:r.stack})}catch(s){console.error("Failed to log error:",s),console.error("Original error:",r)}},startPerformanceTimer:r=>{try{i[r]={start:performance.now()},console.time(`[PERF] ${r}`)}catch(n){a("MonitoringService",`Error starting performance timer for ${r}`,"error",n)}},endPerformanceTimer:r=>{try{if(!i[r]){a("MonitoringService",`No timer found for ${r}`,"warning");return}const n=performance.now(),s=i[r].start,o=n-s;i[r]={start:s,end:n,duration:o},console.timeEnd(`[PERF] ${r}`),console.log(`[PERF] ${r}: ${o.toFixed(2)}ms`),a("MonitoringService",`Performance: ${r} - ${o.toFixed(2)}ms`,"info")}catch(n){a("MonitoringService",`Error ending performance timer for ${r}`,"error",n)}},getPerformanceMetrics:()=>{try{return{...i}}catch(r){return a("MonitoringService","Error getting performance metrics","error",r),{}}},clearPerformanceMetrics:()=>{try{Object.keys(i).forEach(r=>{delete i[r]}),a("MonitoringService","Performance metrics cleared","info")}catch(r){a("MonitoringService","Error clearing performance metrics","error",r)}}}};P.register("monitoringService",async()=>{const i=await dc();S.register("monitoringService",i)});const bs=(i,t,r,n)=>S.get("monitoringService").logEvent(i,t,r,n),Ss=(i,t={})=>S.get("monitoringService").logError(i,t),ws=i=>S.get("monitoringService").startPerformanceTimer(i),js=i=>S.get("monitoringService").endPerformanceTimer(i),_s=()=>S.get("monitoringService").getPerformanceMetrics(),ks=()=>S.get("monitoringService").clearPerformanceMetrics(),uc={logEvent:bs,logError:Ss,startPerformanceTimer:ws,endPerformanceTimer:js,getPerformanceMetrics:_s,clearPerformanceMetrics:ks},gc=Object.freeze(Object.defineProperty({__proto__:null,clearPerformanceMetrics:ks,default:uc,endPerformanceTimer:js,getPerformanceMetrics:_s,logError:Ss,logEvent:bs,startPerformanceTimer:ws},Symbol.toStringTag,{value:"Module"})),hc=async()=>{a("DatabaseService","Creating database service","info");const i=await A();return{getCurrentSchemaVersion:()=>Hr(),getAvailableMigrations:()=>migrations,applyMigrations:r=>Yr(i),rollbackMigrations:r=>Qr(i),verifySchema:()=>Kr(),getTableInfo:async()=>{try{a("DatabaseService","Getting table information","info");const{data:r,error:n}=await i.rpc("get_tables");if(n)throw a("DatabaseService","Error getting table information","error",n),n;return{data:r,error:null}}catch(r){return a("DatabaseService","Exception in getTableInfo","error",r),{data:null,error:r}}},executeSQL:async r=>{try{a("DatabaseService","Executing SQL","info");const{error:n}=await i.rpc("exec_sql",{query:r});return n?(a("DatabaseService","Error executing SQL","error",n),{success:!1,error:n}):{success:!0,error:null}}catch(n){return a("DatabaseService","Exception in executeSQL","error",n),{success:!1,error:n}}},checkDatabaseConnection:async()=>{try{a("DatabaseService","Checking database connection","info");const{data:r,error:n}=await i.from("books").select("id").limit(1);return n?(a("DatabaseService","Database connection check failed","error",n),{connected:!1,error:n}):{connected:!0,error:null}}catch(r){return a("DatabaseService","Exception in checkDatabaseConnection","error",r),{connected:!1,error:r}}},getSchemaVersionHistory:async()=>{try{a("DatabaseService","Getting schema version history","info");const{error:r}=await i.from("schema_versions").select("id").limit(1);if(r)return a("DatabaseService","Schema versions table does not exist yet","info"),{data:[],error:null};const{data:n,error:s}=await i.from("schema_versions").select("*").order("version",{ascending:!1});return s?(a("DatabaseService","Error getting schema version history","error",s),{data:null,error:s}):{data:n,error:null}}catch(r){return a("DatabaseService","Exception in getSchemaVersionHistory","error",r),{data:null,error:r}}}}};P.register("databaseService",async()=>{const i=await hc();S.register("databaseService",i)});const Hr=async()=>(await S.getOrInitialize("databaseService",P)).getCurrentSchemaVersion(),Is=async()=>(await S.getOrInitialize("databaseService",P)).getAvailableMigrations(),Yr=async i=>(await S.getOrInitialize("databaseService",P)).applyMigrations(i),Qr=async i=>(await S.getOrInitialize("databaseService",P)).rollbackMigrations(i),Kr=async()=>(await S.getOrInitialize("databaseService",P)).verifySchema(),Es=async()=>(await S.getOrInitialize("databaseService",P)).getTableInfo(),Cs=async i=>(await S.getOrInitialize("databaseService",P)).executeSQL(i),As=async()=>(await S.getOrInitialize("databaseService",P)).checkDatabaseConnection(),Rs=async()=>(await S.getOrInitialize("databaseService",P)).getSchemaVersionHistory(),Ts=async()=>S.getOrInitialize("databaseService",P),fc={getCurrentSchemaVersion:Hr,getAvailableMigrations:Is,applyMigrations:Yr,rollbackMigrations:Qr,verifySchema:Kr,getTableInfo:Es,executeSQL:Cs,checkDatabaseConnection:As,getSchemaVersionHistory:Rs,getDatabaseService:Ts},pc=Object.freeze(Object.defineProperty({__proto__:null,applyMigrations:Yr,checkDatabaseConnection:As,default:fc,executeSQL:Cs,getAvailableMigrations:Is,getCurrentSchemaVersion:Hr,getDatabaseService:Ts,getSchemaVersionHistory:Rs,getTableInfo:Es,rollbackMigrations:Qr,verifySchema:Kr},Symbol.toStringTag,{value:"Module"})),Ps=async()=>(a("AnalyticsService","Creating analytics service","info"),{identifyUser:(t,r={})=>{try{a("AnalyticsService",`Identify user: ${t}`,"info",r)}catch(n){a("AnalyticsService","Error identifying user","error",n)}},resetUser:()=>{try{a("AnalyticsService","Reset user","info")}catch(t){a("AnalyticsService","Error resetting user","error",t)}},trackEvent:(t,r={})=>{try{a("AnalyticsService",`Track event: ${t}`,"info",r)}catch(n){a("AnalyticsService","Error tracking event","error",n)}},trackPageView:(t,r={})=>{try{a("AnalyticsService",`Page view: ${t}`,"info",r)}catch(n){a("AnalyticsService","Error tracking page view","error",n)}},trackReaderAction:(t,r)=>{try{a("AnalyticsService",`Reader action: ${t}`,"info",r)}catch(n){a("AnalyticsService","Error tracking reader action","error",n)}},trackPerformance:(t,r,n={})=>{try{a("AnalyticsService",`Performance ${t}: ${r}ms`,"info",n)}catch(s){a("AnalyticsService","Error tracking performance","error",s)}}});P.register("analyticsService",async()=>{const i=await Ps();S.register("analyticsService",i)});const $s=(i,t)=>{const r=S.get("analyticsService");r&&r.identifyUser(i,t)},Os=()=>{const i=S.get("analyticsService");i&&i.resetUser()},Ds=(i,t)=>{const r=S.get("analyticsService");r&&r.trackEvent(i,t)},zs=(i,t)=>{const r=S.get("analyticsService");r&&r.trackPageView(i,t)},Ms=(i,t)=>{const r=S.get("analyticsService");r&&r.trackReaderAction(i,t)},Ls=(i,t,r)=>{const n=S.get("analyticsService");n&&n.trackPerformance(i,t,r)},xc={identifyUser:$s,resetUser:Os,trackEvent:Ds,trackPageView:zs,trackReaderAction:Ms,trackPerformance:Ls},mc=Object.freeze(Object.defineProperty({__proto__:null,createAnalyticsService:Ps,default:xc,identifyUser:$s,resetUser:Os,trackEvent:Ds,trackPageView:zs,trackPerformance:Ls,trackReaderAction:Ms},Symbol.toStringTag,{value:"Module"}));let Fi=!1;async function vc(i={}){if(Fi&&!i.forceReload){a("ServiceInitializer","Services already initialized","info");return}try{vo(),a("ServiceInitializer","Initializing all services...","info"),console.log("Initializing all services...");const t=xn();if(a("ServiceInitializer",`Initialization order: ${t.join(", ")}`,"info"),await P.initializeAll({useTopologicalOrder:!0}),i.requiredServices&&i.requiredServices.length>0){const r=i.requiredServices.filter(n=>!S.has(n));if(r.length>0){const n=`Missing required services: ${r.join(", ")}`;throw a("ServiceInitializer",n,"error"),new ne(n,Fe.SERVICE_INITIALIZATION_ERROR,{missingServices:r})}}Fi=!0,a("ServiceInitializer","All services initialized successfully","success"),console.log("All services initialized successfully")}catch(t){const r=t instanceof Error?t.message:String(t);throw a("ServiceInitializer",`Error initializing services: ${r}`,"error"),console.error("Error initializing services:",t),t instanceof ne?t:new ne(`Failed to initialize services: ${r}`,Fe.SERVICE_INITIALIZATION_ERROR,{originalError:t})}}function yc(){const[i,t]=g.useState([]),[r,n]=g.useState(!0),[s,o]=g.useState(!1),[c,d]=g.useState(null),h=async(v=!1)=>{if(n(!0),d(null),v){o(!0);try{a("ServiceStatusCheck","Reinitializing all services","info"),await vc({forceReload:!0}),a("ServiceStatusCheck","Services reinitialized successfully","success")}catch(w){const _=w instanceof Error?w.message:String(w);a("ServiceStatusCheck",`Failed to reinitialize services: ${_}`,"error"),d(`Failed to reinitialize services: ${_}`)}finally{o(!1)}}const b=Object.keys(rt).map(w=>{try{return po.has(w)?{name:w,status:"registered",dependencies:rt[w]||[]}:{name:w,status:"unregistered",dependencies:rt[w]||[]}}catch(_){return{name:w,status:"error",error:_ instanceof Error?_.message:String(_),dependencies:rt[w]||[]}}});t(b),n(!1)};g.useEffect(()=>{h()},[]);const u=v=>{switch(v){case"registered":return"success";case"unregistered":return"warning";case"error":return"error";default:return"warning"}},f=v=>{switch(v){case"registered":return e.jsx(bt,{color:"success"});case"unregistered":return e.jsx(Wr,{color:"warning"});case"error":return e.jsx(Ut,{color:"error"});default:return e.jsx(hn,{color:"info"})}},x=i.filter(v=>v.status==="registered").length,k=i.length;return e.jsxs(O,{sx:{p:3,maxWidth:800,mx:"auto",mt:4},children:[e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(l,{variant:"h5",children:"Service Status Check"}),e.jsx(z,{variant:"outlined",onClick:()=>h(!0),disabled:r||s,startIcon:s?e.jsx(le,{size:20}):e.jsx(gn,{}),children:s?"Reinitializing...":"Refresh Services"})]}),c&&e.jsx(fe,{severity:"error",sx:{mb:3},children:c}),e.jsx(We,{sx:{mb:3,bgcolor:"background.default"},children:e.jsx(De,{children:e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h6",children:"Total Services"}),e.jsx(l,{variant:"h3",children:k})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h6",children:"Registered"}),e.jsx(l,{variant:"h3",color:"success.main",children:x})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center"},children:[e.jsx(l,{variant:"h6",children:"Unregistered"}),e.jsx(l,{variant:"h3",color:"warning.main",children:k-x})]})})]})})}),e.jsx(l,{variant:"subtitle1",gutterBottom:!0,children:r?"Checking services...":`${x} of ${k} services registered`}),r?e.jsx(p,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(le,{})}):e.jsx(nt,{children:i.map(v=>e.jsx(Oe,{divider:!0,secondaryAction:f(v.status),children:e.jsx(ee,{primary:v.name,secondary:e.jsxs(e.Fragment,{children:[e.jsx(tt,{size:"small",label:v.status,color:u(v.status),sx:{mr:1}}),v.error&&e.jsxs(l,{color:"error",variant:"caption",display:"block",children:["Error: ",v.error]}),v.dependencies.length>0&&e.jsxs(l,{variant:"caption",display:"block",children:["Dependencies: ",v.dependencies.join(", ")]})]})})},v.name))})]})}var Zr={},bc=H;Object.defineProperty(Zr,"__esModule",{value:!0});var Bs=Zr.default=void 0,Sc=bc(Y()),wc=e;Bs=Zr.default=(0,Sc.default)((0,wc.jsx)("path",{d:"M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m9 7h-6v13h-2v-6h-2v6H9V9H3V7h18z"}),"Accessibility");const Rr={fontSize:100,lineHeight:1.5,contrast:"normal",reducedMotion:!1,dyslexicFont:!1},Us=At.createContext({settings:Rr,updateSettings:()=>{}}),Ns=()=>At.useContext(Us),jc=({children:i})=>{const[t,r]=g.useState(()=>{const s=localStorage.getItem("accessibility_settings");if(s)try{return JSON.parse(s)}catch{return Rr}return Rr}),n=s=>{const o={...t,...s};r(o),localStorage.setItem("accessibility_settings",JSON.stringify(o)),Wi(o)};return At.useEffect(()=>{Wi(t)},[]),e.jsx(Us.Provider,{value:{settings:t,updateSettings:n},children:i})},Wi=i=>{document.documentElement.style.setProperty("--base-font-size",`${i.fontSize}%`),document.documentElement.style.setProperty("--base-line-height",`${i.lineHeight}`),i.contrast==="high"?document.body.classList.add("high-contrast"):document.body.classList.remove("high-contrast"),i.reducedMotion?document.body.classList.add("reduced-motion"):document.body.classList.remove("reduced-motion"),i.dyslexicFont?document.body.classList.add("dyslexic-font"):document.body.classList.remove("dyslexic-font")},_c=()=>{const{settings:i,updateSettings:t}=Ns(),[r,n]=g.useState(null),s=x=>{n(x.currentTarget)},o=()=>{n(null)},c=(x,k)=>{t({fontSize:k})},d=(x,k)=>{t({lineHeight:k})},h=()=>{t({contrast:i.contrast==="normal"?"high":"normal"})},u=()=>{t({reducedMotion:!i.reducedMotion})},f=()=>{t({dyslexicFont:!i.dyslexicFont})};return e.jsxs(e.Fragment,{children:[e.jsx(qe,{"aria-label":"Accessibility settings",onClick:s,color:"inherit",children:e.jsx(Bs,{})}),e.jsxs(wr,{anchorEl:r,open:!!r,onClose:o,PaperProps:{sx:{width:320,maxWidth:"100%",p:2}},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Accessibility Settings"}),e.jsxs(l,{id:"font-size-slider",gutterBottom:!0,children:["Font Size: ",i.fontSize,"%"]}),e.jsx(zi,{value:i.fontSize,onChange:c,"aria-labelledby":"font-size-slider",min:50,max:200,step:10,valueLabelDisplay:"auto",sx:{mb:3}}),e.jsxs(l,{id:"line-height-slider",gutterBottom:!0,children:["Line Height: ",i.lineHeight]}),e.jsx(zi,{value:i.lineHeight,onChange:d,"aria-labelledby":"line-height-slider",min:1,max:3,step:.1,valueLabelDisplay:"auto",sx:{mb:3}}),e.jsx(he,{sx:{my:2}}),e.jsx(rr,{control:e.jsx(hr,{checked:i.contrast==="high",onChange:h}),label:"High Contrast"}),e.jsx(rr,{control:e.jsx(hr,{checked:i.reducedMotion,onChange:u}),label:"Reduced Motion"}),e.jsx(rr,{control:e.jsx(hr,{checked:i.dyslexicFont,onChange:f}),label:"Dyslexic-Friendly Font"})]})]})},kc=({children:i})=>{const t=Et();return e.jsx(Va,{maxSnack:3,autoHideDuration:3e3,anchorOrigin:{vertical:"top",horizontal:"right"},style:{zIndex:t.zIndex.snackbar},children:i})},Ic=({contentId:i})=>e.jsx("a",{href:`#${i}`,className:"skip-to-content",children:"Skip to content"}),dt=class dt{constructor(){ae(this,"isInitialized",!1)}static getInstance(){return dt.instance||(dt.instance=new dt),dt.instance}async initialize(){if(!this.isInitialized)try{await this.ensureTableExists(),this.isInitialized=!0,a("ActivityTrackingService","Activity tracking service initialized successfully","info")}catch(t){a("ActivityTrackingService","Failed to initialize activity tracking service","error",t)}}async ensureTableExists(){const t=await A(),{error:r}=await t.rpc("check_table_exists",{table_name:"interactions"});r&&a("ActivityTrackingService","Interactions table check failed, table may not exist","warning",r)}async trackEvent(t){try{await this.initialize();const r=await A(),{error:n}=await r.from("interactions").insert({user_id:t.user_id,event_type:t.event_type,book_id:t.book_id||null,section_id:t.section_id||null,page_number:t.page_number||null,content:t.content||null,context:t.context||null,created_at:new Date().toISOString()});return n?(a("ActivityTrackingService","Failed to track event","error",n),!1):(a("ActivityTrackingService",`Event tracked successfully: ${t.event_type}`,"info"),!0)}catch(r){return a("ActivityTrackingService","Error tracking event","error",r),!1}}async trackLogin(t){return this.trackEvent({user_id:t,event_type:"LOGIN"})}async trackLogout(t){return this.trackEvent({user_id:t,event_type:"LOGOUT"})}async trackPageSync(t,r,n){return this.trackEvent({user_id:t,event_type:"PAGE_SYNC",book_id:r,page_number:n})}async trackAIQuery(t,r,n,s){return this.trackEvent({user_id:t,event_type:"AI_QUERY",book_id:r,content:n,context:{response:s}})}async trackHelpRequest(t,r,n){return this.trackEvent({user_id:t,event_type:"HELP_REQUEST",book_id:r,content:n})}async trackFeedback(t,r,n,s){return this.trackEvent({user_id:t,event_type:"FEEDBACK_SUBMISSION",book_id:r,content:n,context:{feedback_type:s}})}async getUserActivity(t,r=50){try{const n=await A(),{data:s,error:o}=await n.from("interactions").select("*").eq("user_id",t).order("created_at",{ascending:!1}).limit(r);return o?(a("ActivityTrackingService","Failed to get user activity","error",o),[]):s||[]}catch(n){return a("ActivityTrackingService","Error getting user activity","error",n),[]}}async getAllRecentActivity(t=100){try{const r=await A(),{data:n,error:s}=await r.from("interactions").select(`
          *,
          profiles:user_id(first_name, last_name, email)
        `).order("created_at",{ascending:!1}).limit(t);return s?(a("ActivityTrackingService","Failed to get all recent activity","error",s),[]):n||[]}catch(r){return a("ActivityTrackingService","Error getting all recent activity","error",r),[]}}async getCurrentlyLoggedInUsers(){try{const t=await A(),r=new Date(Date.now()-30*60*1e3).toISOString(),{data:n,error:s}=await t.from("interactions").select(`
          user_id,
          created_at,
          profiles:user_id(first_name, last_name, email)
        `).eq("event_type","LOGIN").gte("created_at",r).order("created_at",{ascending:!1});if(s)return a("ActivityTrackingService","Failed to get currently logged in users","error",s),[];const o=new Map;return n==null||n.forEach(c=>{o.has(c.user_id)||o.set(c.user_id,{user_id:c.user_id,login_time:c.created_at,profile:c.profiles})}),Array.from(o.values())}catch(t){return a("ActivityTrackingService","Error getting currently logged in users","error",t),[]}}async getActivityStats(){try{const t=await A(),r=new Date,n=new Date(r.getTime()-24*60*60*1e3).toISOString(),s=new Date(r.getTime()-7*24*60*60*1e3).toISOString(),{data:o,error:c}=await t.from("interactions").select("event_type, created_at").gte("created_at",n),{data:d,error:h}=await t.from("interactions").select("event_type, created_at").gte("created_at",s);if(c||h)return a("ActivityTrackingService","Failed to get activity stats","error",{dailyError:c,weeklyError:h}),{};const u=this.calculateEventStats(o||[]),f=this.calculateEventStats(d||[]);return{daily:u,weekly:f,total_daily_events:(o==null?void 0:o.length)||0,total_weekly_events:(d==null?void 0:d.length)||0}}catch(t){return a("ActivityTrackingService","Error getting activity stats","error",t),{}}}calculateEventStats(t){const r={};return t.forEach(n=>{r[n.event_type]||(r[n.event_type]=0),r[n.event_type]++}),r}};ae(dt,"instance");let Tr=dt;const qi=Tr.getInstance(),Vs=g.createContext(void 0),Ec=({children:i})=>{console.log("AuthProvider: Mounting / Initializing");const[t,r]=g.useState(null),[n,s]=g.useState(null),[o,c]=g.useState(null),[d,h]=g.useState(!0),[u,f]=g.useState(!1),x=async()=>{a("AuthContext","Signing out user.","info"),h(!0);const _=n==null?void 0:n.id;if(_)try{await qi.trackLogout(_),a("AuthContext","Logout event tracked successfully","info")}catch(D){a("AuthContext","Failed to track logout event","warning",D)}try{r(null),s(null),c(null),f(!1),typeof window<"u"&&Object.keys(localStorage).forEach(I=>{(I.startsWith("sb-")||I.startsWith("supabase"))&&(localStorage.removeItem(I),a("AuthContext",`Removed item from localStorage: ${I}`,"info"))});const{error:D}=await Uo();D?a("AuthContext","Error during backend sign out","error",D):a("AuthContext","Backend sign out successful.","success")}catch(D){a("AuthContext","An unexpected error occurred during sign out","error",D)}finally{h(!1),a("AuthContext","Sign out process complete.","info")}};g.useEffect(()=>{let _=!0;(async()=>{var T,B,F;a("AuthContext","Initializing authentication state...","info"),h(!0);try{typeof window<"u"&&Object.keys(localStorage).forEach(C=>{if(C.startsWith("sb-")||C.startsWith("supabase"))try{const $=localStorage.getItem(C);if($){const R=JSON.parse($);R.expires_at&&new Date(R.expires_at*1e3)<new Date&&(localStorage.removeItem(C),a("AuthContext",`Removed expired token from localStorage: ${C}`,"info"))}}catch{localStorage.removeItem(C),a("AuthContext",`Removed invalid token from localStorage: ${C}`,"info")}});const y=await No(),M=((T=y==null?void 0:y.data)==null?void 0:T.session)||null,U=(y==null?void 0:y.error)||null;if(U){if((B=U.message)!=null&&B.includes("Invalid Refresh Token")||(F=U.message)!=null&&F.includes("Refresh Token Not Found")){a("AuthContext","Invalid refresh token detected, clearing auth state","warning"),typeof window<"u"&&Object.keys(localStorage).forEach(C=>{(C.startsWith("sb-")||C.startsWith("supabase"))&&localStorage.removeItem(C)}),_&&(r(null),s(null),c(null),f(!1),h(!1));return}a("AuthContext","Error getting session during initialization","error",U)}if(_){if(M){r(M),s(M.user),a("AuthContext",`Session found for user: ${M.user.id}`,"info");const{data:C,error:$}=await yr(M.user.id);$?(a("AuthContext","Error fetching profile on initial load","error",$),await x()):C?(c(C),f(C.book_verified||!1),a("AuthContext","Profile loaded on initialization","success")):(a("AuthContext","No profile found for existing session. Signing out.","warning"),await x())}else r(null),s(null),c(null),f(!1);h(!1),a("AuthContext","Authentication state initialized.","info")}}catch(y){a("AuthContext","Error during auth initialization","error",y),_&&(r(null),s(null),c(null),f(!1),h(!1))}})();let I=null;return(async()=>{var T;try{const B=await Vo((F,y)=>{_&&(a("AuthContext",`Auth state changed. Event: ${F}`,"info"),r(y),s((y==null?void 0:y.user)??null),y||(c(null),f(!1),h(!1)))});I=(T=B==null?void 0:B.data)==null?void 0:T.subscription}catch(B){a("AuthContext","Error setting up auth state change listener","error",B)}})(),()=>{_=!1,I&&(I.unsubscribe(),a("AuthContext","Auth state change subscription stopped.","info"))}},[]);const w={session:t,user:n,profile:o,loading:d,isVerified:u,setIsVerified:f,signIn:async(_,D)=>{h(!0);try{a("AuthContext",`Signing in user with email: ${_}`,"info"),console.log("AuthContext: Signing in user with email:",_);const{data:I,error:L}=await Lo(_,D);if(L)throw a("AuthContext","Error during sign in","error",L),console.error("AuthContext: Error during sign in:",L),L;if(!(I!=null&&I.user))throw a("AuthContext","User not found during sign in","error"),console.error("AuthContext: User not found during sign in"),new Error("User not found");a("AuthContext","Sign in successful","success"),console.log("AuthContext: Sign in successful, user:",I.user);try{const{data:T,error:B}=await yr(I.user.id);if(B)throw a("AuthContext","Warning: Could not fetch profile after sign in. Signing out.","warning",B),await x(),new Error("Could not verify user profile.");if(T){a("AuthContext","Profile fetched successfully after sign in","success"),c(T),f(T.book_verified||!1);try{await qi.trackLogin(I.user.id),a("AuthContext","Login event tracked successfully","info")}catch(F){a("AuthContext","Failed to track login event","warning",F)}}else throw a("AuthContext","User profile not found. Signing out.","error"),await x(),new Error("User profile not found.")}catch(T){throw a("AuthContext","Error fetching profile after sign in. Signing out.","warning",T),await x(),T}return{user:I.user,error:null}}catch(I){return a("AuthContext","Error signing in","error",I),console.error("AuthContext: Error signing in:",I),{user:null,error:I instanceof Error?I:new Error("Unknown error")}}finally{h(!1)}},signUp:async(_,D,I,L)=>{h(!0);try{a("AuthContext",`Signing up user with email: ${_}`,"info"),console.log("AuthContext: Signing up user with email:",_);const{data:T,error:B}=await Bo(_,D);if(B)throw a("AuthContext","Error during signup","error",B),console.error("AuthContext: Error during signup:",B),B;if(!(T!=null&&T.user))throw a("AuthContext","User creation failed - no user returned","error"),console.error("AuthContext: User creation failed - no user returned"),new Error("User creation failed");a("AuthContext",`User created successfully. Updating profile for: ${T.user.id}`,"info"),console.log("AuthContext: User created successfully. Updating profile for:",T.user.id);try{await new Promise(y=>setTimeout(y,1e3));const{error:F}=await Fo(T.user.id,I,L,_);F?(a("AuthContext",`Warning: Could not update profile with names: ${F.message}`,"warning"),console.warn("AuthContext: Could not update profile with names:",F)):(a("AuthContext","Profile updated successfully with names","success"),console.log("AuthContext: Profile updated successfully with names"))}catch(F){a("AuthContext","Error updating profile during signup","warning",F),console.warn("AuthContext: Error updating profile during signup:",F)}return{user:T.user,error:null}}catch(T){return a("AuthContext","Error signing up","error",T),console.error("AuthContext: Error signing up:",T),{user:null,error:T instanceof Error?T:new Error("Unknown error")}}finally{h(!1)}},signOut:x,verifyBook:async(_,D,I)=>{try{if(!n)return{success:!1,error:new Error("User not authenticated")};console.log("AuthContext: Starting book verification with code:",_),console.log("AuthContext: User ID:",n.id),console.log("AuthContext: First name:",D),console.log("AuthContext: Last name:",I);const L=await Wo(_,n.id,D,I);if(console.log("AuthContext: Verification result:",L),L.error)return console.error("AuthContext: Verification error:",L.error),{success:!1,error:new Error(String(L.error))};console.log("AuthContext: Verification successful, updating isVerified state to true"),f(!0);try{console.log("AuthContext: Re-fetching user profile after verification");const{data:T}=await yr(n.id);T&&(console.log("AuthContext: Updated profile after verification:",T),c(T))}catch(T){console.error("AuthContext: Error fetching profile after verification:",T)}return console.log("AuthContext: Book verification completed successfully"),{success:!0}}catch(L){return console.error("AuthContext: Unexpected error during verification:",L),{success:!1,error:L instanceof Error?L:new Error("Unknown error during verification")}}},isConsultant:()=>(o==null?void 0:o.is_consultant)||!1};return console.log("AuthProvider: Initial loading state:",d),e.jsx(Vs.Provider,{value:w,children:i})},je=()=>{const i=g.useContext(Vs);if(i===void 0)throw new Error("useAuth must be used within an AuthProvider");return i},pe=({children:i,routeType:t})=>{var d;const{user:r,loading:n,isVerified:s,profile:o}=je(),c=Ft();if(a("RouteGuard",`Checking access to ${c.pathname} (type: ${t})`,"info",{isAuthenticated:!!r,isVerified:s,routeType:t}),n)return null;switch(t){case"public":return r&&s&&(c.pathname==="/login"||c.pathname==="/register")?(a("RouteGuard","User is verified, redirecting from public route to reader interaction page","info"),e.jsx(Ne,{to:"/reader/interaction",replace:!0})):r&&!s&&c.pathname==="/register"?e.jsx(Ne,{to:"/welcome",replace:!0}):e.jsx(e.Fragment,{children:i});case"auth":return r?e.jsx(e.Fragment,{children:i}):(a("RouteGuard","User not authenticated, redirecting to login","info"),e.jsx(Ne,{to:"/login",state:{from:c},replace:!0}));case"verified":return r?s?e.jsx(e.Fragment,{children:i}):(a("RouteGuard","User not verified, redirecting to verification page","info"),e.jsx(Ne,{to:"/verify",state:{from:c},replace:!0})):(a("RouteGuard","User not authenticated, redirecting to login","info"),e.jsx(Ne,{to:"/login",state:{from:c},replace:!0}));case"admin":return r?(o==null?void 0:o.is_admin)||((d=r.email)==null?void 0:d.endsWith("@alicereader.com"))||r.email==="admin@example.com"?e.jsx(e.Fragment,{children:i}):(a("RouteGuard","User not authorized for admin access","warning"),e.jsx(Ne,{to:"/reader",replace:!0})):(a("RouteGuard","User not authenticated, redirecting to login","info"),e.jsx(Ne,{to:"/login",state:{from:c},replace:!0}));default:return a("RouteGuard",`Unknown route type: ${t}, treating as verified route`,"warning"),r?s?e.jsx(e.Fragment,{children:i}):e.jsx(Ne,{to:"/verify",state:{from:c},replace:!0}):e.jsx(Ne,{to:"/login",state:{from:c},replace:!0})}};var Jr={},Cc=H;Object.defineProperty(Jr,"__esModule",{value:!0});var Fs=Jr.default=void 0,Ac=Cc(Y()),Rc=e;Fs=Jr.default=(0,Ac.default)((0,Rc.jsx)("path",{d:"M3 18h18v-2H3zm0-5h18v-2H3zm0-7v2h18V6z"}),"Menu");var Xr={},Tc=H;Object.defineProperty(Xr,"__esModule",{value:!0});var Ws=Xr.default=void 0,Pc=Tc(Y()),$c=e;Ws=Xr.default=(0,Pc.default)((0,$c.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6m0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20"}),"AccountCircle");var ei={},Oc=H;Object.defineProperty(ei,"__esModule",{value:!0});var Pr=ei.default=void 0,Dc=Oc(Y()),zc=e;Pr=ei.default=(0,Dc.default)((0,zc.jsx)("path",{d:"m17 7-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4z"}),"Logout");var ti={},Mc=H;Object.defineProperty(ti,"__esModule",{value:!0});var ir=ti.default=void 0,Lc=Mc(Y()),Bc=e;ir=ti.default=(0,Lc.default)((0,Bc.jsx)("path",{d:"M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6"}),"Settings");var ri={},Uc=H;Object.defineProperty(ri,"__esModule",{value:!0});var $r=ri.default=void 0,Nc=Uc(Y()),Vc=e;$r=ri.default=(0,Nc.default)((0,Vc.jsx)("path",{d:"M3 13h8V3H3zm0 8h8v-6H3zm10 0h8V11h-8zm0-18v6h8V3z"}),"Dashboard");var ii={},Fc=H;Object.defineProperty(ii,"__esModule",{value:!0});var _t=ii.default=void 0,Wc=Fc(Y()),Gi=e;_t=ii.default=(0,Wc.default)([(0,Gi.jsx)("path",{d:"M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1m0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5z"},"0"),(0,Gi.jsx)("path",{d:"M17.5 10.5c.88 0 1.73.09 2.5.26V9.24c-.79-.15-1.64-.24-2.5-.24-1.7 0-3.24.29-4.5.83v1.66c1.13-.64 2.7-.99 4.5-.99M13 12.49v1.66c1.13-.64 2.7-.99 4.5-.99.88 0 1.73.09 2.5.26V11.9c-.79-.15-1.64-.24-2.5-.24-1.7 0-3.24.3-4.5.83m4.5 1.84c-1.7 0-3.24.29-4.5.83v1.66c1.13-.64 2.7-.99 4.5-.99.88 0 1.73.09 2.5.26v-1.52c-.79-.16-1.64-.24-2.5-.24"},"1")],"MenuBook");var ni={},qc=H;Object.defineProperty(ni,"__esModule",{value:!0});var kt=ni.default=void 0,Gc=qc(Y()),Hc=e;kt=ni.default=(0,Gc.default)((0,Hc.jsx)("path",{d:"M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"}),"Home");var si={},Yc=H;Object.defineProperty(si,"__esModule",{value:!0});var Or=si.default=void 0,Qc=Yc(Y()),Kc=e;Or=si.default=(0,Qc.default)((0,Kc.jsx)("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M9 17H7v-7h2zm4 0h-2V7h2zm4 0h-2v-4h2z"}),"Assessment");const Xt="#6a51ae",Hi="#ff6b8b",Yi="#4caf50",Qi="#ff9800",Ki="#f44336",Zi="#2196f3",Se={SHORT:150,MEDIUM:300,LONG:500};let Ji=Sa({palette:{primary:{main:Xt,light:Je(Xt,.8),dark:"#5a439e",contrastText:"#ffffff"},secondary:{main:Hi,light:Je(Hi,.8),dark:"#e05c7a",contrastText:"#ffffff"},success:{main:Yi,light:Je(Yi,.8),dark:"#388e3c",contrastText:"#ffffff"},warning:{main:Qi,light:Je(Qi,.8),dark:"#f57c00",contrastText:"#ffffff"},error:{main:Ki,light:Je(Ki,.8),dark:"#d32f2f",contrastText:"#ffffff"},info:{main:Zi,light:Je(Zi,.8),dark:"#1976d2",contrastText:"#ffffff"},background:{default:"#f8f9fa",paper:"#ffffff"},text:{primary:"#212529",secondary:"#6c757d"}},typography:{fontFamily:'"Roboto", "Helvetica", "Arial", sans-serif',h1:{fontSize:"2.5rem",fontWeight:500,lineHeight:1.2},h2:{fontSize:"2rem",fontWeight:500,lineHeight:1.3},h3:{fontSize:"1.75rem",fontWeight:500,lineHeight:1.4},h4:{fontSize:"1.5rem",fontWeight:500,lineHeight:1.4},h5:{fontSize:"1.25rem",fontWeight:500,lineHeight:1.4},h6:{fontSize:"1rem",fontWeight:500,lineHeight:1.4},subtitle1:{fontSize:"1rem",fontWeight:400,lineHeight:1.5},subtitle2:{fontSize:"0.875rem",fontWeight:500,lineHeight:1.5},body1:{fontSize:"1rem",lineHeight:1.6},body2:{fontSize:"0.875rem",lineHeight:1.6},button:{textTransform:"none",fontWeight:500}},shape:{borderRadius:8},shadows:["none","0px 2px 1px -1px rgba(0,0,0,0.05),0px 1px 1px 0px rgba(0,0,0,0.03),0px 1px 3px 0px rgba(0,0,0,0.02)","0px 3px 1px -2px rgba(0,0,0,0.05),0px 2px 2px 0px rgba(0,0,0,0.03),0px 1px 5px 0px rgba(0,0,0,0.02)","0px 3px 3px -2px rgba(0,0,0,0.05),0px 3px 4px 0px rgba(0,0,0,0.03),0px 1px 8px 0px rgba(0,0,0,0.02)","0px 2px 4px -1px rgba(0,0,0,0.05),0px 4px 5px 0px rgba(0,0,0,0.03),0px 1px 10px 0px rgba(0,0,0,0.02)","0px 3px 5px -1px rgba(0,0,0,0.05),0px 5px 8px 0px rgba(0,0,0,0.03),0px 1px 14px 0px rgba(0,0,0,0.02)","0px 3px 5px -1px rgba(0,0,0,0.05),0px 6px 10px 0px rgba(0,0,0,0.03),0px 1px 18px 0px rgba(0,0,0,0.02)","0px 4px 5px -2px rgba(0,0,0,0.05),0px 7px 10px 1px rgba(0,0,0,0.03),0px 2px 16px 1px rgba(0,0,0,0.02)","0px 5px 5px -3px rgba(0,0,0,0.05),0px 8px 10px 1px rgba(0,0,0,0.03),0px 3px 14px 2px rgba(0,0,0,0.02)","0px 5px 6px -3px rgba(0,0,0,0.05),0px 9px 12px 1px rgba(0,0,0,0.03),0px 3px 16px 2px rgba(0,0,0,0.02)","0px 6px 6px -3px rgba(0,0,0,0.05),0px 10px 14px 1px rgba(0,0,0,0.03),0px 4px 18px 3px rgba(0,0,0,0.02)","0px 6px 7px -4px rgba(0,0,0,0.05),0px 11px 15px 1px rgba(0,0,0,0.03),0px 4px 20px 3px rgba(0,0,0,0.02)","0px 7px 8px -4px rgba(0,0,0,0.05),0px 12px 17px 2px rgba(0,0,0,0.03),0px 5px 22px 4px rgba(0,0,0,0.02)","0px 7px 8px -4px rgba(0,0,0,0.05),0px 13px 19px 2px rgba(0,0,0,0.03),0px 5px 24px 4px rgba(0,0,0,0.02)","0px 7px 9px -4px rgba(0,0,0,0.05),0px 14px 21px 2px rgba(0,0,0,0.03),0px 5px 26px 4px rgba(0,0,0,0.02)","0px 8px 9px -5px rgba(0,0,0,0.05),0px 15px 22px 2px rgba(0,0,0,0.03),0px 6px 28px 5px rgba(0,0,0,0.02)","0px 8px 10px -5px rgba(0,0,0,0.05),0px 16px 24px 2px rgba(0,0,0,0.03),0px 6px 30px 5px rgba(0,0,0,0.02)","0px 8px 11px -5px rgba(0,0,0,0.05),0px 17px 26px 2px rgba(0,0,0,0.03),0px 6px 32px 5px rgba(0,0,0,0.02)","0px 9px 11px -5px rgba(0,0,0,0.05),0px 18px 28px 2px rgba(0,0,0,0.03),0px 7px 34px 6px rgba(0,0,0,0.02)","0px 9px 12px -6px rgba(0,0,0,0.05),0px 19px 29px 2px rgba(0,0,0,0.03),0px 7px 36px 6px rgba(0,0,0,0.02)","0px 10px 13px -6px rgba(0,0,0,0.05),0px 20px 31px 3px rgba(0,0,0,0.03),0px 8px 38px 7px rgba(0,0,0,0.02)","0px 10px 13px -6px rgba(0,0,0,0.05),0px 21px 33px 3px rgba(0,0,0,0.03),0px 8px 40px 7px rgba(0,0,0,0.02)","0px 10px 14px -6px rgba(0,0,0,0.05),0px 22px 35px 3px rgba(0,0,0,0.03),0px 8px 42px 7px rgba(0,0,0,0.02)","0px 11px 14px -7px rgba(0,0,0,0.05),0px 23px 36px 3px rgba(0,0,0,0.03),0px 9px 44px 8px rgba(0,0,0,0.02)","0px 11px 15px -7px rgba(0,0,0,0.05),0px 24px 38px 3px rgba(0,0,0,0.03),0px 9px 46px 8px rgba(0,0,0,0.02)"],components:{MuiCssBaseline:{styleOverrides:{body:{scrollbarWidth:"thin","&::-webkit-scrollbar":{width:"8px",height:"8px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1"},"&::-webkit-scrollbar-thumb":{background:"#c1c1c1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb:hover":{background:"#a8a8a8"}}}},MuiButton:{styleOverrides:{root:{borderRadius:8,padding:"8px 16px",transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`,"&:hover":{transform:"translateY(-1px)",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)"}},containedPrimary:{"&:hover":{backgroundColor:"#5a439e"}},containedSecondary:{"&:hover":{backgroundColor:"#e05c7a"}},outlined:{borderWidth:"1.5px","&:hover":{borderWidth:"1.5px"}}}},MuiTextField:{styleOverrides:{root:{marginBottom:16,"& .MuiOutlinedInput-root":{transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`,"&.Mui-focused":{boxShadow:`0 0 0 3px ${Je(Xt,.2)}`}}}}},MuiPaper:{styleOverrides:{root:{borderRadius:8,transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`},elevation1:{boxShadow:"0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1)"},elevation2:{boxShadow:"0 3px 6px rgba(0, 0, 0, 0.05), 0 2px 4px rgba(0, 0, 0, 0.1)"},elevation3:{boxShadow:"0 10px 20px rgba(0, 0, 0, 0.05), 0 3px 6px rgba(0, 0, 0, 0.1)"},elevation4:{boxShadow:"0 15px 25px rgba(0, 0, 0, 0.05), 0 5px 10px rgba(0, 0, 0, 0.1)"}}},MuiCard:{styleOverrides:{root:{borderRadius:12,overflow:"hidden",transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`,"&:hover":{transform:"translateY(-2px)",boxShadow:"0 12px 20px rgba(0, 0, 0, 0.1)"}}}},MuiCardContent:{styleOverrides:{root:{padding:16,"&:last-child":{paddingBottom:16}}}},MuiChip:{styleOverrides:{root:{borderRadius:16,transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`},clickable:{"&:hover":{transform:"translateY(-1px)"}}}},MuiLinearProgress:{styleOverrides:{root:{borderRadius:4,height:6,backgroundColor:Je(Xt,.1)}}},MuiCircularProgress:{styleOverrides:{root:{transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`}}},MuiDialog:{styleOverrides:{paper:{borderRadius:12,boxShadow:"0 24px 38px rgba(0, 0, 0, 0.1), 0 9px 46px rgba(0, 0, 0, 0.1)"}}},MuiDialogTitle:{styleOverrides:{root:{padding:"16px 24px"}}},MuiDialogContent:{styleOverrides:{root:{padding:"8px 24px 20px"}}},MuiDialogActions:{styleOverrides:{root:{padding:"8px 16px 16px"}}},MuiSnackbar:{styleOverrides:{root:{"& .MuiAlert-root":{borderRadius:8,boxShadow:"0 8px 16px rgba(0, 0, 0, 0.1)"}}}},MuiAlert:{styleOverrides:{root:{borderRadius:8,boxShadow:"0 2px 8px rgba(0, 0, 0, 0.1)"}}},MuiAppBar:{styleOverrides:{root:{boxShadow:"0 2px 4px rgba(0, 0, 0, 0.05)"}}},MuiTabs:{styleOverrides:{root:{"& .MuiTab-root":{transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`}},indicator:{height:3,borderRadius:"3px 3px 0 0",transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`}}},MuiTab:{styleOverrides:{root:{textTransform:"none",fontWeight:500,"&.Mui-selected":{fontWeight:600}}}},MuiListItem:{styleOverrides:{root:{transition:`background-color ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`}}},MuiMenuItem:{styleOverrides:{root:{transition:`background-color ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`}}},MuiAccordion:{styleOverrides:{root:{borderRadius:8,overflow:"hidden","&:before":{display:"none"},"&.Mui-expanded":{margin:0}}}},MuiAccordionSummary:{styleOverrides:{root:{transition:`background-color ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`}}},MuiTooltip:{styleOverrides:{tooltip:{backgroundColor:"rgba(33, 33, 33, 0.9)",borderRadius:4,fontSize:"0.75rem",padding:"6px 10px"},arrow:{color:"rgba(33, 33, 33, 0.9)"}}},MuiBackdrop:{styleOverrides:{root:{backgroundColor:"rgba(0, 0, 0, 0.5)",backdropFilter:"blur(4px)"}}}}});Ji=wa(Ji);const Zc=({children:i})=>{const t=Ea();return e.jsx(Ca,{appear:!1,direction:"down",in:!t,children:i})},Jc=()=>{const i=Et(),t=Lr(i.breakpoints.down("sm")),r=st(),n=Ft(),{user:s,signOut:o}=je(),[c,d]=g.useState(null),[h,u]=g.useState(null),[f,x]=g.useState(!1);At.useEffect(()=>{const I=setTimeout(()=>{x(!0)},100);return()=>clearTimeout(I)},[]);const k=I=>{d(I.currentTarget)},v=()=>{d(null)},E=I=>{u(I.currentTarget)},b=()=>{u(null)},w=I=>{v(),b(),r(I)},_=async()=>{try{await o(),r("/login")}catch(I){console.error("Error signing out:",I)}},D=()=>s?(s.email||"").substring(0,2).toUpperCase():"?";return["/login","/register","/verify"].includes(n.pathname)?null:e.jsx(Zc,{children:e.jsx(ja,{position:"sticky",elevation:1,sx:{backgroundColor:i.palette.background.paper,transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`,opacity:f?1:0,transform:f?"translateY(0)":"translateY(-20px)"},children:e.jsxs(_a,{children:[e.jsxs(l,{variant:"h6",sx:{flexGrow:1,color:"inherit",display:"flex",alignItems:"center",gap:1,fontFamily:'"Alice", serif'},children:[e.jsx(_t,{sx:{mr:1}}),"Alice Reader"]}),s&&e.jsx(p,{sx:{display:"flex",alignItems:"center"},children:e.jsx(ka,{title:"Account settings",children:e.jsx(qe,{onClick:E,size:"small",sx:{ml:2},"aria-controls":h?"account-menu":void 0,"aria-haspopup":"true","aria-expanded":h?"true":void 0,children:e.jsx(Ia,{sx:{width:32,height:32,bgcolor:i.palette.primary.main,transition:`all ${Se.MEDIUM}ms cubic-bezier(0.4, 0, 0.2, 1)`,"&:hover":{bgcolor:i.palette.primary.dark}},children:D()})})})}),t&&e.jsx(qe,{color:"inherit",onClick:k,size:"large",children:e.jsx(Fs,{})}),e.jsx(wr,{anchorEl:c,open:!!c,onClose:v,TransitionComponent:Mi,PaperProps:{elevation:3,sx:{minWidth:200,borderRadius:2,mt:1.5}},children:s?e.jsxs(e.Fragment,{children:[e.jsxs(_e,{onClick:()=>w("/reader"),children:[e.jsx(we,{children:e.jsx($r,{fontSize:"small"})}),e.jsx(ee,{primary:"Dashboard"})]}),e.jsxs(_e,{onClick:()=>w("/reader/stats"),children:[e.jsx(we,{children:e.jsx(Or,{fontSize:"small"})}),e.jsx(ee,{primary:"My Stats"})]}),e.jsxs(_e,{onClick:()=>w("/settings"),children:[e.jsx(we,{children:e.jsx(ir,{fontSize:"small"})}),e.jsx(ee,{primary:"Settings"})]}),e.jsx(he,{}),e.jsxs(_e,{onClick:_,children:[e.jsx(we,{children:e.jsx(Pr,{fontSize:"small"})}),e.jsx(ee,{children:"Logout"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(_e,{onClick:()=>w("/login"),children:e.jsx(ee,{primary:"Login"})}),e.jsx(_e,{onClick:()=>w("/register"),children:e.jsx(ee,{primary:"Sign Up"})})]})}),e.jsxs(wr,{anchorEl:h,open:!!h,onClose:b,TransitionComponent:Mi,PaperProps:{elevation:3,sx:{minWidth:200,borderRadius:2,mt:1.5}},children:[e.jsxs(_e,{onClick:b,disabled:!0,children:[e.jsx(we,{children:e.jsx(Ws,{fontSize:"small"})}),e.jsx(ee,{primary:s==null?void 0:s.email})]}),e.jsx(he,{}),e.jsxs(_e,{onClick:()=>w("/"),children:[e.jsx(we,{children:e.jsx(kt,{fontSize:"small"})}),e.jsx(ee,{primary:"Welcome Page",secondary:"Start your reading journey"})]}),e.jsxs(_e,{onClick:()=>w("/reader"),children:[e.jsx(we,{children:e.jsx($r,{fontSize:"small"})}),e.jsx(ee,{primary:"Dashboard",secondary:"View your reading overview"})]}),e.jsxs(_e,{onClick:()=>w("/reader/stats"),children:[e.jsx(we,{children:e.jsx(Or,{fontSize:"small"})}),e.jsx(ee,{primary:"My Reading Stats",secondary:"View progress and notes"})]}),e.jsxs(_e,{onClick:()=>w("/settings"),children:[e.jsx(we,{children:e.jsx(ir,{fontSize:"small"})}),e.jsx(ee,{primary:"Settings",secondary:"Customize your experience"})]}),e.jsx(he,{}),e.jsxs(_e,{onClick:_,children:[e.jsx(we,{children:e.jsx(Pr,{fontSize:"small"})}),e.jsx(ee,{children:"Logout"})]})]})]})})})};let St=!1;function qs(){a("ServiceInitializers","Registering service initializers","info"),S.registerInitializer(G.AUTH_SERVICE,async()=>{try{console.log("ServiceInitializers: Importing authService module");const i=await ge(()=>Promise.resolve().then(()=>An),void 0);if(console.log("ServiceInitializers: authService module imported:",i),typeof i.createAuthService!="function")throw console.error("ServiceInitializers: createAuthService is not a function in the imported module"),new Error("createAuthService is not a function");return console.log("ServiceInitializers: Creating auth service"),i.createAuthService()}catch(i){throw console.error("ServiceInitializers: Error initializing auth service:",i),i}}),S.registerInitializer(G.BOOK_SERVICE,async()=>{try{console.log("ServiceInitializers: Importing bookService module");const i=await ge(()=>Promise.resolve().then(()=>Vn),void 0);if(console.log("ServiceInitializers: bookService module imported:",i),typeof i.createBookService!="function")throw console.error("ServiceInitializers: createBookService is not a function in the imported module"),new Error("createBookService is not a function");return console.log("ServiceInitializers: Creating book service"),i.createBookService()}catch(i){throw console.error("ServiceInitializers: Error initializing book service:",i),i}}),S.registerInitializer(G.DICTIONARY_SERVICE,async()=>{const{createDictionaryService:i}=await ge(()=>import("./dictionaryService-e2df7278.js"),["assets/dictionaryService-e2df7278.js","assets/index-81c07cf2.js","assets/supabase-215a852a.js","assets/vendor-91e15b2e.js","assets/ui-c2c9966d.js","assets/index-2759b95e.css","assets/supabaseClient-510d7de7.js"]);return i()}),S.registerInitializer(G.AI_SERVICE,async()=>{const{createAIService:i}=await ge(()=>Promise.resolve().then(()=>Ao),void 0);return i()}),S.registerInitializer(G.FEEDBACK_SERVICE,async()=>{const{createFeedbackService:i}=await ge(()=>Promise.resolve().then(()=>ec),void 0);return i()}),S.registerInitializer(G.TRIGGER_SERVICE,async()=>{const{createTriggerService:i}=await ge(()=>Promise.resolve().then(()=>ic),void 0);return i()}),S.registerInitializer(G.STATISTICS_SERVICE,async()=>{const{createStatisticsService:i}=await ge(()=>Promise.resolve().then(()=>ac),void 0);return i()}),S.registerInitializer(G.CONSULTANT_SERVICE,async()=>{const{createConsultantService:i}=await ge(()=>import("./consultantService-95185daa.js"),["assets/consultantService-95185daa.js","assets/index-81c07cf2.js","assets/supabase-215a852a.js","assets/vendor-91e15b2e.js","assets/ui-c2c9966d.js","assets/index-2759b95e.css","assets/supabaseClient-510d7de7.js"]);return i()}),S.registerInitializer(G.INTERACTION_SERVICE,async()=>{const{createInteractionService:i}=await ge(()=>Promise.resolve().then(()=>lc),void 0);return i()}),S.registerInitializer(G.MONITORING_SERVICE,async()=>{const{createMonitoringService:i}=await ge(()=>Promise.resolve().then(()=>gc),void 0);return i()}),S.registerInitializer(G.DATABASE_SERVICE,async()=>{const{createDatabaseService:i}=await ge(()=>Promise.resolve().then(()=>pc),void 0);return i()}),S.registerInitializer(G.ANALYTICS_SERVICE,async()=>{const{createAnalyticsService:i}=await ge(()=>Promise.resolve().then(()=>mc),void 0);return i()}),S.registerInitializer(G.SAMPLE_SERVICE,async()=>{const{createSampleService:i}=await ge(()=>import("./sampleService-595fc49c.js"),["assets/sampleService-595fc49c.js","assets/index-81c07cf2.js","assets/supabase-215a852a.js","assets/vendor-91e15b2e.js","assets/ui-c2c9966d.js","assets/index-2759b95e.css","assets/supabaseClient-510d7de7.js"]);return i()}),a("ServiceInitializers","All service initializers registered successfully","success")}function Gt(){console.log("ServiceInitializers: initializeServices called, initialized =",St),St?console.log("ServiceInitializers: Services already initialized"):(console.log("ServiceInitializers: Calling registerServiceInitializers"),qs(),console.log("ServiceInitializers: Service initializers registered"),St=!0,console.log("ServiceInitializers: Services initialized successfully"))}function Dr(){return St}async function Xc(i){try{return St||Gt(),await S.getService(i)}catch(t){const r=t instanceof ne?t:new ne(`Failed to initialize service "${i}": ${t instanceof Error?t.message:String(t)}`,Fe.SERVICE_INITIALIZATION_ERROR,{serviceName:i,originalError:t});throw a("ServiceInitializers",r.message,"error"),r}}async function el(i){try{St||Gt(),await Promise.all(i.map(t=>S.getService(t)))}catch(t){const r=t instanceof ne?t:new ne(`Failed to initialize services: ${t instanceof Error?t.message:String(t)}`,Fe.SERVICE_INITIALIZATION_ERROR,{originalError:t});throw a("ServiceInitializers",r.message,"error"),r}}Gt();const tl=Object.freeze(Object.defineProperty({__proto__:null,initializeService:Xc,initializeServices:Gt,initializeServices2:el,isInitialized:Dr,registerServiceInitializers:qs},Symbol.toStringTag,{value:"Module"}));function Ge(i){const[t,r]=g.useState(null),[n,s]=g.useState(!0),[o,c]=g.useState(null),[d,h]=g.useState(Dr());return g.useEffect(()=>{let u=!0;return(async()=>{try{if(Dr()||(a("useService",`Registering service initializers for ${i}`,"info"),Gt(),u&&h(!0)),u){a("useService",`Getting service ${i}`,"info");const x=await S.getService(i);u&&r(x)}}catch(x){if(u){const k=x instanceof Error?x:new Error(String(x));a("useService",`Error getting service ${i}: ${k.message}`,"error"),c(k)}}finally{u&&s(!1)}})(),()=>{u=!1}},[i]),{service:t,loading:n,error:o,initialized:d}}function lr(){return Ge(G.BOOK_SERVICE)}function rl(){return Ge(G.AI_SERVICE)}function il(){return Ge(G.TRIGGER_SERVICE)}function nl(){return Ge(G.STATISTICS_SERVICE)}function Gs(){return Ge(G.CONSULTANT_SERVICE)}function sl(){return Ge(G.MONITORING_SERVICE)}function Hs(){return Ge(G.DICTIONARY_SERVICE)}function Ys(){return Ge(G.AUTH_SERVICE)}function Ae(){return Ge(G.ANALYTICS_SERVICE)}function He(i){const{service:t}=Ae(),r=g.useRef(performance.now()),n=g.useRef(null);return g.useEffect(()=>{const s=performance.now()-r.current;if(n.current=s,i.trackRender&&t&&t.trackPerformance("render_time",s,{component:i.componentName}),i.trackPageLoad&&t&&window.performance&&window.performance.timing){const o=window.performance.timing,c=o.loadEventEnd-o.navigationStart;c>0&&t.trackPerformance("page_load",c,{page:i.componentName})}return()=>{const o=performance.now()-r.current;t&&t.trackPerformance("component_lifetime",o,{component:i.componentName})}},[i.componentName,i.trackPageLoad,i.trackRender,t]),{trackInteraction:(s,o)=>{const c=performance.now()-o;return t&&t.trackPerformance("interaction",c,{component:i.componentName,interaction:s}),c},trackApiCall:(s,o)=>{const c=performance.now()-o;return t&&t.trackPerformance("api_call",c,{component:i.componentName,endpoint:s}),c},getRenderTime:()=>n.current}}var ai={},al=H;Object.defineProperty(ai,"__esModule",{value:!0});var nr=ai.default=void 0,ol=al(Y()),cl=e;nr=ai.default=(0,ol.default)((0,cl.jsx)("path",{d:"M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2M6 4h5v8l-2.5-1.5L6 12z"}),"Book");var oi={},ll=H;Object.defineProperty(oi,"__esModule",{value:!0});var It=oi.default=void 0,dl=ll(Y()),ul=e;It=oi.default=(0,dl.default)((0,ul.jsx)("path",{d:"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3M7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5M16 17H8v-2h8zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13"}),"SmartToy");var ci={},gl=H;Object.defineProperty(ci,"__esModule",{value:!0});var Qs=ci.default=void 0,hl=gl(Y()),fl=e;Qs=ci.default=(0,hl.default)((0,fl.jsx)("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4"}),"Person");const Ks="/alice-reader-app-final/assets/alice_book_cover-adb4273e.jpg",Xi=()=>{const i=Et();Lr(i.breakpoints.down("sm"));const{user:t,isVerified:r}=je(),n=st(),{service:s}=Ae();return He({trackPageLoad:!0,trackRender:!0,componentName:"LandingPage"}),g.useEffect(()=>{t&&r&&n("/reader")},[t,r,n]),g.useEffect(()=>{s&&s.trackPageView("landing_page")},[s]),e.jsx(p,{sx:{minHeight:"100vh",backgroundImage:"linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7)), url('https://images.unsplash.com/photo-1543002588-bfa74002ed7e?q=80&w=2730&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D')",backgroundSize:"cover",backgroundPosition:"center",pt:8,pb:6},children:e.jsxs(Ct,{maxWidth:"md",children:[e.jsx(O,{elevation:3,sx:{p:3,mb:6,borderRadius:2,background:"rgba(255, 255, 255, 0.9)",boxShadow:"0 8px 32px rgba(31, 38, 135, 0.15)",backdropFilter:"blur(4px)",border:"1px solid rgba(255, 255, 255, 0.18)"},children:e.jsxs(m,{container:!0,spacing:3,alignItems:"center",children:[e.jsx(m,{item:!0,xs:12,md:4,children:e.jsx(p,{component:"img",src:Ks,alt:"Alice in Wonderland",sx:{width:"100%",height:"auto",borderRadius:2,boxShadow:"0 10px 20px rgba(0,0,0,0.2)",transform:"rotate(-3deg)",mx:"auto",display:"block",maxWidth:{xs:180,sm:220,md:280,lg:320,xl:350}}})}),e.jsxs(m,{item:!0,xs:12,md:8,children:[e.jsx(l,{variant:"h5",component:"h2",gutterBottom:!0,color:"primary.dark",children:"Alice in Wonderland"}),e.jsx(l,{variant:"subtitle1",gutterBottom:!0,color:"text.secondary",children:"By Lewis Carroll"}),e.jsx(l,{variant:"body1",color:"text.primary",sx:{mb:2},children:"Begin your journey down the rabbit hole with Alice! This interactive reading experience brings the classic tale to life with AI-powered assistance and vocabulary building tools."}),e.jsx(z,{variant:"contained",color:"primary",size:"large",onClick:()=>n("/reader"),sx:{mt:2},children:"Start Reading"})]})]})}),e.jsx(l,{variant:"h5",component:"h2",align:"center",gutterBottom:!0,sx:{mb:3},children:"Key Features"}),e.jsxs(m,{container:!0,spacing:3,children:[e.jsx(m,{item:!0,xs:12,md:4,children:e.jsx(We,{sx:{height:"100%",display:"flex",flexDirection:"column",transition:"transform 0.3s","&:hover":{transform:"translateY(-8px)"}},children:e.jsxs(De,{sx:{flexGrow:1,textAlign:"center",p:2},children:[e.jsx(p,{sx:{mb:1},children:e.jsx(nr,{color:"primary",sx:{fontSize:40}})}),e.jsx(l,{variant:"h6",component:"h3",gutterBottom:!0,children:"Interactive Dictionary"}),e.jsx(l,{variant:"body2",children:"Instantly look up any word by simply highlighting it. Build your vocabulary and deepen your understanding of the text."})]})})}),e.jsx(m,{item:!0,xs:12,md:4,children:e.jsx(We,{sx:{height:"100%",display:"flex",flexDirection:"column",transition:"transform 0.3s","&:hover":{transform:"translateY(-8px)"}},children:e.jsxs(De,{sx:{flexGrow:1,textAlign:"center",p:2},children:[e.jsx(p,{sx:{mb:1},children:e.jsx(It,{color:"secondary",sx:{fontSize:40}})}),e.jsx(l,{variant:"h6",component:"h3",gutterBottom:!0,children:"AI Reading Assistant"}),e.jsx(l,{variant:"body2",children:"Ask questions about the text, get explanations, and explore themes with our intelligent AI assistant."})]})})}),e.jsx(m,{item:!0,xs:12,md:4,children:e.jsx(We,{sx:{height:"100%",display:"flex",flexDirection:"column",transition:"transform 0.3s","&:hover":{transform:"translateY(-8px)"}},children:e.jsxs(De,{sx:{flexGrow:1,textAlign:"center",p:2},children:[e.jsx(p,{sx:{mb:1},children:e.jsx(Qs,{color:"info",sx:{fontSize:40}})}),e.jsx(l,{variant:"h6",component:"h3",gutterBottom:!0,children:"Reading Consultant"}),e.jsx(l,{variant:"body2",children:"Get personalized guidance from reading consultants who can help you navigate difficult passages."})]})})})]}),e.jsxs(p,{sx:{textAlign:"center",mt:6,p:3,borderRadius:2,background:i.palette.primary.main,color:"white"},children:[e.jsx(l,{variant:"h6",component:"p",gutterBottom:!0,children:"Ready to transform your reading experience?"}),e.jsx(z,{component:re,to:"/register",variant:"contained",size:"large",color:"secondary",sx:{mt:2,px:4},children:"Get Started Now"})]}),e.jsx(p,{sx:{mt:6,pt:3,borderTop:`1px solid ${i.palette.divider}`},children:e.jsxs(l,{variant:"body2",color:"text.secondary",align:"center",children:["© ",new Date().getFullYear()," Alice Reader. All rights reserved."]})})]})})},pl=()=>e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",p:2,background:"linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)"},children:e.jsxs(O,{elevation:6,sx:{p:6,borderRadius:4,textAlign:"center",maxWidth:"600px",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:[e.jsx(l,{variant:"h3",gutterBottom:!0,sx:{fontWeight:"bold",color:"primary.main"},children:"Welcome to Alice Reader!"}),e.jsx(l,{variant:"h6",color:"text.secondary",sx:{mb:4},children:"You're all set to begin your journey. Verify your book to start reading."}),e.jsx(z,{component:re,to:"/verify",variant:"contained",color:"primary",size:"large",sx:{fontWeight:"bold",px:5,py:1.5,borderRadius:"25px",transition:"transform 0.2s","&:hover":{transform:"scale(1.05)"}},children:"Verify Your Book"})]})}),en=()=>{const i=st(),t=Ft(),{signIn:r,user:n,isVerified:s}=je(),{service:o}=Ae(),{service:c}=Gs(),[d,h]=g.useState(""),[u,f]=g.useState(""),[x,k]=g.useState(null),[v,E]=g.useState(!1),[b,w]=g.useState(null);He({trackPageLoad:!0,trackRender:!0,componentName:"LoginPage"}),g.useEffect(()=>{n&&i(s?"/reader/interaction":"/verify")},[n,s,i]),g.useEffect(()=>{if(t.state&&t.state.message){w(t.state.message);const D=setTimeout(()=>w(null),5e3);return()=>clearTimeout(D)}},[t.state]),g.useEffect(()=>{o&&o.trackPageView("login_page")},[o]);const _=async D=>{if(D.preventDefault(),!d.trim()||!u.trim()){k("Please enter both email and password");return}E(!0),k(null);try{console.log("LoginPage: Attempting login with email:",d);const I=performance.now(),{error:L,user:T}=await r(d,u);if(L)throw console.error("LoginPage: Login error:",L),L;if(console.log("LoginPage: Login successful, user:",T),console.log("LoginPage: Verification status:",s),o&&o.trackEvent("login_attempt",{success:!0,timeToComplete:performance.now()-I}),w("Login successful!"),c&&T)try{await c.logConsultantAction(T.id,"LOGIN",{email:T.email}),console.log("LoginPage: Login event logged successfully.")}catch(B){console.error("LoginPage: Failed to log login event:",B)}await new Promise(B=>setTimeout(B,1e3)),s?(console.log("LoginPage: User is verified, navigating to interaction page"),i("/reader/interaction")):(console.log("LoginPage: User is not verified, navigating to verification page"),i("/verify"))}catch(I){console.error("LoginPage: Login failed:",I),k(I.message||"Login failed. Please check your credentials."),o&&o.trackEvent("login_attempt",{success:!1,error:I.message})}finally{E(!1)}};return e.jsx(Ct,{maxWidth:"sm",children:e.jsx(p,{sx:{mt:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(O,{elevation:3,sx:{p:4,width:"100%",borderRadius:2},children:[e.jsx(l,{component:"h1",variant:"h4",align:"center",gutterBottom:!0,children:"Welcome Back"}),e.jsx(l,{variant:"body1",align:"center",color:"text.secondary",sx:{mb:3},children:"Sign in to continue your reading journey"}),x&&e.jsx(fe,{severity:"error",sx:{mb:3},children:x}),b&&e.jsx(fe,{severity:"success",sx:{mb:3},children:b}),e.jsxs(p,{component:"form",onSubmit:_,noValidate:!0,children:[e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:d,onChange:D=>h(D.target.value),error:!!x&&!d.trim()}),e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:"password",id:"password",autoComplete:"current-password",value:u,onChange:D=>f(D.target.value),error:!!x&&!u.trim()}),e.jsx(z,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.5},disabled:v,children:v?e.jsx(le,{size:24}):"Sign In"}),e.jsx(p,{sx:{mt:2,textAlign:"center"},children:e.jsx(yt,{component:re,to:"/forgot-password",variant:"body2",children:"Forgot password?"})}),e.jsx(p,{sx:{mt:3,textAlign:"center"},children:e.jsxs(l,{variant:"body2",children:["Don't have an account?"," ",e.jsx(yt,{component:re,to:"/register",children:"Sign Up"})]})})]})]})})})},xl=i=>{if(!i)return{score:0,feedback:"Password is required"};let t=0,r="";return i.length>=8&&(t+=1),i.length>=12&&(t+=1),/[A-Z]/.test(i)&&(t+=1),/[a-z]/.test(i)&&(t+=1),/[0-9]/.test(i)&&(t+=1),/[^A-Za-z0-9]/.test(i)&&(t+=1),t<3?r="Weak password. Try adding numbers, symbols, and mixed case letters.":t<5?r="Moderate password. Consider making it longer or more complex.":r="Strong password!",{score:Math.min(t,5),feedback:r}},ml=()=>{const i=st(),t=Ft(),{signUp:r,user:n}=je(),{service:s}=Ae(),[o,c]=g.useState(""),[d,h]=g.useState(""),[u,f]=g.useState(""),[x,k]=g.useState(""),[v,E]=g.useState(""),[b,w]=g.useState(!1),[_,D]=g.useState(0),[I,L]=g.useState(null),[T,B]=g.useState(!1),[F,y]=g.useState({score:0,feedback:""});He({trackPageLoad:!0,trackRender:!0,componentName:"RegisterPage"}),g.useEffect(()=>{var R;n&&!((R=t.state)!=null&&R.fromRegistration)&&i("/verify")},[n,i,t.state]),g.useEffect(()=>{s&&s.trackPageView("register_page")},[s]),g.useEffect(()=>{y(xl(d))},[d]);const M=()=>{if(_===0){if(!o||!d||!u){L("Please fill in all required fields");return}if(d!==u){L("Passwords do not match");return}if(F.score<3){L("Please use a stronger password");return}}L(null),D(R=>R+1)},U=()=>{D(R=>R-1),L(null)},C=async R=>{if(R.preventDefault(),!x||!v||!b){L("Please fill in all required fields and agree to the terms");return}B(!0),L(null);try{console.log("RegisterPage: Starting signup process with:",{email:o,firstName:x,lastName:v});const W=performance.now(),{error:Q,user:ie}=await r(o,d,x,v);if(Q)throw console.error("RegisterPage: Signup error:",Q),Q;console.log("RegisterPage: Signup successful, user:",ie),s&&s.trackEvent("registration_complete",{success:!0,timeToComplete:performance.now()-W}),console.log("RegisterPage: Navigating to verification page"),i("/verify",{state:{message:"Registration successful! Please verify your book to continue.",fromRegistration:!0,firstName:x,lastName:v,email:o,userId:ie==null?void 0:ie.id},replace:!0}),console.log("RegisterPage: Navigation to verification page initiated")}catch(W){L(W.message||"Registration failed. Please try again."),s&&s.trackEvent("registration_attempt",{success:!1,error:W.message})}finally{B(!1)}},$=()=>{const{score:R}=F;return R<3?"error":R<5?"warning":"success"};return e.jsx(Ct,{maxWidth:"sm",children:e.jsx(p,{sx:{mt:8,mb:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(O,{elevation:3,sx:{p:4,width:"100%",borderRadius:2},children:[e.jsx(l,{component:"h1",variant:"h4",align:"center",gutterBottom:!0,children:"Create Your Account"}),e.jsx(l,{variant:"body1",align:"center",color:"text.secondary",sx:{mb:4},children:"Join Alice Reader to begin your interactive reading journey"}),e.jsxs(sn,{activeStep:_,sx:{mb:4},children:[e.jsx(Lt,{children:e.jsx(Bt,{children:"Account Details"})}),e.jsx(Lt,{children:e.jsx(Bt,{children:"Personal Information"})})]}),I&&e.jsx(fe,{severity:"error",sx:{mb:3},children:I}),e.jsxs(p,{component:"form",onSubmit:_===1?C:M,noValidate:!0,children:[_===0?e.jsxs(e.Fragment,{children:[e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:o,onChange:R=>c(R.target.value),error:!!I&&!o}),e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,name:"password",label:"Password",type:"password",id:"password",autoComplete:"new-password",value:d,onChange:R=>h(R.target.value),error:!!I&&(!d||F.score<3),helperText:d?F.feedback:"Password is required",FormHelperTextProps:{sx:{color:$()}}}),e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,name:"confirmPassword",label:"Confirm Password",type:"password",id:"confirmPassword",autoComplete:"new-password",value:u,onChange:R=>f(R.target.value),error:!!I&&(!u||d!==u),helperText:u&&d!==u?"Passwords do not match":""}),e.jsx(z,{type:"button",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.5},onClick:M,children:"Next"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,sm:6,children:e.jsx(ve,{required:!0,fullWidth:!0,id:"firstName",label:"First Name",name:"firstName",autoComplete:"given-name",value:x,onChange:R=>k(R.target.value),error:!!I&&!x})}),e.jsx(m,{item:!0,xs:12,sm:6,children:e.jsx(ve,{required:!0,fullWidth:!0,id:"lastName",label:"Last Name",name:"lastName",autoComplete:"family-name",value:v,onChange:R=>E(R.target.value),error:!!I&&!v})})]}),e.jsx(rr,{control:e.jsx(Aa,{checked:b,onChange:R=>w(R.target.checked),color:"primary"}),label:e.jsxs(l,{variant:"body2",children:["I agree to the"," ",e.jsx(yt,{component:re,to:"/terms",children:"Terms of Service"})," ","and"," ",e.jsx(yt,{component:re,to:"/privacy",children:"Privacy Policy"})]}),sx:{mt:2}}),e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",mt:3},children:[e.jsx(z,{type:"button",variant:"outlined",onClick:U,sx:{py:1.5,px:3},children:"Back"}),e.jsx(z,{type:"submit",variant:"contained",sx:{py:1.5,px:3},disabled:T||!b,children:T?e.jsx(le,{size:24}):"Create Account"})]})]}),e.jsx(p,{sx:{mt:3,textAlign:"center"},children:e.jsxs(l,{variant:"body2",children:["Already have an account?"," ",e.jsx(yt,{component:re,to:"/login",children:"Sign In"})]})})]})]})})})},vl=()=>{const i=st(),t=Ft(),{user:r,isVerified:n,setIsVerified:s,verifyBook:o}=je(),{service:c}=Ae(),[d,h]=g.useState(""),[u,f]=g.useState(""),[x,k]=g.useState(""),[v,E]=g.useState(""),[b,w]=g.useState(null),[_,D]=g.useState(null),[I,L]=g.useState(!1),[T,B]=g.useState(null),[F,y]=g.useState(!1),[M,U]=g.useState(0);He({trackPageLoad:!0,trackRender:!0,componentName:"VerifyPage"}),g.useEffect(()=>{var R;const $=(R=t.state)==null?void 0:R.fromRegistration;console.log("VerifyPage: Initial auth check - user:",!!r,"isVerified:",n,"fromRegistration:",$),!$&&r&&n?(console.log("VerifyPage: User already verified, redirecting to reader interaction page"),i("/reader/interaction",{replace:!0})):!r&&!$?(console.log("VerifyPage: No user found, redirecting to login"),i("/login",{replace:!0})):console.log("VerifyPage: User needs verification or coming from registration, staying on page")},[r,n,i,t.state]),g.useEffect(()=>{var $;($=t.state)!=null&&$.fromRegistration&&(f(t.state.firstName||""),k(t.state.lastName||""),E(t.state.email||""),w(t.state.userId||null),i(".",{replace:!0,state:{...t.state,fromRegistration:!1}}))},[t.state,i]),g.useEffect(()=>{if(t.state&&t.state.message){B(t.state.message);const $=setTimeout(()=>B(null),5e3);return()=>clearTimeout($)}},[t.state]),g.useEffect(()=>{c&&c.trackPageView("verify_page")},[c]),g.useEffect(()=>{n&&r&&(console.log("VerifyPage: isVerified changed to true, redirecting to reader interaction page"),i("/reader/interaction",{replace:!0}))},[n,r,i]);const C=async $=>{if($.preventDefault(),!d.trim()){D("Please enter your verification code");return}if(!u.trim()){D("Please enter your first name");return}if(!x.trim()){D("Please enter your last name");return}L(!0),D(null);try{console.log("VerifyPage: Starting verification with:",{verificationCode:d,firstName:u,lastName:x});const R=performance.now();console.log("VerifyPage: About to call verifyBook");const{error:W,success:Q}=await o(d,u,x);if(console.log("VerifyPage: verifyBook call completed with result:",{error:W,success:Q}),W)throw console.error("VerifyPage: Verification error:",W),W;c&&c.trackEvent("book_verification",{success:!0,timeToComplete:performance.now()-R}),console.log("VerifyPage: Updating UI state after successful verification"),y(!0),B("Verification successful! Redirecting to your dashboard..."),console.log("VerifyPage: Setting isVerified to true locally"),s(!0),U(1),console.log("VerifyPage: Setting up redirect to reader interaction page"),setTimeout(()=>{console.log("VerifyPage: Executing redirect to reader interaction page"),i("/reader/interaction",{replace:!0})},1e3)}catch(R){console.error("VerifyPage: Verification failed:",R),D(R.message||"Verification failed. Please check your code and try again."),c&&c.trackEvent("book_verification",{success:!1,error:R.message})}finally{L(!1)}};return e.jsx(Ct,{maxWidth:"sm",children:e.jsx(p,{sx:{mt:8,mb:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(O,{elevation:3,sx:{p:4,width:"100%",borderRadius:2},children:[e.jsx(l,{component:"h1",variant:"h4",align:"center",gutterBottom:!0,children:"Verify Your Book"}),e.jsx(l,{variant:"body1",align:"center",color:"text.secondary",sx:{mb:4},children:"Enter the verification code from your physical copy of Alice in Wonderland"}),_&&e.jsx(fe,{severity:"error",sx:{mb:3},children:_}),T&&e.jsx(fe,{severity:"success",sx:{mb:3},children:T}),e.jsxs(sn,{activeStep:M,orientation:"vertical",sx:{mb:4},children:[e.jsxs(Lt,{children:[e.jsx(Bt,{children:"Enter Verification Code"}),e.jsx(fr,{children:e.jsxs(p,{component:"form",onSubmit:C,noValidate:!0,children:[e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,id:"verificationCode",label:"Verification Code",name:"verificationCode",autoComplete:"off",autoFocus:!0,value:d,onChange:$=>h($.target.value.toUpperCase()),error:!!_&&!d.trim(),placeholder:"e.g. BETA001",inputProps:{style:{textTransform:"uppercase",letterSpacing:"0.1em"}},disabled:I||F}),e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,id:"firstName",label:"First Name",name:"firstName",value:u,onChange:$=>f($.target.value),error:!!_&&!u.trim(),disabled:I||F}),e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,id:"lastName",label:"Last Name",name:"lastName",value:x,onChange:$=>k($.target.value),error:!!_&&!x.trim(),disabled:I||F}),e.jsx(l,{variant:"body2",color:"text.secondary",sx:{mt:1,mb:3},children:"The verification code can be found on the inside cover of your book or on your purchase receipt."}),e.jsx(z,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:1,mb:2,py:1.5},disabled:I||F,children:I?e.jsx(le,{size:24}):"Verify Book"})]})})]}),e.jsxs(Lt,{children:[e.jsx(Bt,{children:"Verification Complete"}),e.jsx(fr,{children:e.jsxs(p,{sx:{py:2},children:[e.jsx(Ra,{in:M===1,children:e.jsxs(p,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(bt,{color:"success",sx:{fontSize:40,mr:2}}),e.jsx(l,{variant:"h6",children:"Book Successfully Verified!"})]})}),e.jsx(l,{variant:"body1",children:"Your copy of Alice in Wonderland has been verified. You now have full access to all interactive features."})]})})]}),e.jsxs(Lt,{children:[e.jsx(Bt,{children:"Preparing Your Experience"}),e.jsx(fr,{children:e.jsxs(p,{sx:{py:2},children:[e.jsx(l,{variant:"body1",paragraph:!0,children:"Setting up your personalized reading experience..."}),e.jsxs(p,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(tt,{label:"Dictionary Service",color:"success"}),e.jsx(tt,{label:"AI Assistant",color:"success"}),e.jsx(tt,{label:"Reading Progress",color:"success"}),e.jsx(tt,{label:"Consultant Support",color:"success"})]})]})})]})]}),e.jsx(he,{sx:{my:3}}),e.jsxs(p,{sx:{mt:2},children:[e.jsxs(l,{variant:"body2",color:"text.secondary",paragraph:!0,children:[e.jsx("strong",{children:"Note:"})," By verifying your book, you agree that your reading progress and interactions may be monitored by our reading consultants to provide personalized assistance when needed."]}),e.jsx(l,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Your privacy is important to us. All data is handled according to our Privacy Policy."})]}),e.jsx(he,{sx:{my:3}})]})})})},yl=()=>{const{service:i,loading:t}=Ys(),{service:r}=Ae(),[n,s]=g.useState(""),[o,c]=g.useState(null),[d,h]=g.useState(null),[u,f]=g.useState(!1);He({trackPageLoad:!0,trackRender:!0,componentName:"ForgotPasswordPage"}),g.useEffect(()=>{r&&r.trackPageView("forgot_password_page")},[r]);const x=async k=>{if(k.preventDefault(),!n.trim()){c("Please enter your email address");return}if(!i){c("Authentication service not available");return}f(!0),c(null),h(null);try{const v=performance.now(),{error:E}=await i.resetPassword(n);if(E)throw E;h("Password reset instructions have been sent to your email."),r&&r.trackEvent("password_reset_request",{success:!0,timeToComplete:performance.now()-v})}catch(v){c(v.message||"Failed to send password reset email. Please try again."),r&&r.trackEvent("password_reset_request",{success:!1,error:v.message})}finally{f(!1)}};return t?e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(le,{})}):e.jsx(Ct,{maxWidth:"sm",children:e.jsx(p,{sx:{mt:8,display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsxs(O,{elevation:3,sx:{p:4,width:"100%",borderRadius:2},children:[e.jsx(l,{component:"h1",variant:"h4",align:"center",gutterBottom:!0,children:"Reset Password"}),e.jsx(l,{variant:"body1",align:"center",color:"text.secondary",sx:{mb:3},children:"Enter your email address and we'll send you instructions to reset your password"}),o&&e.jsx(fe,{severity:"error",sx:{mb:3},children:o}),d&&e.jsx(fe,{severity:"success",sx:{mb:3},children:d}),e.jsxs(p,{component:"form",onSubmit:x,noValidate:!0,children:[e.jsx(ve,{margin:"normal",required:!0,fullWidth:!0,id:"email",label:"Email Address",name:"email",autoComplete:"email",autoFocus:!0,value:n,onChange:k=>s(k.target.value),error:!!o&&!n.trim(),disabled:!!d}),e.jsx(z,{type:"submit",fullWidth:!0,variant:"contained",sx:{mt:3,mb:2,py:1.5},disabled:u||!!d,children:u?e.jsx(le,{size:24}):"Reset Password"}),e.jsx(p,{sx:{mt:3,textAlign:"center"},children:e.jsxs(l,{variant:"body2",children:["Remember your password?"," ",e.jsx(yt,{component:re,to:"/login",children:"Sign In"})]})})]})]})})})};var li={},bl=H;Object.defineProperty(li,"__esModule",{value:!0});var Zs=li.default=void 0,Sl=bl(Y()),wl=e;Zs=li.default=(0,Sl.default)((0,wl.jsx)("path",{d:"M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2"}),"Bookmark");var di={},jl=H;Object.defineProperty(di,"__esModule",{value:!0});var Js=di.default=void 0,_l=jl(Y()),kl=e;Js=di.default=(0,_l.default)((0,kl.jsx)("path",{d:"M10 20h4V4h-4zm-6 0h4v-8H4zM16 9v11h4V9z"}),"Equalizer");var ui={},Il=H;Object.defineProperty(ui,"__esModule",{value:!0});var Xs=ui.default=void 0,El=Il(Y()),Cl=e;Xs=ui.default=(0,El.default)((0,Cl.jsx)("path",{d:"m22 10-6-6H4c-1.1 0-2 .9-2 2v12.01c0 1.1.9 1.99 2 1.99l16-.01c1.1 0 2-.89 2-1.99zm-7-4.5 5.5 5.5H15z"}),"Note");var gi={},Al=H;Object.defineProperty(gi,"__esModule",{value:!0});var ea=gi.default=void 0,Rl=Al(Y()),Tl=e;ea=gi.default=(0,Rl.default)((0,Tl.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 17h-2v-2h2zm2.07-7.75-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25"}),"Help");var hi={},Pl=H;Object.defineProperty(hi,"__esModule",{value:!0});var fi=hi.default=void 0,$l=Pl(Y()),Ol=e;fi=hi.default=(0,$l.default)((0,Ol.jsx)("path",{d:"M9 1h6v2H9zm10.03 6.39 1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61M13 14h-2V8h2z"}),"Timer");var pi={},Dl=H;Object.defineProperty(pi,"__esModule",{value:!0});var xi=pi.default=void 0,zl=Dl(Y()),Ml=e;xi=pi.default=(0,zl.default)((0,Ml.jsx)("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"}),"CalendarToday");var mi={},Ll=H;Object.defineProperty(mi,"__esModule",{value:!0});var vi=mi.default=void 0,Bl=Ll(Y()),Ul=e;vi=mi.default=(0,Bl.default)((0,Ul.jsx)("path",{d:"m16 6 2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"}),"TrendingUp");var yi={},Nl=H;Object.defineProperty(yi,"__esModule",{value:!0});var Vt=yi.default=void 0,Vl=Nl(Y()),Fl=e;Vt=yi.default=(0,Vl.default)((0,Fl.jsx)("path",{d:"m19 9 1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25z"}),"AutoAwesome");const $e="RealtimeService";let sr=null,wt=null;const Wl=async()=>{if(sr){a($e,"Realtime service already initialized.","info");return}try{sr=await A(),a($e,"Supabase client obtained for realtime service.","success")}catch(i){a($e,"Failed to get Supabase client for realtime service.","error",i)}},ql=(i,t)=>{if(!sr){a($e,"Supabase client not initialized. Cannot subscribe.","error");return}wt&&(a($e,"Already subscribed to AI interaction prompts. Unsubscribing existing channel.","info"),wt.unsubscribe()),a($e,`Subscribing to AI interaction prompts for user: ${i}`,"info"),wt=sr.channel(`ai_prompts_for_user_${i}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"interactions",filter:`user_id=eq.${i}`},r=>{const n=r.new;n.event_type==="ai_prompt_sent"&&(a($e,"Received new AI prompt:","info",n),t(n))}).subscribe(r=>{a($e,`Realtime channel status for AI prompts: ${r}`,"info"),r==="CHANNEL_ERROR"&&a($e,"Realtime channel error for AI prompts.","error")})},tn=()=>{wt&&(a($e,"Unsubscribing from AI interaction prompts.","info"),wt.unsubscribe(),wt=null)},ta=g.createContext(void 0),Gl=({children:i})=>{const{user:t,isAuthenticated:r,isVerified:n}=je(),[s,o]=g.useState(null);g.useEffect(()=>(r&&n&&(t!=null&&t.id)?(a("AIPromptContext",`Attempting to subscribe to AI prompts for user ${t.id}`,"info"),ql(t.id,d=>{a("AIPromptContext","Received AI prompt payload:","info",d),o(d.content)})):(a("AIPromptContext","User not authenticated or verified, unsubscribing from AI prompts.","info"),tn()),()=>{tn()}),[r,n,t==null?void 0:t.id]);const c=()=>{o(null)};return e.jsx(ta.Provider,{value:{latestPrompt:s,clearPrompt:c},children:i})},Hl=()=>{const i=g.useContext(ta);if(i===void 0)throw new Error("useAIPrompt must be used within an AIPromptProvider");return i},Yl=()=>{console.log("ReaderDashboard: Rendering component");const i=st(),{service:t,loading:r}=lr(),{loading:n}=Ys(),{service:s}=Ae(),{user:o,profile:c}=je(),{latestPrompt:d,clearPrompt:h}=Hl(),[u,f]=g.useState(null),[x,k]=g.useState(!0),[v,E]=g.useState(null),[b,w]=g.useState(null),[_,D]=g.useState(null),[I,L]=g.useState(!0);He({trackPageLoad:!0,trackRender:!0,componentName:"ReaderDashboard"}),g.useEffect(()=>{if(console.log("ReaderDashboard: useEffect triggered",{hasBookService:!!t,hasUser:!!o,userId:o==null?void 0:o.id}),!t||!o){console.log("ReaderDashboard: Missing bookService or user, skipping data load");return}(async()=>{console.log("ReaderDashboard: Starting to load data");try{console.log("ReaderDashboard: Fetching book data");const M=await t.getBook("alice-in-wonderland");console.log("ReaderDashboard: Book data received",M),f(M),s&&(console.log("ReaderDashboard: Tracking page view"),s.trackPageView("reader_dashboard",{userId:o.id,bookId:"alice-in-wonderland"}))}catch(M){console.error("ReaderDashboard: Error loading data:",M),E(M instanceof Error?M.message:"An error occurred while loading data")}finally{console.log("ReaderDashboard: Finished loading data, setting loading to false"),k(!1)}})()},[t,o,s]),g.useEffect(()=>{if(!o)return;(async()=>{try{console.log("ReaderDashboard: Loading reading progress and stats");const M=await qo(o.id,it);if(M.data){const C={section_id:M.data.section_id,last_position:M.data.last_position,last_read_at:M.data.last_read_at||new Date().toISOString(),section_title:M.data.section_title,section_number:M.data.section_number,page_number:M.data.page_number};w(C)}const U=await Go(o.id,it);U.data&&D(U.data),console.log("ReaderDashboard: Progress and stats loaded",{hasProgress:!!M.data,hasStats:!!U.data})}catch(M){console.error("ReaderDashboard: Error loading progress data:",M)}finally{L(!1)}})()},[o]);const T=()=>{if(!_)return 0;const y=200;return Math.min(_.pages_read/y*100,100)},B=y=>{if(y<60)return`${y}min`;const M=Math.floor(y/60),U=y%60;return`${M}h ${U}min`},F=()=>b?new Date(b.last_read_at).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):null;return n||r||x?(console.log("ReaderDashboard: Showing loading state"),e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(le,{})})):v?(console.log("ReaderDashboard: Showing error state:",v),e.jsx(p,{sx:{p:3,maxWidth:"1200px",mx:"auto"},children:e.jsxs(O,{sx:{p:4,borderRadius:2,textAlign:"center"},children:[e.jsx(l,{variant:"h5",color:"error",gutterBottom:!0,children:"Something went wrong"}),e.jsx(l,{variant:"body1",paragraph:!0,children:v}),e.jsx(z,{variant:"contained",onClick:()=>window.location.reload(),children:"Reload Page"})]})})):u?e.jsxs(p,{sx:{p:3,maxWidth:"1200px",mx:"auto"},children:[e.jsxs(p,{sx:{mb:5},children:[e.jsxs(l,{variant:"h3",gutterBottom:!0,sx:{fontWeight:"bold"},children:["Welcome back, ",(c==null?void 0:c.first_name)||"Reader","!"]}),e.jsx(l,{variant:"h6",color:"text.secondary",children:"Your reading companion for Alice in Wonderland"}),b&&e.jsxs(l,{variant:"body1",sx:{mt:2},children:["Last read: ",F()]})]}),e.jsxs(m,{container:!0,spacing:4,children:[e.jsxs(m,{item:!0,xs:12,md:9,children:[!I&&b&&e.jsxs(O,{elevation:2,sx:{p:3,mb:4,borderRadius:2},children:[e.jsxs(l,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(vi,{sx:{mr:1,color:"primary.main"}}),"Your Reading Progress"]}),e.jsxs(p,{sx:{mb:3},children:[e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Overall Progress"}),e.jsxs(l,{variant:"body2",color:"text.secondary",children:[T().toFixed(1),"%"]})]}),e.jsx(jr,{variant:"determinate",value:T(),sx:{height:8,borderRadius:4}})]}),e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(We,{variant:"outlined",sx:{textAlign:"center",p:2},children:[e.jsx(fi,{color:"primary",sx:{mb:1}}),e.jsx(l,{variant:"h6",children:_?B(_.total_reading_time):"0min"}),e.jsx(l,{variant:"caption",color:"text.secondary",children:"Reading Time"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(We,{variant:"outlined",sx:{textAlign:"center",p:2},children:[e.jsx(_t,{color:"primary",sx:{mb:1}}),e.jsx(l,{variant:"h6",children:_?_.pages_read:0}),e.jsx(l,{variant:"caption",color:"text.secondary",children:"Pages Read"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(We,{variant:"outlined",sx:{textAlign:"center",p:2},children:[e.jsx(xi,{color:"primary",sx:{mb:1}}),e.jsx(l,{variant:"h6",children:_?_.sessions_count:0}),e.jsx(l,{variant:"caption",color:"text.secondary",children:"Reading Sessions"})]})})]})]}),!I&&b&&e.jsxs(O,{elevation:2,sx:{p:3,mb:4,borderRadius:2},children:[e.jsxs(l,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(Vt,{sx:{mr:1,color:"primary.main"}}),"Continue Reading"]}),e.jsxs(p,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(tt,{label:`Section ${b.section_number||"Unknown"}`,color:"primary",variant:"outlined",sx:{mr:2}}),e.jsxs(l,{variant:"body2",color:"text.secondary",children:["Last read: ",F()]})]}),e.jsx(z,{variant:"contained",size:"large",onClick:()=>i("/reader/interaction"),sx:{mt:2},children:"Resume Reading"})]}),e.jsx(O,{elevation:3,sx:{borderRadius:2,overflow:"hidden",mb:4,textAlign:"center",p:0},children:e.jsxs(p,{sx:{p:0,display:"flex",flexDirection:{xs:"column",sm:"row"},height:{sm:"300px"}},children:[e.jsx(p,{sx:{width:{xs:"100%",sm:"200px"},height:{xs:"200px",sm:"100%"},position:"relative",overflow:"hidden"},children:e.jsx(p,{component:"img",src:Ks,alt:(u==null?void 0:u.title)||"Alice in Wonderland",sx:{width:"100%",height:"100%",objectFit:"cover"}})}),e.jsxs(p,{sx:{p:3,flex:1,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",textAlign:"center"},children:[e.jsx(l,{variant:"h5",gutterBottom:!0,children:(u==null?void 0:u.title)||"Alice's Adventures in Wonderland"}),e.jsxs(l,{variant:"subtitle1",gutterBottom:!0,children:["By ",(u==null?void 0:u.author)||"Lewis Carroll"]}),e.jsx(he,{sx:{my:2,width:"100%"}}),e.jsx(l,{variant:"body1",sx:{mb:3},children:b?"Continue your reading journey with your AI companion by your side.":"Ready to start your reading journey? Sync with your physical book to get contextual help, definitions, and AI assistance."}),e.jsx(z,{onClick:()=>{console.log("ReaderDashboard: Navigating to reader page"),i("/reader/interaction")},variant:"contained",color:"primary",size:"large",startIcon:e.jsx(_t,{}),sx:{py:2,px:5,fontSize:"1.2rem",fontWeight:"bold",minWidth:"280px",boxShadow:4,mt:2,borderRadius:2,"&:hover":{transform:"translateY(-2px)",boxShadow:6},transition:"all 0.2s"},children:b?"Continue Reading":"Start Reading"})]})]})}),e.jsxs(O,{sx:{p:3,borderRadius:2,mb:4},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"How to Use Your Reading Companion"}),e.jsx(l,{variant:"body1",paragraph:!0,children:"The Alice Reader App is designed to enhance your experience with the physical book, not replace it."}),e.jsx(nt,{children:["Tell us what page you're on in your physical copy of Alice in Wonderland","Get contextual information about characters, themes, and plot points","Look up definitions for unfamiliar words by highlighting text","Ask the AI assistant questions about what you're reading"].map((y,M)=>e.jsxs(Oe,{children:[e.jsx(we,{sx:{minWidth:"36px"},children:e.jsx(p,{sx:{width:24,height:24,borderRadius:"50%",bgcolor:"primary.main",color:"white",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.8rem",fontWeight:"bold"},children:M+1})}),e.jsx(ee,{primary:y})]},M))})]})]}),e.jsxs(m,{item:!0,xs:12,md:3,children:[e.jsxs(O,{sx:{p:3,borderRadius:2,mb:4},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsxs(_r,{spacing:2,children:[e.jsx(z,{variant:"outlined",fullWidth:!0,startIcon:e.jsx(Js,{}),component:re,to:"/reader/statistics",children:"View Statistics"}),e.jsx(z,{variant:"outlined",fullWidth:!0,startIcon:e.jsx(Zs,{}),disabled:!0,children:"Bookmarks (Soon)"}),e.jsx(z,{variant:"outlined",fullWidth:!0,startIcon:e.jsx(Xs,{}),disabled:!0,children:"Reading Notes (Soon)"}),e.jsx(z,{variant:"outlined",fullWidth:!0,color:"secondary",onClick:()=>alert("Thank you for your interest! Feedback collection is coming soon."),children:"Give Feedback"})]})]}),e.jsxs(O,{sx:{p:3,borderRadius:2,mb:4},children:[e.jsxs(l,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(Vt,{sx:{mr:1,color:"primary.main"}}),"Reading Tips"]}),e.jsxs(nt,{dense:!0,children:[e.jsx(Oe,{children:e.jsx(ee,{primary:"Hover over words",secondary:"See instant definitions and context",primaryTypographyProps:{fontSize:"0.9rem"},secondaryTypographyProps:{fontSize:"0.8rem"}})}),e.jsx(Oe,{children:e.jsx(ee,{primary:"Select text",secondary:"Get AI explanations for complex passages",primaryTypographyProps:{fontSize:"0.9rem"},secondaryTypographyProps:{fontSize:"0.8rem"}})}),e.jsx(Oe,{children:e.jsx(ee,{primary:"Sync your page",secondary:"Keep your digital progress in sync",primaryTypographyProps:{fontSize:"0.9rem"},secondaryTypographyProps:{fontSize:"0.8rem"}})})]})]}),e.jsxs(O,{sx:{p:3,borderRadius:2,mb:4},children:[e.jsxs(l,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(ea,{sx:{mr:1,color:"primary.main"}}),"Help & Resources"]}),e.jsx(l,{variant:"body2",paragraph:!0,children:"Need help with the Alice Reader app? Check out these resources:"}),e.jsx(nt,{children:[{title:"User Guide",link:"/help/guide"},{title:"FAQ",link:"/help/faq"},{title:"Contact Support",link:"/help/contact"}].map((y,M)=>e.jsx(Oe,{component:re,to:y.link,sx:{borderRadius:1,"&:hover":{bgcolor:"action.hover"},cursor:"pointer"},children:e.jsx(ee,{primary:y.title})},M))})]})]})]}),e.jsx(an,{open:!!d,autoHideDuration:6e3,onClose:h,message:d,anchorOrigin:{vertical:"bottom",horizontal:"center"}})]}):(console.log("ReaderDashboard: No book data available, showing fallback"),e.jsxs(p,{sx:{p:3,maxWidth:"1200px",mx:"auto"},children:[e.jsxs(l,{variant:"h4",gutterBottom:!0,children:["Welcome back, ",(c==null?void 0:c.first_name)||"Reader","!"]}),e.jsxs(O,{sx:{p:4,borderRadius:2,textAlign:"center"},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Dashboard Test"}),e.jsx(l,{variant:"body1",paragraph:!0,children:"Your book data is being loaded. If this message persists, please try refreshing the page."})]})]}))};var bi={},Ql=H;Object.defineProperty(bi,"__esModule",{value:!0});var zr=bi.default=void 0,Kl=Ql(Y()),Zl=e;zr=bi.default=(0,Kl.default)((0,Zl.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"}),"ArrowBack");var Si={},Jl=H;Object.defineProperty(Si,"__esModule",{value:!0});var ra=Si.default=void 0,Xl=Jl(Y()),ed=e;ra=Si.default=(0,Xl.default)((0,ed.jsx)("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"}),"ArrowForward");var wi={},td=H;Object.defineProperty(wi,"__esModule",{value:!0});var ia=wi.default=void 0,rd=td(Y()),id=e;ia=wi.default=(0,rd.default)((0,id.jsx)("path",{d:"M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4"}),"HelpOutline");const nd=({variant:i="text",count:t=1,height:r,width:n="100%"})=>{const s=()=>{switch(i){case"card":return e.jsxs(p,{sx:{width:n,height:r||200,borderRadius:1,overflow:"hidden"},children:[e.jsx(Ee,{variant:"rectangular",width:"100%",height:"60%"}),e.jsxs(p,{sx:{p:1},children:[e.jsx(Ee,{variant:"text",width:"80%"}),e.jsx(Ee,{variant:"text",width:"60%"})]})]});case"list":return e.jsxs(_r,{spacing:1,width:n,children:[e.jsx(Ee,{variant:"text",width:"100%",height:40}),e.jsx(Ee,{variant:"text",width:"90%",height:40}),e.jsx(Ee,{variant:"text",width:"95%",height:40})]});case"profile":return e.jsxs(p,{sx:{width:n},children:[e.jsx(Ee,{variant:"circular",width:80,height:80,sx:{mb:2}}),e.jsx(Ee,{variant:"text",width:"60%",height:32,sx:{mb:1}}),e.jsx(Ee,{variant:"text",width:"40%",height:24,sx:{mb:2}}),e.jsx(Ee,{variant:"rectangular",width:"100%",height:120})]});default:return e.jsx(Ee,{variant:"text",width:n,height:r||24})}};return e.jsx(_r,{spacing:2,children:Array.from({length:t}).map((o,c)=>e.jsx(At.Fragment,{children:s()},c))})},na=({text:i,onWordSelect:t,onTextSelect:r,fontSize:n="1rem",lineHeight:s=1.6,fontFamily:o="Georgia, serif",color:c="inherit",paragraphSpacing:d="1.2em",className:h,style:u,glossaryTerms:f=new Set,normalWordHoverColor:x,technicalWordHoverColor:k})=>{const v=Et(),E=g.useRef(null),[b,w]=g.useState(null),[_,D]=g.useState(null);x||v.palette.action.hover;const I=i.split(/\n+/).filter(U=>U.trim().length>0),L=g.useCallback(U=>{if(!f||f.size===0)return!1;const C=U.replace(/[.,!?;:'"]/g,"").trim(),$=C.toLowerCase(),R=C.charAt(0).toUpperCase()+C.slice(1),W=C.split(" ").map(Q=>Q.charAt(0).toUpperCase()+Q.slice(1)).join(" ");return f.has(C)||f.has($)||f.has(R)||f.has(W)},[f]),T=g.useCallback(U=>{if(!f||f.size===0)return null;const C=U.replace(/[.,!?;:'"]/g,"").trim(),$=C.toLowerCase(),R=C.charAt(0).toUpperCase()+C.slice(1),W=C.split(" ").map(Q=>Q.charAt(0).toUpperCase()+Q.slice(1)).join(" ");return f.has(C)?C:f.has($)?$:f.has(R)?R:f.has(W)?W:null},[f]),B=(U,C,$)=>{try{const R=I[C];if(!R)return"";const W=/([\w'']+|[.,!?;:()\[\]{}""''\\\/-—–]|\s+)/g,Q=R.match(W)||[];let ie=0,ze=0;for(let de=0;de<Q.length;de++){const Le=Q[de],xe=/^\s+$/.test(Le),Qe=/^[.,!?;:()\[\]{}""''\\\/-—–]$/.test(Le);if(!xe&&!Qe){if(ze===$){ie=de;break}ze++}}const Ie=Math.max(0,ie-3),ye=Math.min(Q.length,ie+4);return Q.slice(Ie,ye).map(de=>de.trim()).filter(de=>de.length>0).join(" ")}catch(R){return a("GlossaryAwareTextHighlighter","Error extracting word context","error",R),""}},F=g.useCallback(U=>{const C=U.currentTarget,$=C.textContent||"";if(!$.trim())return;a("GlossaryAwareTextHighlighter","Word clicked","debug",{word:$}),w($),D(C);const R=B($,0,0);t($,C,R)},[t]),y=g.useCallback(()=>{if(!r||!window.getSelection)return;const U=window.getSelection();if(!U||U.isCollapsed)return;const C=U.toString().trim();C.length>0&&(a("GlossaryAwareTextHighlighter","Text selected","debug",{selectedText:C}),r(C))},[r]);g.useEffect(()=>{if(!r||!E.current)return;const U=E.current;return U.addEventListener("mouseup",y),()=>{U.removeEventListener("mouseup",y)}},[r,y]);const M=(U,C)=>{const $=/([\w'']+|[.,!?;:()\[\]{}""''\\\/-—–]|\s+)/g,R=U.match($)||[];return e.jsx(l,{component:"p",sx:{fontSize:n,lineHeight:s,fontFamily:o,color:c,marginBottom:d,textAlign:"justify",hyphens:"auto"},children:R.map((W,Q)=>{if(!W)return null;const ie=/^\s+$/.test(W),ze=/^[.,!?;:()\[\]{}""''\\\/-—–]$/.test(W);if(ie)return e.jsx("span",{children:W},`${C}-${Q}`);if(ze)return e.jsx("span",{children:W},`${C}-${Q}`);const Ie=L(W),ye=T(W),Me=Ie?"glossary-term":"normal-word",Ye=ye&&ye.includes(" ");return e.jsx("span",{onClick:F,className:Me,"data-is-glossary-term":Ie,"data-original-term":ye||"","data-paragraph-index":C,"data-word-index":Q,"data-is-multi-word":Ye,style:{cursor:"pointer",display:"inline-block",position:"relative"},onMouseEnter:de=>{Ie&&ye?de.currentTarget.title=`✨ Alice in Wonderland term: "${ye}"
Click to see definition`:Ie?de.currentTarget.title=`✨ Technical term from Alice in Wonderland
Click to see definition`:de.currentTarget.title="Click to see definition"},children:W},`${C}-${Q}`)})},`p-${C}`)};return e.jsx(p,{ref:E,className:`glossary-aware-text-highlighter ${h||""}`,sx:{position:"relative",userSelect:r?"text":"none",...u},children:I.map(M)})},sa=()=>{const[i,t]=g.useState(new Set),[r,n]=g.useState(!0),[s,o]=g.useState(null),[c,d]=g.useState(0);g.useEffect(()=>{(async()=>{try{n(!0),o(null),a("useGlossaryTerms","Loading glossary terms from Supabase","info");const[f,x]=await Promise.all([Jn(),Zo()]);t(f),d(x),n(!1),a("useGlossaryTerms",`Loaded ${f.size} glossary terms (${x} original entries)`,"success")}catch(f){const x=f instanceof Error?f.message:"Unknown error loading glossary terms";o(x),n(!1),a("useGlossaryTerms","Error loading glossary terms","error",f)}})()},[]);const h=g.useMemo(()=>u=>{if(i.size===0)return!1;const f=u.replace(/[.,!?;:'"]/g,"").trim(),x=f.toLowerCase(),k=f.charAt(0).toUpperCase()+f.slice(1),v=f.split(" ").map(E=>E.charAt(0).toUpperCase()+E.slice(1)).join(" ");return i.has(f)||i.has(x)||i.has(k)||i.has(v)},[i]);return{glossaryTerms:i,isLoading:r,error:s,termCount:c,isGlossaryTerm:h}},sd=({word:i,definition:t,onClose:r,onAskAI:n,anchorEl:s})=>e.jsx($a,{open:!!s,anchorEl:s,onClose:r,anchorOrigin:{vertical:"bottom",horizontal:"center"},transformOrigin:{vertical:"top",horizontal:"center"},sx:{mt:1},children:e.jsxs(p,{sx:{p:2,maxWidth:300},children:[e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsx(l,{variant:"h6",component:"h3",children:i}),e.jsx(qe,{size:"small",onClick:r,children:e.jsx(ar,{fontSize:"small"})})]}),e.jsx(l,{variant:"body2",paragraph:!0,children:t}),e.jsx(z,{size:"small",startIcon:e.jsx(It,{}),onClick:n,sx:{mt:1},children:"Ask AI about this"})]})}),ad=({open:i,onClose:t,context:r})=>{const[n,s]=g.useState("");g.useState("");const[o,c]=g.useState(!1),[d,h]=g.useState([]),{service:u}=rl(),{service:f}=Ae(),x=g.useRef(null);g.useEffect(()=>{r&&i&&r.word&&s(`Tell me more about "${r.word}" in this context: "${r.sentence}"`)},[r,i]),g.useEffect(()=>{x.current&&x.current.scrollIntoView({behavior:"smooth"})},[d]);const k=async v=>{if(v.preventDefault(),!(!n.trim()||!u)){h([...d,{role:"user",content:n}]),f&&f.trackReaderAction("ai_query",{bookId:"alice-in-wonderland",pageNumber:1,content:n}),c(!0);try{const E=performance.now(),b=await u.getResponse(n,(r==null?void 0:r.sentence)||"");h([...d,{role:"user",content:n},{role:"assistant",content:b.response}]),s(""),f&&f.trackPerformance("api_call",performance.now()-E,{endpoint:"ai_response",success:!0})}catch(E){console.error("Error getting AI response:",E),h([...d,{role:"user",content:n},{role:"assistant",content:"I apologize, but I encountered an error processing your request. Please try again."}]),f&&f.trackEvent("ai_error",{query:n,error:String(E)})}finally{c(!1)}}};return e.jsxs(Oa,{anchor:"right",open:i,onClose:t,sx:{"& .MuiDrawer-paper":{width:{xs:"100%",sm:400},p:2,display:"flex",flexDirection:"column"}},children:[e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(l,{variant:"h6",children:"AI Reading Assistant"}),e.jsx(qe,{onClick:t,children:e.jsx(ar,{})})]}),e.jsx(he,{sx:{mb:2}}),e.jsx(p,{sx:{flexGrow:1,overflow:"auto",mb:2},children:d.length===0?e.jsxs(p,{sx:{p:2,textAlign:"center"},children:[e.jsx(It,{sx:{fontSize:60,color:"primary.main",mb:2}}),e.jsx(l,{variant:"body1",paragraph:!0,children:"Ask me anything about the story, characters, or themes in Alice in Wonderland."}),e.jsx(l,{variant:"body2",color:"text.secondary",children:"I can help explain difficult passages, provide context, or discuss literary elements."})]}):e.jsxs(p,{sx:{px:1},children:[d.map((v,E)=>e.jsx(p,{sx:{mb:2,p:2,borderRadius:2,maxWidth:"85%",bgcolor:v.role==="user"?"primary.light":"background.paper",color:v.role==="user"?"primary.contrastText":"text.primary",alignSelf:v.role==="user"?"flex-end":"flex-start",ml:v.role==="user"?"auto":0,boxShadow:1},children:e.jsx(l,{variant:"body1",children:v.content})},E)),e.jsx("div",{ref:x})]})}),e.jsx(he,{sx:{mb:2}}),e.jsxs(p,{component:"form",onSubmit:k,children:[e.jsx(ve,{fullWidth:!0,variant:"outlined",placeholder:"Ask about the story...",value:n,onChange:v=>s(v.target.value),disabled:o,multiline:!0,maxRows:3,sx:{mb:1}}),e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(z,{variant:"outlined",startIcon:e.jsx(ia,{}),component:"a",href:"/help/request",target:"_blank",children:"Request Help"}),e.jsx(z,{type:"submit",variant:"contained",disabled:!n.trim()||o,endIcon:o?e.jsx(le,{size:16}):e.jsx(It,{}),children:o?"Thinking...":"Ask"})]})]})]})},od=({prompt:i,onRespond:t,onDismiss:r})=>e.jsx(an,{open:!0,anchorOrigin:{vertical:"bottom",horizontal:"right"},sx:{mb:8},children:e.jsxs(fe,{severity:"info",sx:{width:"100%","& .MuiAlert-message":{width:"100%"}},onClose:()=>r(i.id),children:[e.jsx(l,{variant:"body2",paragraph:!0,children:i.message}),i.type==="feedback"&&e.jsx(p,{sx:{display:"flex",justifyContent:"space-between",gap:1},children:["😊","🤔","😕","😄"].map(n=>e.jsx(z,{variant:"outlined",size:"small",onClick:()=>t(i.id,n),sx:{minWidth:"auto"},children:n},n))})]})}),cd=()=>{const{bookId:i="alice-in-wonderland",pageNumber:t="1"}=cn(),r=st(),n=Et();Lr(n.breakpoints.down("sm"));const{user:s}=je(),{service:o,loading:c}=lr(),{service:d,loading:h}=Hs(),{service:u}=Ae(),{service:f}=il(),{settings:x}=Ns(),[k,v]=g.useState(null),[E,b]=g.useState(null),[w,_]=g.useState(0),[D,I]=g.useState(!1),[L,T]=g.useState(!0),[B,F]=g.useState(null),[y,M]=g.useState(null),[U,C]=g.useState(null),[$,R]=g.useState(null),[W,Q]=g.useState(""),[ie,ze]=g.useState(!1),[Ie,ye]=g.useState(void 0),[Me,Ye]=g.useState(null),de=g.useRef(null),Le=g.useRef(xe.now()),xe=He({trackPageLoad:!0,trackRender:!0,componentName:"ReaderPage"}),{glossaryTerms:Qe,isLoading:dr,error:ur,termCount:gt}=sa();g.useEffect(()=>{if(console.log("ReaderPage: useEffect triggered for loading book content",{hasBookService:!!o,bookId:i,pageNumber:t}),!o){console.log("ReaderPage: No bookService available, skipping data load");return}(async()=>{T(!0),F(null);try{const K=xe.now(),se=await o.getBook(i);if(xe.trackApiCall("getBook",K),console.log("ReaderPage: Book data received:",se),se)v(se),_(se.totalPages||100);else throw new Error("Failed to load book data");const pt=await o.getPage(i,parseInt(t));if(console.log("ReaderPage: Page data received:",pt),pt)b(pt),I(!0);else throw new Error("Failed to load page content");u&&s&&u.trackPageView("reader_page",{userId:s.id,bookId:i,pageNumber:t}),Le.current=xe.now()}catch(K){console.error("Error loading book content:",K),F("Failed to load book content. Please try again."),u&&u.trackEvent("reader_error",{bookId:i,pageNumber:t,error:String(K)})}finally{T(!1)}})()},[i,t,o,u,s,xe]),g.useEffect(()=>{if(!f||!s)return;const N=f.subscribeToTriggers(s.id,K=>{Ye(K)});return()=>{N&&N()}},[f,s]),g.useEffect(()=>()=>{if(console.log("ReaderPage: Unmounting component, updating reading progress",{hasBookService:!!o,hasUser:!!s,bookId:i,pageNumber:t}),o&&s&&i&&t){const N=Math.round((xe.now()-Le.current)/1e3);if(N>=5)try{o.updateReadingProgress(s.id,i,parseInt(t),N),console.log("ReaderPage: Successfully updated reading progress",{userId:s.id,bookId:i,pageNumber:t,readingTime:N}),u&&u.trackEvent("reading_session",{bookId:i,pageNumber:t,duration:N})}catch(K){console.error("ReaderPage: Error updating reading progress:",K)}}},[o,s,i,t,u]);const ht=g.useCallback(async N=>{const K=window.getSelection();if(!K||K.rangeCount===0)return;const se=K.toString().trim();if(!se||se.split(" ").length>3)return;const Ze=K.getRangeAt(0).startContainer.parentNode,Yt=(Ze==null?void 0:Ze.textContent)||"";if(M(se),C(Yt),R(N.currentTarget),d)try{const Be=xe.now(),Tt=await d.getDefinition(se);xe.trackApiCall("getDefinition",Be),Q(Tt.definition||"No definition found"),u&&s&&u.trackReaderAction("definition",{bookId:i,pageNumber:parseInt(t),content:se})}catch(Be){console.error("Error getting definition:",Be),Q("Definition not available")}},[d,u,s,i,t,xe]),Rt=N=>{if(console.log("ReaderPage: Navigating to page",{newPage:N,totalPages:w}),N<1||N>w){console.log("ReaderPage: Invalid page number, not navigating");return}if(o&&s&&i){const K=Math.round((xe.now()-Le.current)/1e3);if(K>=5)try{o.updateReadingProgress(s.id,i,parseInt(t),K),console.log("ReaderPage: Updated reading progress before navigation")}catch(se){console.error("ReaderPage: Error updating reading progress before navigation:",se)}}I(!1),T(!0),console.log("ReaderPage: Navigating to",`/reader/${i}/page/${N}`),r(`/reader/${i}/page/${N}`)},Ht=N=>{ye(N&&y?{word:y,sentence:U||""}:void 0),ze(!0),R(null)},gr=(N,K)=>{f&&f.markTriggerProcessed(N,K),u&&u.trackEvent("prompt_response",{promptId:N,response:K}),Ye(null)},Ke=N=>{f&&f.markTriggerProcessed(N,"dismissed"),u&&u.trackEvent("prompt_dismissed",{promptId:N}),Ye(null)};if(L||c||h)return console.log("ReaderPage: Showing loading state"),e.jsx(nd,{type:"reader"});if(B)return console.log("ReaderPage: Showing error state:",B),e.jsxs(p,{sx:{p:3,textAlign:"center"},children:[e.jsx(l,{color:"error",variant:"h6",gutterBottom:!0,children:B}),e.jsx(z,{variant:"contained",onClick:()=>r("/reader"),startIcon:e.jsx(kt,{}),sx:{mt:2},children:"Return to Dashboard"})]});if(!D||!k||!E)return console.log("ReaderPage: Not fully initialized or missing required data",{initialized:D,bookData:k,currentPage:E}),e.jsxs(p,{sx:{p:3,textAlign:"center"},children:[e.jsx(l,{color:"error",variant:"h6",gutterBottom:!0,children:"Something went wrong... Cannot access required data."}),e.jsx(l,{variant:"body1",color:"text.secondary",paragraph:!0,children:"The reader page could not be loaded because some required data is missing."}),e.jsx(z,{variant:"contained",onClick:()=>r("/reader"),startIcon:e.jsx(kt,{}),sx:{mt:2},children:"Return to Dashboard"})]});const ft={fontSize:`${x.fontSize/100}rem`,lineHeight:x.lineHeight};return e.jsxs(p,{sx:{position:"relative",minHeight:"100vh"},children:[e.jsx(p,{sx:{position:"sticky",top:0,zIndex:10,bgcolor:"background.paper",boxShadow:1,p:1},children:e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(p,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(qe,{onClick:()=>r("/reader"),"aria-label":"Back to dashboard",children:e.jsx(zr,{})}),e.jsx(l,{variant:"subtitle1",sx:{ml:1,display:{xs:"none",sm:"block"}},children:(k==null?void 0:k.title)||"Alice in Wonderland"})]}),e.jsxs(p,{sx:{display:"flex",alignItems:"center"},children:[e.jsxs(l,{variant:"body2",sx:{mr:2},children:["Page ",t," of ",w]}),e.jsx(_c,{})]})]})}),e.jsx(Ct,{maxWidth:"md",sx:{py:4},children:e.jsxs(O,{elevation:2,sx:{p:4,borderRadius:2,position:"relative"},children:[e.jsx(l,{variant:"h5",component:"h1",gutterBottom:!0,children:(E==null?void 0:E.title)||`Chapter ${t}`}),e.jsx(he,{sx:{my:2}}),!dr&&gt>0&&e.jsx(p,{sx:{mb:2,p:1,bgcolor:"warning.light",borderRadius:1},children:e.jsxs(l,{variant:"caption",color:"text.secondary",children:["✨ Alice Glossary Active: ",gt," technical terms available for highlighting"]})}),e.jsx(p,{ref:de,onClick:ht,sx:{mt:2,"& p":{...ft,mb:2}},children:E!=null&&E.content?e.jsx(na,{text:E.content,onWordSelect:(N,K)=>{console.log("Word selected:",N),M(N),R(K)},onTextSelect:N=>{console.log("Text selected:",N)},fontSize:"1.1rem",lineHeight:1.8,fontFamily:"Georgia, serif",glossaryTerms:Qe,normalWordHoverColor:"rgba(25, 118, 210, 0.1)",technicalWordHoverColor:"rgba(255, 152, 0, 0.2)"}):e.jsx(l,{variant:"body1",children:"No content available for this page."})}),e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",mt:4},children:[e.jsx(z,{variant:"outlined",startIcon:e.jsx(zr,{}),onClick:()=>Rt(parseInt(t)-1),disabled:parseInt(t)<=1,children:"Previous"}),e.jsx(z,{variant:"outlined",endIcon:e.jsx(ra,{}),onClick:()=>Rt(parseInt(t)+1),disabled:parseInt(t)>=w,children:"Next"})]})]})}),y&&e.jsx(sd,{word:y,definition:W,onClose:()=>R(null),onAskAI:()=>Ht(!0),anchorEl:$}),e.jsx(ad,{open:ie,onClose:()=>ze(!1),context:Ie}),e.jsx(Ta,{in:!ie,children:e.jsx(Pa,{color:"primary","aria-label":"AI Assistant",onClick:()=>Ht(),sx:{position:"fixed",bottom:16,right:16},children:e.jsx(It,{})})}),Me&&e.jsx(od,{prompt:Me,onRespond:gr,onDismiss:Ke})]})},ld={dailyReadingTime:[15,25,10,30,20,35,15],weeklyProgress:[5,12,8,15,10,20,18],pagesPerSession:[3,5,2,7,4,8,3],readingSpeed:[120,130,110,140,125,135,130],daysActive:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],vocabularyGrowth:[5,8,12,15,18,22,25],aiInteractions:[2,1,3,0,2,4,1]};function br(i){const{children:t,value:r,index:n,...s}=i;return e.jsx("div",{role:"tabpanel",hidden:r!==n,id:`stats-tabpanel-${n}`,"aria-labelledby":`stats-tab-${n}`,...s,children:r===n&&e.jsx(p,{sx:{p:3},children:t})})}const dd=()=>{const i=Et(),{user:t}=je(),{service:r,loading:n}=lr(),{service:s,loading:o}=nl(),{service:c}=Ae(),[d,h]=g.useState(!0),[u,f]=g.useState(null),[x,k]=g.useState(null),[v,E]=g.useState(0);He({trackPageLoad:!0,trackRender:!0,componentName:"ReaderStatistics"}),g.useEffect(()=>{if(!s||!t)return;(async()=>{h(!0),f(null);try{const _=performance.now(),D=await s.getReadingStatistics(t.id,"alice-in-wonderland");k({...ld,totalReadingTime:150,totalPagesRead:68,totalChaptersCompleted:3,averageReadingSpeed:130,vocabularyLookups:25,aiAssistantUsage:12,lastReadDate:new Date().toISOString(),...D}),c&&c.trackPageView("reader_statistics",{userId:t.id,bookId:"alice-in-wonderland"})}catch(_){console.error("Error loading statistics:",_),f("Failed to load reading statistics. Please try again."),c&&c.trackEvent("statistics_error",{error:String(_)})}finally{h(!1)}})()},[s,t,c]);const b=(w,_)=>{E(_),c&&c.trackEvent("statistics_tab_change",{tabIndex:_})};return d||n||o?e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(le,{})}):u?e.jsxs(p,{sx:{p:3,textAlign:"center"},children:[e.jsx(l,{color:"error",variant:"h6",gutterBottom:!0,children:u}),e.jsx(z,{variant:"contained",component:re,to:"/reader",startIcon:e.jsx(kt,{}),sx:{mt:2},children:"Return to Dashboard"})]}):e.jsxs(p,{sx:{p:3,maxWidth:"1200px",mx:"auto"},children:[e.jsxs(p,{sx:{mb:4},children:[e.jsx(l,{variant:"h4",gutterBottom:!0,children:"Reading Statistics"}),e.jsx(l,{variant:"body1",color:"text.secondary",children:"Track your reading progress and habits"})]}),e.jsx(m,{container:!0,spacing:3,sx:{mb:4},children:[{title:"Total Reading Time",value:`${x.totalReadingTime} mins`,icon:e.jsx(fi,{sx:{fontSize:40,color:i.palette.primary.main}}),color:i.palette.primary.light},{title:"Pages Read",value:`${x.totalPagesRead} pages`,icon:e.jsx(_t,{sx:{fontSize:40,color:i.palette.secondary.main}}),color:i.palette.secondary.light},{title:"Reading Speed",value:`${x.averageReadingSpeed} wpm`,icon:e.jsx(vi,{sx:{fontSize:40,color:i.palette.success.main}}),color:i.palette.success.light},{title:"Last Read",value:new Date(x.lastReadDate).toLocaleDateString(),icon:e.jsx(xi,{sx:{fontSize:40,color:i.palette.info.main}}),color:i.palette.info.light}].map((w,_)=>e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(O,{elevation:2,sx:{p:3,height:"100%",display:"flex",flexDirection:"column",alignItems:"center",textAlign:"center",bgcolor:w.color,borderRadius:2},children:[e.jsx(p,{sx:{mb:2},children:w.icon}),e.jsx(l,{variant:"h6",gutterBottom:!0,children:w.title}),e.jsx(l,{variant:"h4",children:w.value})]})},_))}),e.jsxs(O,{sx:{mb:4,borderRadius:2},children:[e.jsxs(on,{value:v,onChange:b,indicatorColor:"primary",textColor:"primary",variant:"fullWidth",children:[e.jsx(ut,{label:"Reading Activity"}),e.jsx(ut,{label:"Vocabulary"}),e.jsx(ut,{label:"AI Assistance"})]}),e.jsx(br,{value:v,index:0,children:e.jsxs(m,{container:!0,spacing:4,children:[e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Daily Reading Time"}),e.jsx(O,{elevation:1,sx:{p:3,height:300,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(l,{variant:"body1",color:"text.secondary",children:"[Bar Chart Visualization]"})})]}),e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Reading Progress"}),e.jsx(O,{elevation:1,sx:{p:3,height:300,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(l,{variant:"body1",color:"text.secondary",children:"[Line Chart Visualization]"})})]}),e.jsxs(m,{item:!0,xs:12,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Reading Habits"}),e.jsx(O,{elevation:1,sx:{p:3},children:e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"primary",children:x.totalChaptersCompleted}),e.jsx(l,{variant:"body1",children:"Chapters Completed"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"primary",children:Math.round(x.totalPagesRead/7)}),e.jsx(l,{variant:"body1",children:"Pages Per Day"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"primary",children:Math.round(x.totalReadingTime/x.totalPagesRead)}),e.jsx(l,{variant:"body1",children:"Minutes Per Page"})]})})]})})]})]})}),e.jsx(br,{value:v,index:1,children:e.jsxs(m,{container:!0,spacing:4,children:[e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Vocabulary Growth"}),e.jsx(O,{elevation:1,sx:{p:3,height:300,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(l,{variant:"body1",color:"text.secondary",children:"[Line Chart Visualization]"})})]}),e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Most Looked Up Words"}),e.jsx(O,{elevation:1,sx:{p:3,height:300,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(l,{variant:"body1",color:"text.secondary",children:"[Word Cloud Visualization]"})})]}),e.jsxs(m,{item:!0,xs:12,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Vocabulary Summary"}),e.jsx(O,{elevation:1,sx:{p:3},children:e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"secondary",children:x.vocabularyLookups}),e.jsx(l,{variant:"body1",children:"Words Looked Up"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"secondary",children:Math.round(x.vocabularyLookups*.8)}),e.jsx(l,{variant:"body1",children:"Unique Words"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"secondary",children:Math.round(x.vocabularyLookups/x.totalPagesRead*10)/10}),e.jsx(l,{variant:"body1",children:"Lookups Per Page"})]})})]})})]})]})}),e.jsx(br,{value:v,index:2,children:e.jsxs(m,{container:!0,spacing:4,children:[e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"AI Assistant Usage"}),e.jsx(O,{elevation:1,sx:{p:3,height:300,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(l,{variant:"body1",color:"text.secondary",children:"[Bar Chart Visualization]"})})]}),e.jsxs(m,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Common AI Questions"}),e.jsx(O,{elevation:1,sx:{p:3,height:300,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(l,{variant:"body1",color:"text.secondary",children:"[Topic Visualization]"})})]}),e.jsxs(m,{item:!0,xs:12,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"AI Assistance Summary"}),e.jsx(O,{elevation:1,sx:{p:3},children:e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"info.main",children:x.aiAssistantUsage}),e.jsx(l,{variant:"body1",children:"AI Interactions"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"info.main",children:Math.round(x.aiAssistantUsage*.7)}),e.jsx(l,{variant:"body1",children:"Questions Asked"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(p,{sx:{textAlign:"center",p:2},children:[e.jsx(l,{variant:"h3",color:"info.main",children:Math.round(x.aiAssistantUsage*.3)}),e.jsx(l,{variant:"body1",children:"Help Requests"})]})})]})})]})]})})]}),e.jsxs(p,{sx:{display:"flex",justifyContent:"center",mt:4},children:[e.jsx(z,{variant:"contained",component:re,to:"/reader",startIcon:e.jsx(kt,{}),sx:{mr:2},children:"Return to Dashboard"}),e.jsx(z,{variant:"outlined",component:re,to:"/reader/alice-in-wonderland/page/1",startIcon:e.jsx(_t,{}),children:"Continue Reading"})]})]})},Sr=({fullHeight:i=!1,minHeight:t="200px",size:r=40,message:n,...s})=>e.jsxs(p,{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",minHeight:i?"100vh":t,width:"100%",children:[e.jsx(le,{size:r,...s}),n&&e.jsx(l,{variant:"body2",color:"text.secondary",sx:{mt:2},children:n})]}),ud=i=>i?i.replace(/\uFFFD/g,"").replace(/\0/g,"").replace(/[""]/g,'"').replace(/['']/g,"'").replace(/\u2018/g,"'").replace(/\u2019/g,"'").replace(/\u201A/g,"'").replace(/\u201C/g,'"').replace(/\u201D/g,'"').replace(/\u201E/g,'"').replace(/\u2032/g,"'").replace(/\u2033/g,'"').replace(/\u2014/g,"—").replace(/\u2013/g,"–").replace(/\u2026/g,"...").replace(/\u00A0/g," ").replace(/\u2010/g,"-").replace(/\u2011/g,"-").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").replace(/[\u0080-\u009F]/g,"").replace(/\s+/g," ").trim():"",Mr=i=>{if(!i)return"";let t=ud(i);return t=t.replace(/D\s*R\s*I\s*N\s*K\s*\s*M\s*E/gi,"DRINK ME").replace(/E\s*A\s*T\s*\s*M\s*E/gi,"EAT ME").replace(/\s*(['""])\s*/g," $1").replace(/\s*!\s*/g,"!").replace(/\s*\?\s*/g,"?").replace(/\s*,\s*/g,", ").replace(/\s*\.\s*/g,". ").replace(/\s*;\s*/g,"; ").replace(/\s*:\s*/g,": ").replace(/\s*\(\s*/g," (").replace(/\s*\)\s*/g,") ").replace(/\s{2,}/g," ").trim(),t};var ji={},gd=H;Object.defineProperty(ji,"__esModule",{value:!0});var aa=ji.default=void 0,hd=gd(Y()),er=e;aa=ji.default=(0,hd.default)([(0,er.jsx)("path",{d:"M21 12.22C21 6.73 16.74 3 12 3c-4.69 0-9 3.65-9 9.28-.6.34-1 .98-1 1.72v2c0 1.1.9 2 2 2h1v-6.1c0-3.87 3.13-7 7-7s7 3.13 7 7V19h-8v2h8c1.1 0 2-.9 2-2v-1.22c.59-.31 1-.92 1-1.64v-2.3c0-.7-.41-1.31-1-1.62"},"0"),(0,er.jsx)("circle",{cx:"9",cy:"13",r:"1"},"1"),(0,er.jsx)("circle",{cx:"15",cy:"13",r:"1"},"2"),(0,er.jsx)("path",{d:"M18 11.03C17.52 8.18 15.04 6 12.05 6c-3.03 0-6.29 2.51-6.03 6.45 2.47-1.01 4.33-3.21 4.86-5.89 1.31 2.63 4 4.44 7.12 4.47"},"3")],"SupportAgent");class fd{async getSection(t){console.log("ReaderService: Getting section with ID:",t);try{const r=await A(),{data:n,error:s}=await r.from("sections").select(`
          id,
          title,
          content,
          chapter:chapter_id (
            id,
            title,
            number
          )
        `).eq("id",t).single();if(s)throw console.error("ReaderService: Error fetching section with join:",s),s;if(console.log("ReaderService: Section data received:",n),!n||!n.content||n.content.trim()===""){console.warn("ReaderService: Section content is empty or missing, trying direct content query");const{data:h,error:u}=await r.from("sections").select("content").eq("id",t).single();if(u)throw console.error("ReaderService: Error fetching section content directly:",u),u;if(!h||!h.content||h.content.trim()==="")throw console.error("ReaderService: Section content is still empty after direct query"),new Error("Section content is empty");console.log("ReaderService: Retrieved content directly, length:",h.content.length),console.log("ReaderService: Content preview:",h.content.substring(0,100)),n.content=h.content}const o=n.content,c=Mr(n.content);o!==c&&console.log("ReaderService: Text cleaning applied. Original length:",o.length,"Cleaned length:",c.length),n.content=c,console.log("ReaderService: Content length:",n.content.length),console.log("ReaderService: Content preview:",n.content.substring(0,100));const d={id:n.id,title:n.title,content:n.content,chapter:n.chapter||{id:"",title:"",number:0}};return console.log("ReaderService: Transformed section:",d),d}catch(r){throw console.error("ReaderService: Failed to get section:",r),r}}async getSectionSnippetsForPage(t,r){console.log("ReaderService: Getting section snippets for book:",t,"page:",r);const n=await A(),{data:s,error:o}=await n.rpc("get_section_snippets_for_page",{book_id_param:t,page_number_param:r});if(o)throw console.error("ReaderService: Error fetching section snippets:",o),o;return console.log("ReaderService: Section snippets received:",s),(s==null?void 0:s.map(d=>({...d,preview:Mr(d.preview||"")})))||[]}async requestHelp(t){const r=await A(),{error:n}=await r.from("help_requests").insert({section_id:t,status:"PENDING"});if(n)throw n}}const rn=new fd,pd=()=>{const[i,t]=g.useState(null),[r,n]=g.useState(!0),[s,o]=g.useState(!1),[c,d]=g.useState(new Date),h=async()=>{try{n(!0),d(new Date);const v=await dn(!0);let E=0,b;if(v)try{E=(await Jn()).size}catch(w){b=`Glossary error: ${w instanceof pr?w.message:String(w)}`,a("ConnectionStatus","Error loading glossary terms","error",w)}else b="Supabase connection failed";t({supabase:v,glossaryTerms:E,lastCheck:new Date,error:b}),a("ConnectionStatus",`Connection check completed - Supabase: ${v}, Glossary terms: ${E}`,v?"success":"error")}catch(v){t({supabase:!1,glossaryTerms:0,lastCheck:new Date,error:v instanceof pr?v.message:String(v)}),a("ConnectionStatus","Error checking connections","error",v)}finally{n(!1)}};g.useEffect(()=>{let v=!0,E;return(async()=>{v&&await h()})(),E=setInterval(()=>{v&&h()},6e4),()=>{v=!1,E&&clearInterval(E)}},[]);const u=()=>i?i.supabase&&i.glossaryTerms>0?"success":i.supabase?"warning":"error":"warning",f=()=>r?e.jsx(le,{size:16}):i?i.supabase&&i.glossaryTerms>0?e.jsx(Ba,{sx:{fontSize:16}}):i.supabase?e.jsx(Li,{sx:{fontSize:16}}):e.jsx(pr,{sx:{fontSize:16}}):e.jsx(Li,{sx:{fontSize:16}}),x=()=>r?"Checking...":i?i.supabase&&i.glossaryTerms>0?"Connected":i.supabase?"Partial":"Disconnected":"Unknown",k=()=>i?i.supabase&&i.glossaryTerms>0?`Supabase: ✅, Glossary: ${i.glossaryTerms} terms`:i.supabase?"Supabase: ✅, Glossary: ❌":"Supabase: ❌":"Connection status unknown";return e.jsx(p,{sx:{position:"fixed",bottom:16,right:16,zIndex:1e3},children:e.jsxs(O,{elevation:3,sx:{p:.5,minWidth:180,maxWidth:250,border:1,borderColor:u()==="success"?"success.main":u()==="warning"?"warning.main":"error.main"},children:[e.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:.5,mb:.5},children:[f(),e.jsx(l,{variant:"caption",sx:{fontWeight:"bold"},children:x()}),e.jsx(p,{sx:{flexGrow:1}}),e.jsx(qe,{size:"small",onClick:h,disabled:r,sx:{p:.25},children:e.jsx(Da,{sx:{fontSize:14}})}),e.jsx(qe,{size:"small",onClick:()=>o(!s),sx:{p:.25},children:s?e.jsx(za,{sx:{fontSize:14}}):e.jsx(Ma,{sx:{fontSize:14}})})]}),e.jsx(l,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:.5,fontSize:"0.7rem"},children:k()}),e.jsx(La,{in:s,children:e.jsxs(p,{sx:{pt:1,borderTop:1,borderColor:"divider"},children:[i&&e.jsxs(p,{sx:{mb:1},children:[e.jsx(l,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:.5},children:"Connection Details:"}),e.jsxs(p,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(p,{sx:{width:6,height:6,borderRadius:"50%",backgroundColor:i.supabase?"success.main":"error.main"}}),e.jsxs(l,{variant:"caption",children:["Supabase: ",i.supabase?"Connected":"Failed"]})]}),e.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(p,{sx:{width:6,height:6,borderRadius:"50%",backgroundColor:i.glossaryTerms>0?"success.main":"error.main"}}),e.jsxs(l,{variant:"caption",children:["Glossary Terms: ",i.glossaryTerms," loaded"]})]})]})]}),(i==null?void 0:i.error)&&e.jsx(fe,{severity:"error",sx:{mb:1,py:.5},children:e.jsx(l,{variant:"caption",children:i.error})}),e.jsxs(l,{variant:"caption",color:"text.secondary",children:["Last check: ",c.toLocaleTimeString()]}),i&&!i.supabase&&e.jsxs(p,{sx:{mt:1,p:1,bgcolor:"warning.light",borderRadius:1},children:[e.jsx(l,{variant:"caption",sx:{fontWeight:"bold",display:"block",mb:.5},children:"Troubleshooting:"}),e.jsx(l,{variant:"caption",sx:{display:"block"},children:"• Check your internet connection"}),e.jsx(l,{variant:"caption",sx:{display:"block"},children:"• Verify Supabase credentials in .env"}),e.jsx(l,{variant:"caption",sx:{display:"block"},children:"• Check browser console for errors"})]})]})})]})})},xd=({open:i,onClose:t,bookId:r,sectionId:n,sectionTitle:s,selectedText:o})=>{const{user:c}=je(),[d,h]=g.useState(""),[u,f]=g.useState(!1),[x,k]=g.useState(null),[v,E]=g.useState(!1),b=async()=>{if(!c){k("You must be logged in to request help");return}if(!d.trim()){k("Please describe what you need help with");return}f(!0),k(null),E(!1);try{a("HelpRequestDialog","Submitting help request","info",{sectionId:n,hasSelectedText:!!o});const{error:w}=await Ho(c.id,r,d,n,o);w?(a("HelpRequestDialog","Error submitting help request","error",w),k(w.message||"Failed to submit help request")):(a("HelpRequestDialog","Help request submitted successfully","success"),E(!0),h(""),setTimeout(()=>{t()},2e3))}catch(w){a("HelpRequestDialog","Error in help request submission","error",w),k(w.message||"An unexpected error occurred")}finally{f(!1)}};return e.jsxs(kr,{open:i,onClose:t,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ir,{children:"Request Help from a Consultant"}),e.jsxs(Er,{children:[s&&e.jsxs(l,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:["About: ",s]}),e.jsx(l,{variant:"body2",paragraph:!0,sx:{mt:1},children:"A reading consultant will respond to your question as soon as possible. Please be specific about what you need help with."}),o&&e.jsxs(p,{sx:{mb:2},children:[e.jsx(l,{variant:"subtitle2",gutterBottom:!0,children:"Selected Text:"}),e.jsxs(p,{sx:{p:2,bgcolor:"background.default",borderRadius:1,borderLeft:"3px solid",borderColor:"primary.main",fontSize:"0.9rem",fontStyle:"italic"},children:['"',o,'"']})]}),e.jsx(ve,{label:"What do you need help with?",multiline:!0,rows:4,fullWidth:!0,value:d,onChange:w=>h(w.target.value),disabled:u,sx:{mb:2,mt:2},placeholder:"Example: I'm having trouble understanding what the author means by..."}),e.jsxs(p,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx(l,{variant:"caption",color:"text.secondary",children:"Response time:"}),e.jsx(tt,{label:"Usually within 24 hours",size:"small",color:"primary",variant:"outlined"})]}),x&&e.jsx(fe,{severity:"error",sx:{mb:2},children:x}),v&&e.jsx(fe,{severity:"success",sx:{mb:2},children:"Your help request has been submitted successfully! A consultant will respond soon."})]}),e.jsxs(Cr,{children:[e.jsx(z,{onClick:t,disabled:u,children:"Cancel"}),e.jsx(z,{onClick:b,variant:"contained",color:"primary",disabled:u||!d.trim(),startIcon:u?e.jsx(le,{size:20}):null,children:"Submit Request"})]})]})},md=["look up","find out","come across","run into","get up","sit down","stand up","turn around","come back","go away","come in","go out","put on","take off","pick up","put down","come up","go down","come out","go in","look down","come over","go over","come through","go through","come along","go along","come about","go about","go across","come after","go after","come before","go before","come between","go between","come by","go by","come for","go for","come from","go from","come into","go into","come of","go of","come off","go off","come on","go on","come round","go round","come to","go to","come under","go under","come upon","go upon","come with","go with"],vd=i=>{const t=i.toLowerCase().trim();return md.includes(t)},nn=()=>{st();const{bookId:i="alice-in-wonderland"}=cn(),{user:t,profile:r,loading:n}=je(),{service:s,loading:o,error:c}=lr(),{service:d,loading:h,error:u}=Hs(),{service:f}=Gs();Fa();const{glossaryTerms:x,isLoading:k,error:v,termCount:E}=sa(),b="550e8400-e29b-41d4-a716-446655440000",[w,_]=g.useState(""),[D,I]=g.useState(null),[L,T]=g.useState(!1),[B,F]=g.useState([]),[y,M]=g.useState(null),[U,C]=g.useState(null),[$,R]=g.useState("page_input"),[W,Q]=g.useState(""),[ie,ze]=g.useState(null);g.useState(!1);const Ie=g.useRef(null),ye=g.useRef(null),[Me,Ye]=g.useState(!1);g.useState(!1);const[de,Le]=g.useState(!1),[xe,Qe]=g.useState(""),[dr,ur]=g.useState(!1);g.useState({x:0,y:0});const[gt,ht]=g.useState(!1),[Rt,Ht]=g.useState({x:0,y:0}),[gr,Ke]=g.useState(!1),[ft,N]=g.useState(null),[K,se]=g.useState(null),[pt,Ze]=g.useState(!1),[Yt,Be]=g.useState(null),[Tt,xt]=g.useState(null),[Ad,Ii]=g.useState(!1),[mt,Pt]=g.useState(null),[la,$t]=g.useState(!1);g.useState(null),g.useState(!1),g.useState(null),g.useState(!1);const[da,Ei]=g.useState(!1);g.useRef(0);const ua=async()=>{try{const j=await fetch("/api/ai/generate-example",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({word:W,definition:K,context:"Alice in Wonderland"})});if(!j.ok)throw new Error("Failed to generate example");return(await j.json()).example}catch(j){return console.error("Error generating example:",j),null}},ga=g.useCallback(async(j,V,X)=>{const q=j.replace(/[.,!?;:'"]/g,"").trim();if(q){Q(q),Ke(!0),N(null),se(null),Be(null),xt(null),Pt(null),$t(!1),Ze(!0);try{if(await new Promise(me=>setTimeout(me,300)),!d)throw new Error("Dictionary service not available");const ce=y==null?void 0:y.id;let J;X&&X.trim().length>0?(a("MainInteractionPage","Using context-aware definition lookup","info",{word:q,context:X.substring(0,100)+"..."}),J=await d.getContextAwareDefinition(b,q,X,ce)):J=await d.getDefinition(b,q,ce),J&&J.definition?(se(J.definition),Be(J.wordOrigin||null),xt(J.examples&&J.examples.length>0?J.examples[0]:null),Pt(J.source||null),$t(J.isPhrasalVerb||!1),t&&y&&f&&f.logConsultantAction(t.id,"DEFINITION_LOOKUP",{word:q,success:!0,book_id:b,section_id:y.id}).catch(me=>console.error("Error logging dictionary lookup:",me))):(N("No definition found for this word."),t&&y&&f&&f.logConsultantAction(t.id,"DEFINITION_LOOKUP",{word:q,success:!1,book_id:b,section_id:y.id,error:ft}).catch(me=>console.error("Error logging dictionary lookup:",me)))}catch(ce){console.error("Error fetching definition:",ce),N("Error fetching definition. Please try again."),t&&y&&f&&f.logConsultantAction(t.id,"DEFINITION_LOOKUP",{word:q,success:!1,book_id:b,section_id:y.id,error:String(ce)}).catch(J=>console.error("Error logging dictionary lookup:",J))}finally{Ke(!1)}}},[d,y,t,f]);g.useEffect(()=>{K&&!Tt&&(Ii(!0),ua().then(j=>{xt(j),Ii(!1)}))},[K]),g.useEffect(()=>{!n&&!o&&!h&&t&&s&&d&&Ye(!0)},[n,o,h,t,s,d]),g.useEffect(()=>{if(Me&&ye.current&&$==="page_input"){const j=setTimeout(()=>{var V;(V=ye.current)==null||V.focus()},100);return()=>clearTimeout(j)}},[Me,$]);const Ci=async()=>{const j=parseInt(w,10);if(isNaN(j)||j<=0){C("Please enter a valid page number.");return}T(!0),C(null),F([]),M(null),I(j),console.log(`Fetching sections for page: ${j}`);try{const V=await rn.getSectionSnippetsForPage(b,j);F(V||[]),V.length===0?C(`No sections found on page ${j}.`):(R("section_selection"),t&&f&&f.logConsultantAction(t.id,"PAGE_SYNC",{page_number:j,book_id:b}))}catch(V){console.error("Error fetching sections:",V),C(`Failed to load sections for page ${j}. ${V.message||""}`),F([])}finally{T(!1)}},Ai=async j=>{const V=B.find(q=>q.id===j);if(!V&&!y){console.error(`No snippet found with ID: ${j}`);return}const X=V||{id:j,number:(y==null?void 0:y.number)||0,preview:(y==null?void 0:y.preview)||""};console.log("Selected snippet:",X),T(!0),C(null),y||M(null),console.log(`Fetching full content for section: ${j}`);try{const q=await rn.getSection(j);if(console.log("Received full section data:",q),!q||!q.content)throw console.error("Section content is empty or undefined:",q),new Error("Section content could not be loaded (empty response)");if(console.log(`Section content length: ${q.content.length} characters`),console.log(`Section content preview: "${q.content.substring(0,100)}..."`),q.content.trim()===X.preview.trim())throw console.warn("Section content appears to be just the preview text, attempting to retry with direct query"),new Error("Section content appears incomplete. Please try again.");const ce={id:q.id,number:X.number,preview:X.preview,content:q.content};console.log("Setting selected section with content:",ce),M(ce),V&&F([]),$i(),R("content_interaction"),t&&f&&f.logConsultantAction(t.id,"SECTION_SYNC",{section_id:j,page_number:D,book_id:b})}catch(q){console.error("Error fetching section content:",q),C(`Failed to load section content. ${q.message||""}`)}finally{T(!1)}},ha=(j,V,X,q="all")=>{const ce=/[\w''\-]/,J=/\s/;let me=V;for(;me>0&&ce.test(j[me-1]);)me--;let Re=X;for(;Re<j.length&&ce.test(j[Re]);)Re++;let Ot=me,Dt=Re,Ue=me,Kt=0;for(;Ue>0&&Kt<3;){for(;Ue>0&&J.test(j[Ue-1]);)Ue--;if(Ue===0)break;let be=Ue;for(;be>0&&ce.test(j[be-1]);)be--;const zt=j.substring(be,Ue);if(zt&&zt.length>1)Ot=be,Kt++,Ue=be;else break}let Te=Re,Di=0;for(;Te<j.length&&Di<3;){for(;Te<j.length&&J.test(j[Te]);)Te++;if(Te>=j.length)break;let be=Te;for(;be<j.length&&ce.test(j[be]);)be++;const zt=j.substring(Te,be);if(zt&&zt.length>1)Dt=be,Di++,Te=be;else break}const xa=j.substring(me,Re),ma=j.substring(Ot,Dt);return{singleWord:xa.trim(),phrase:ma.trim(),expandedStart:me,expandedEnd:Re,phraseStart:Ot,phraseEnd:Dt}},Qt=async()=>{const j=window.getSelection();if(!j||!j.toString().trim())return;let V=j.toString().trim();const q=j.getRangeAt(0).getBoundingClientRect(),ce=j.anchorNode;let J=null;if(ce&&ce.nodeType===Node.TEXT_NODE){const Re=ce.textContent||"",Ot=j.anchorOffset,Dt=j.focusOffset;if(J=ha(Re,Ot,Dt),J){const Kt=j.toString().trim().split(/\s+/).length,Te=vd(J.phrase);Kt>1||Te?V=J.phrase||J.singleWord:V=J.singleWord,V=V.trim()}}if(V.split(/\s+/).length>5){ht(!0),Ht({x:q.left,y:q.bottom}),Ze(!1);return}Ke(!0),N(null),se(null),Ze(!0),Q(V),ht(!1);try{await fa(V)}catch{N("Error fetching definition.")}finally{Ke(!1)}},Ri=async()=>{Le(!0),ht(!1),ur(!0),Qe("");try{const j=`AI response for: "${W}"`;await new Promise(V=>setTimeout(V,1500)),Qe(j),t&&f&&y&&f.logConsultantAction(t.id,"AI_QUERY",{query:W,response:j,book_id:b,section_id:y.id}).catch(V=>console.error("Error logging AI query:",V))}catch(j){console.error("Error getting AI response:",j),Qe("Failed to get AI response. Please try again."),t&&f&&y&&f.logConsultantAction(t.id,"AI_QUERY",{query:W,response:"Failed",book_id:b,section_id:y.id,error:String(j)}).catch(V=>console.error("Error logging AI query:",V))}finally{ur(!1)}},Ti=()=>{Le(!1),Qe("")},Pi=()=>{Ze(!1),se(null),N(null),Be(null),xt(null),Pt(null),$t(!1)},fa=async j=>{Ke(!0),N(null),se(null),Be(null),xt(null),Pt(null),$t(!1);try{if(await new Promise(q=>setTimeout(q,300)),!d)throw new Error("Dictionary service not available");const V=y==null?void 0:y.id,X=await d.getDefinition(b,j,V);X&&X.definition?(se(X.definition),Be(X.wordOrigin||null),xt(X.examples&&X.examples.length>0?X.examples[0]:null),Pt(X.source||null),$t(X.isPhrasalVerb||!1),t&&y&&f&&f.logConsultantAction(t.id,"DEFINITION_LOOKUP",{word:j,success:!0,book_id:b,section_id:y.id}).catch(q=>console.error("Error logging dictionary lookup:",q))):(N("No definition found for this word."),t&&y&&f&&f.logConsultantAction(t.id,"DEFINITION_LOOKUP",{word:j,success:!1,book_id:b,section_id:y.id,error:ft}).catch(q=>console.error("Error logging dictionary lookup:",q)))}catch(V){console.error("Error fetching definition:",V),N("Failed to fetch definition. Please try again.")}finally{Ke(!1)}},$i=()=>{ze(null),Q("")},pa=()=>{console.log("Navigate to info center")},Oi=j=>{j.ctrlKey||j.metaKey};return g.useEffect(()=>(document.addEventListener("keydown",Oi),()=>document.removeEventListener("keydown",Oi)),[]),g.useEffect(()=>(document.addEventListener("mouseup",Qt),()=>{document.removeEventListener("mouseup",Qt)}),[]),g.useEffect(()=>{const j=V=>{gt&&ht(!1)};return document.addEventListener("mousedown",j),()=>{document.removeEventListener("mousedown",j)}},[gt]),Me?e.jsxs(p,{sx:{display:"flex",height:"calc(100vh - 64px)"},children:[e.jsxs(p,{sx:{width:"75%",p:3,overflow:"auto",position:"relative"},children:[e.jsx(O,{elevation:$==="page_input"?3:1,sx:{p:3,mb:3,display:"flex",flexDirection:"column",borderLeft:$==="page_input"?"4px solid":"none",borderColor:"primary.main",transition:"all 0.3s ease"},children:e.jsxs(p,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(l,{children:"Page number:"}),e.jsx(ve,{inputRef:ye,type:"number",size:"small",variant:"outlined",value:w,onChange:j=>_(j.target.value),sx:{maxWidth:"120px"},onKeyDown:j=>j.key==="Enter"&&Ci(),placeholder:"7"}),e.jsx(z,{variant:"contained",onClick:Ci,disabled:L,sx:{minWidth:"120px"},children:L?"Loading...":"Find Sections"})]})}),ie&&e.jsx(O,{elevation:3,sx:{mb:4,p:3,background:"linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 50%, #f0f4ff 100%)",borderRadius:3,border:"1px solid",borderColor:"primary.light",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},children:e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs(p,{sx:{flex:1},children:[e.jsx(l,{variant:"h6",color:"primary",sx:{fontWeight:"bold",mb:1},children:ie.word}),e.jsx(l,{variant:"body1",sx:{mb:1},children:ie.definition}),ie.examples&&ie.examples.length>0&&e.jsx(p,{sx:{mt:1},children:ie.examples.map((j,V)=>e.jsxs(l,{variant:"body2",sx:{fontStyle:"italic",color:"text.secondary"},children:['"',j,'"']},V))}),e.jsxs(l,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:1},children:["Source: ",ie.source]})]}),e.jsx(qe,{size:"small",onClick:$i,sx:{ml:2},children:e.jsx(ar,{fontSize:"small"})})]})}),e.jsxs(p,{sx:{flex:1,minHeight:"400px"},children:[L&&e.jsx(Sr,{message:"Loading sections..."}),U&&e.jsx(Sr,{message:U}),!L&&!U&&B.length>0&&!y&&e.jsxs(O,{elevation:$==="section_selection"?3:1,sx:{p:3,borderLeft:$==="section_selection"?"4px solid":"none",borderColor:"primary.main",transition:"all 0.3s ease",height:"100%"},children:[e.jsx(l,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Select which section you are reading:"}),e.jsx(nt,{children:B.map(j=>e.jsx(Oe,{onClick:()=>Ai(j.id),sx:{cursor:"pointer",border:"1px solid",borderColor:"divider",borderRadius:1,mb:1,"&:hover":{backgroundColor:"action.hover",borderColor:"primary.light"}},children:e.jsx(ee,{primary:`Section ${j.number}`,secondary:j.preview,primaryTypographyProps:{fontWeight:"bold"}})},j.id))})]}),!L&&!U&&y&&e.jsx(O,{elevation:$==="content_interaction"?3:1,sx:{p:3,borderLeft:$==="content_interaction"?"4px solid":"none",borderColor:"primary.main",transition:"all 0.3s ease",position:"relative",height:"100%",overflow:"auto"},ref:Ie,onMouseUp:Qt,children:e.jsx(p,{sx:{p:2,border:"1px solid",borderColor:"divider",borderRadius:1,backgroundColor:"background.paper",position:"relative",minHeight:"200px",height:"100%"},children:y.content?e.jsxs(e.Fragment,{children:[e.jsx(p,{ref:Ie,sx:{position:"relative",minHeight:"200px",height:"100%"},children:e.jsx(na,{text:Mr(y.content),onWordSelect:ga,onTextSelect:Qt,fontSize:"1.1rem",lineHeight:1.8,fontFamily:"Georgia, serif",glossaryTerms:x,normalWordHoverColor:"rgba(25, 118, 210, 0.1)",technicalWordHoverColor:"rgba(255, 152, 0, 0.2)"})}),!1,!k&&E>0&&e.jsxs(l,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:["✨ Hover over words to see highlights: ",E," technical terms available"]}),e.jsx(p,{sx:{position:"absolute",left:16,bottom:8},children:e.jsxs(l,{variant:"caption",color:"text.secondary",children:[D?`Page ${D}`:"",y?`, Section ${y.number}`:""]})})]}):e.jsxs(p,{sx:{textAlign:"center",py:2},children:[e.jsx(l,{variant:"body2",color:"error",children:"Section content could not be loaded. Please try selecting the section again."}),e.jsx(z,{variant:"outlined",size:"small",sx:{mt:2},onClick:()=>Ai(y.id),children:"Retry Loading Content"})]})})})]})]}),e.jsxs(p,{sx:{width:"25%",p:2,borderLeft:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column",gap:2},children:[e.jsx(We,{sx:{cursor:"pointer",transition:"all 0.2s","&:hover":{transform:"translateY(-2px)",boxShadow:4}},onClick:()=>Ei(!0),children:e.jsxs(De,{sx:{textAlign:"center",py:2},children:[e.jsx(p,{sx:{width:60,height:60,mx:"auto",mb:1,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#f5f5f5",borderRadius:"50%"},children:e.jsx(aa,{sx:{width:30,height:30,color:"primary.main"}})}),e.jsx(l,{variant:"body2",sx:{fontWeight:"bold"},children:"Request Help from Consultant"}),e.jsx(l,{variant:"caption",color:"text.secondary",children:"Get support by email or phone"})]})}),e.jsx(We,{sx:{cursor:"pointer",transition:"all 0.2s","&:hover":{transform:"translateY(-2px)",boxShadow:4}},onClick:pa,children:e.jsxs(De,{sx:{textAlign:"center",py:2},children:[e.jsx(p,{sx:{width:60,height:60,mx:"auto",mb:1,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#f5f5f5",borderRadius:"50%"},children:e.jsx(Ua,{sx:{width:30,height:30,color:"#333"}})}),e.jsx(l,{variant:"body2",sx:{fontWeight:"bold"},children:"Info Center"}),e.jsx(l,{variant:"caption",color:"text.secondary",children:"More Books & Events"})]})})]}),gt&&e.jsx(p,{sx:{position:"absolute",left:Rt.x,top:Rt.y,zIndex:1e3},children:e.jsx(z,{variant:"contained",color:"primary",size:"small",onClick:Ri,startIcon:e.jsx(Vt,{}),sx:{backgroundColor:"primary.main","&:hover":{backgroundColor:"primary.dark"},boxShadow:2},children:"Ask AI Assistant"})}),e.jsxs(kr,{open:pt,onClose:Pi,maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Ir,{children:['Definition for "',W,'"',la&&e.jsx(l,{variant:"caption",color:"primary",sx:{display:"block",mt:1},children:"📝 Phrasal Verb"}),mt&&e.jsxs(l,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:["Source: ",mt==="glossary"?"Alice Glossary":mt==="external"?"Free Dictionary API":mt==="database"?"Database":mt==="not_found"?"Not Found":mt]})]}),e.jsx(Er,{children:gr?e.jsxs(p,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",p:4,minHeight:"200px"},children:[e.jsx(le,{size:40}),e.jsx(l,{variant:"body2",color:"text.secondary",sx:{mt:2},children:"Looking up definition..."})]}):ft?e.jsxs(p,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",p:4,minHeight:"200px"},children:[e.jsx(l,{color:"error",variant:"h6",gutterBottom:!0,children:"Definition Not Found"}),e.jsx(l,{color:"text.secondary",textAlign:"center",children:ft}),e.jsx(l,{variant:"body2",color:"text.secondary",sx:{mt:2,textAlign:"center"},children:"Try selecting a different word or phrase."})]}):e.jsxs(e.Fragment,{children:[e.jsx(l,{variant:"subtitle1",color:"text.secondary",sx:{fontWeight:"bold",mt:1},children:"Definition"}),e.jsx(l,{variant:"body1",paragraph:!0,children:K||"No definition available"}),Tt&&e.jsxs(e.Fragment,{children:[e.jsx(l,{variant:"subtitle1",color:"text.secondary",sx:{fontWeight:"bold",mt:2},children:"Example"}),e.jsx(l,{variant:"body2",color:"text.secondary",paragraph:!0,children:Tt})]}),Yt&&e.jsxs(e.Fragment,{children:[e.jsx(l,{variant:"subtitle1",color:"text.secondary",sx:{fontWeight:"bold",mt:2},children:"Origin"}),e.jsx(l,{variant:"body2",color:"text.secondary",paragraph:!0,children:Yt})]}),e.jsx(he,{sx:{my:2}}),e.jsxs(p,{sx:{display:"flex",justifyContent:"flex-end",alignItems:"center",mt:2},children:[e.jsx(l,{variant:"body2",color:"text.secondary",sx:{mr:2},children:"Need deeper analysis?"}),e.jsx(z,{variant:"text",color:"secondary",startIcon:e.jsx(Vt,{}),onClick:Ri,sx:{fontWeight:"bold"},children:"Ask AI"})]})]})}),e.jsx(Cr,{children:e.jsx(z,{onClick:Pi,children:"Close"})})]}),e.jsxs(kr,{open:de,onClose:Ti,maxWidth:"md",fullWidth:!0,children:[e.jsx(Ir,{children:"Explanation"}),e.jsx(Er,{children:dr?e.jsx(p,{sx:{display:"flex",justifyContent:"center",p:2},children:e.jsx(le,{})}):e.jsx(l,{variant:"body1",children:xe})}),e.jsx(Cr,{children:e.jsx(z,{onClick:Ti,children:"Close"})})]}),e.jsx(pd,{}),e.jsx(xd,{open:da,onClose:()=>Ei(!1),bookId:i,sectionId:y==null?void 0:y.id,sectionTitle:(y==null?void 0:y.title)||(y?`Section ${y.number}`:void 0)})]}):e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(Sr,{message:"Initializing Companion..."})})};var _i={},yd=H;Object.defineProperty(_i,"__esModule",{value:!0});var oa=_i.default=void 0,bd=yd(Y()),Sd=e;oa=_i.default=(0,bd.default)((0,Sd.jsx)("path",{d:"M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3m-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3m0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5m8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5"}),"People");var ki={},wd=H;Object.defineProperty(ki,"__esModule",{value:!0});var ca=ki.default=void 0,jd=wd(Y()),_d=e;ca=ki.default=(0,jd.default)((0,_d.jsx)("path",{d:"M2 20h20v-4H2zm2-3h2v2H4zM2 4v4h20V4zm4 3H4V5h2zm-4 7h20v-4H2zm2-3h2v2H4z"}),"Storage");function tr(i){const{children:t,value:r,index:n,...s}=i;return e.jsx("div",{role:"tabpanel",hidden:r!==n,id:`admin-tabpanel-${n}`,"aria-labelledby":`admin-tab-${n}`,...s,children:r===n&&e.jsx(p,{sx:{p:3},children:t})})}const kd=()=>{const{user:i,profile:t}=je(),{service:r}=Ae(),{service:n,loading:s}=sl(),[o,c]=g.useState(!0),[d,h]=g.useState(null),[u,f]=g.useState(null),[x,k]=g.useState(0);He({trackPageLoad:!0,trackRender:!0,componentName:"AdminDashboard"}),g.useEffect(()=>{if(!n||!i)return;(async()=>{c(!0),h(null);try{const w=performance.now(),_=await n.getSystemStatus();f({services:[{name:"Authentication Service",status:"healthy",uptime:"99.9%",lastIssue:null},{name:"Book Service",status:"healthy",uptime:"99.7%",lastIssue:"2023-06-10T15:30:00Z"},{name:"Dictionary Service",status:"degraded",uptime:"98.5%",lastIssue:"2023-06-15T08:45:00Z"},{name:"AI Service",status:"healthy",uptime:"99.8%",lastIssue:"2023-06-12T11:20:00Z"},{name:"Feedback Service",status:"healthy",uptime:"99.9%",lastIssue:null},{name:"Trigger Service",status:"healthy",uptime:"99.9%",lastIssue:null},{name:"Statistics Service",status:"healthy",uptime:"99.9%",lastIssue:null},{name:"Consultant Service",status:"healthy",uptime:"99.8%",lastIssue:"2023-06-11T09:15:00Z"}],database:{status:"healthy",connectionPool:"12/20",avgQueryTime:"45ms",storage:{used:"2.3GB",total:"20GB",percentage:11.5}},users:{total:125,active:78,consultants:5,admins:2},activity:{registrations:[5,8,12,7,10,15,9],logins:[25,30,28,35,40,38,42],aiQueries:[120,145,135,160,180,175,190],helpRequests:[8,12,10,15,18,14,16]},alerts:[{id:"a1",type:"warning",message:"Dictionary Service experiencing increased latency",timestamp:"2023-06-15T08:45:00Z"},{id:"a2",type:"info",message:"System update scheduled for June 20, 2023",timestamp:"2023-06-14T10:00:00Z"}],..._}),r&&r.trackPageView("admin_dashboard",{userId:i.id})}catch(w){console.error("Error loading system status:",w),h("Failed to load system status. Please try again."),r&&r.trackEvent("admin_dashboard_error",{error:String(w)})}finally{c(!1)}})()},[n,i,r]);const v=(b,w)=>{k(w),r&&r.trackEvent("admin_tab_change",{tabIndex:w})},E=b=>b?new Date(b).toLocaleString():"Never";return o||s?e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(le,{})}):d?e.jsxs(p,{sx:{p:3,textAlign:"center"},children:[e.jsx(l,{color:"error",variant:"h6",gutterBottom:!0,children:d}),e.jsx(z,{variant:"contained",onClick:()=>window.location.reload(),sx:{mt:2},children:"Retry"})]}):t!=null&&t.is_admin?e.jsxs(p,{sx:{p:3,maxWidth:"1200px",mx:"auto"},children:[e.jsxs(p,{sx:{mb:4},children:[e.jsx(l,{variant:"h4",gutterBottom:!0,children:"Admin Dashboard"}),e.jsx(l,{variant:"body1",color:"text.secondary",children:"System monitoring and management"})]}),u.alerts.length>0&&e.jsx(p,{sx:{mb:4},children:u.alerts.map(b=>e.jsxs(fe,{severity:b.type,sx:{mb:2},children:[e.jsx(l,{variant:"body1",children:b.message}),e.jsx(l,{variant:"body2",color:"text.secondary",children:E(b.timestamp)})]},b.id))}),e.jsxs(m,{container:!0,spacing:3,sx:{mb:4},children:[e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(O,{elevation:2,sx:{height:"100%",borderRadius:2},children:[e.jsx(p,{sx:{p:2,bgcolor:"primary.main",color:"white",borderTopLeftRadius:8,borderTopRightRadius:8},children:e.jsx(l,{variant:"h6",children:"Users"})}),e.jsxs(De,{children:[e.jsx(l,{variant:"h3",align:"center",gutterBottom:!0,children:u.users.total}),e.jsx(he,{sx:{my:2}}),e.jsxs(m,{container:!0,spacing:1,children:[e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Active:"}),e.jsx(l,{variant:"body1",children:u.users.active})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Consultants:"}),e.jsx(l,{variant:"body1",children:u.users.consultants})]})]})]})]})}),e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(O,{elevation:2,sx:{height:"100%",borderRadius:2},children:[e.jsx(p,{sx:{p:2,bgcolor:"secondary.main",color:"white",borderTopLeftRadius:8,borderTopRightRadius:8},children:e.jsx(l,{variant:"h6",children:"Services"})}),e.jsxs(De,{children:[e.jsx(l,{variant:"h3",align:"center",gutterBottom:!0,children:u.services.length}),e.jsx(he,{sx:{my:2}}),e.jsxs(m,{container:!0,spacing:1,children:[e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Healthy:"}),e.jsx(l,{variant:"body1",children:u.services.filter(b=>b.status==="healthy").length})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Issues:"}),e.jsx(l,{variant:"body1",children:u.services.filter(b=>b.status!=="healthy").length})]})]})]})]})}),e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(O,{elevation:2,sx:{height:"100%",borderRadius:2},children:[e.jsx(p,{sx:{p:2,bgcolor:"success.main",color:"white",borderTopLeftRadius:8,borderTopRightRadius:8},children:e.jsx(l,{variant:"h6",children:"Database"})}),e.jsxs(De,{children:[e.jsxs(p,{sx:{display:"flex",alignItems:"center",justifyContent:"center",mb:2},children:[e.jsx(l,{variant:"h6",align:"center",children:u.database.status==="healthy"?"Healthy":"Issues"}),u.database.status==="healthy"?e.jsx(bt,{color:"success",sx:{ml:1}}):e.jsx(Ut,{color:"error",sx:{ml:1}})]}),e.jsx(he,{sx:{my:2}}),e.jsx(l,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Storage:"}),e.jsxs(p,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(p,{sx:{width:"100%",mr:1},children:e.jsx(jr,{variant:"determinate",value:u.database.storage.percentage,sx:{height:8,borderRadius:5}})}),e.jsx(p,{sx:{minWidth:35},children:e.jsxs(l,{variant:"body2",color:"text.secondary",children:[u.database.storage.percentage,"%"]})})]}),e.jsxs(l,{variant:"body2",children:[u.database.storage.used," / ",u.database.storage.total]})]})]})}),e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(O,{elevation:2,sx:{height:"100%",borderRadius:2},children:[e.jsx(p,{sx:{p:2,bgcolor:"info.main",color:"white",borderTopLeftRadius:8,borderTopRightRadius:8},children:e.jsx(l,{variant:"h6",children:"Today's Activity"})}),e.jsx(De,{children:e.jsxs(m,{container:!0,spacing:1,children:[e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Logins:"}),e.jsx(l,{variant:"h6",children:u.activity.logins[u.activity.logins.length-1]})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Registrations:"}),e.jsx(l,{variant:"h6",children:u.activity.registrations[u.activity.registrations.length-1]})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"AI Queries:"}),e.jsx(l,{variant:"h6",children:u.activity.aiQueries[u.activity.aiQueries.length-1]})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Help Requests:"}),e.jsx(l,{variant:"h6",children:u.activity.helpRequests[u.activity.helpRequests.length-1]})]})]})})]})})]}),e.jsxs(O,{sx:{mb:4,borderRadius:2,overflow:"hidden"},children:[e.jsxs(on,{value:x,onChange:v,indicatorColor:"primary",textColor:"primary",variant:"fullWidth",children:[e.jsx(ut,{icon:e.jsx(ir,{}),label:"Services"}),e.jsx(ut,{icon:e.jsx(ca,{}),label:"Database"}),e.jsx(ut,{icon:e.jsx(oa,{}),label:"Users"}),e.jsx(ut,{icon:e.jsx(nr,{}),label:"Content"})]}),e.jsxs(tr,{value:x,index:0,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Service Status"}),e.jsx(nt,{children:u.services.map((b,w)=>e.jsxs(Oe,{sx:{mb:2,p:2,bgcolor:"background.paper",borderRadius:2,boxShadow:1},children:[e.jsx(we,{children:b.status==="healthy"?e.jsx(bt,{color:"success"}):b.status==="degraded"?e.jsx(Wr,{color:"warning"}):e.jsx(Ut,{color:"error"})}),e.jsx(ee,{primary:b.name,secondary:e.jsx(e.Fragment,{children:e.jsxs(l,{component:"span",variant:"body2",children:["Uptime: ",b.uptime," • Last Issue: ",E(b.lastIssue)]})})}),e.jsx(tt,{label:b.status,color:b.status==="healthy"?"success":b.status==="degraded"?"warning":"error"})]},w))})]}),e.jsxs(tr,{value:x,index:1,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Database Status"}),e.jsx(O,{sx:{p:3,mb:3},children:e.jsxs(m,{container:!0,spacing:3,children:[e.jsxs(m,{item:!0,xs:12,md:4,children:[e.jsx(l,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Status:"}),e.jsxs(p,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(l,{variant:"h6",children:u.database.status==="healthy"?"Healthy":"Issues"}),u.database.status==="healthy"?e.jsx(bt,{color:"success",sx:{ml:1}}):e.jsx(Ut,{color:"error",sx:{ml:1}})]})]}),e.jsxs(m,{item:!0,xs:12,md:4,children:[e.jsx(l,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Connection Pool:"}),e.jsx(l,{variant:"h6",children:u.database.connectionPool})]}),e.jsxs(m,{item:!0,xs:12,md:4,children:[e.jsx(l,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Average Query Time:"}),e.jsx(l,{variant:"h6",children:u.database.avgQueryTime})]})]})}),e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Storage Usage"}),e.jsxs(O,{sx:{p:3},children:[e.jsxs(l,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:[u.database.storage.used," used of ",u.database.storage.total," total"]}),e.jsx(jr,{variant:"determinate",value:u.database.storage.percentage,sx:{height:10,borderRadius:5,mb:2}}),e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(O,{sx:{p:2,bgcolor:"primary.light"},children:[e.jsx(l,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"User Data"}),e.jsx(l,{variant:"h6",children:"0.5GB"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(O,{sx:{p:2,bgcolor:"secondary.light"},children:[e.jsx(l,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Book Content"}),e.jsx(l,{variant:"h6",children:"1.2GB"})]})}),e.jsx(m,{item:!0,xs:12,sm:4,children:e.jsxs(O,{sx:{p:2,bgcolor:"info.light"},children:[e.jsx(l,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Analytics"}),e.jsx(l,{variant:"h6",children:"0.6GB"})]})})]})]})]}),e.jsxs(tr,{value:x,index:2,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"User Statistics"}),e.jsxs(m,{container:!0,spacing:3,children:[e.jsx(m,{item:!0,xs:12,md:6,children:e.jsxs(O,{sx:{p:3,height:"100%"},children:[e.jsx(l,{variant:"subtitle1",gutterBottom:!0,children:"User Breakdown"}),e.jsx(p,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(l,{variant:"body1",color:"text.secondary",children:"[Pie Chart Visualization]"})}),e.jsxs(m,{container:!0,spacing:2,children:[e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Readers:"}),e.jsx(l,{variant:"h6",children:u.users.total-u.users.consultants-u.users.admins})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Consultants:"}),e.jsx(l,{variant:"h6",children:u.users.consultants})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Admins:"}),e.jsx(l,{variant:"h6",children:u.users.admins})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Active Users:"}),e.jsx(l,{variant:"h6",children:u.users.active})]})]})]})}),e.jsx(m,{item:!0,xs:12,md:6,children:e.jsxs(O,{sx:{p:3,height:"100%"},children:[e.jsx(l,{variant:"subtitle1",gutterBottom:!0,children:"Registration Trend"}),e.jsx(p,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(l,{variant:"body1",color:"text.secondary",children:"[Line Chart Visualization]"})}),e.jsxs(m,{container:!0,spacing:2,children:[e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Today:"}),e.jsx(l,{variant:"h6",children:u.activity.registrations[u.activity.registrations.length-1]})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"This Week:"}),e.jsx(l,{variant:"h6",children:u.activity.registrations.reduce((b,w)=>b+w,0)})]}),e.jsx(m,{item:!0,xs:12,children:e.jsx(z,{variant:"outlined",fullWidth:!0,component:re,to:"/admin/users",children:"View User Management"})})]})]})})]})]}),e.jsxs(tr,{value:x,index:3,children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Content Management"}),e.jsxs(m,{container:!0,spacing:3,children:[e.jsx(m,{item:!0,xs:12,md:6,children:e.jsxs(O,{sx:{p:3},children:[e.jsx(l,{variant:"subtitle1",gutterBottom:!0,children:"Books"}),e.jsx(nt,{children:e.jsxs(Oe,{children:[e.jsx(we,{children:e.jsx(nr,{})}),e.jsx(ee,{primary:"Alice in Wonderland",secondary:"Active • 125 readers"}),e.jsx(z,{variant:"outlined",size:"small",component:re,to:"/admin/books/alice-in-wonderland",children:"Manage"})]})}),e.jsx(z,{variant:"contained",fullWidth:!0,component:re,to:"/admin/books/add",sx:{mt:2},children:"Add New Book"})]})}),e.jsx(m,{item:!0,xs:12,md:6,children:e.jsxs(O,{sx:{p:3},children:[e.jsx(l,{variant:"subtitle1",gutterBottom:!0,children:"Content Statistics"}),e.jsxs(m,{container:!0,spacing:2,sx:{mb:3},children:[e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Total Books:"}),e.jsx(l,{variant:"h6",children:"1"})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Total Pages:"}),e.jsx(l,{variant:"h6",children:"100"})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"Dictionary Entries:"}),e.jsx(l,{variant:"h6",children:"2,500"})]}),e.jsxs(m,{item:!0,xs:6,children:[e.jsx(l,{variant:"body2",color:"text.secondary",children:"AI Prompts:"}),e.jsx(l,{variant:"h6",children:"150"})]})]}),e.jsx(z,{variant:"outlined",fullWidth:!0,component:re,to:"/admin/content",children:"View Content Dashboard"})]})})]})]})]}),e.jsxs(O,{sx:{p:3,borderRadius:2},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Quick Actions"}),e.jsx(he,{sx:{mb:2}}),e.jsxs(m,{container:!0,spacing:2,children:[e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsx(z,{variant:"outlined",fullWidth:!0,component:re,to:"/admin/users",sx:{py:1.5},children:"User Management"})}),e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsx(z,{variant:"outlined",fullWidth:!0,component:re,to:"/admin/services",sx:{py:1.5},children:"Service Status"})}),e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsx(z,{variant:"outlined",fullWidth:!0,component:re,to:"/admin/logs",sx:{py:1.5},children:"System Logs"})}),e.jsx(m,{item:!0,xs:12,sm:6,md:3,children:e.jsx(z,{variant:"outlined",fullWidth:!0,component:re,to:"/admin/settings",sx:{py:1.5},children:"System Settings"})})]})]})]}):e.jsxs(p,{sx:{p:3,textAlign:"center"},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"You don't have admin access."}),e.jsx(z,{variant:"contained",component:re,to:"/reader",sx:{mt:2},children:"Go to Reader Dashboard"})]})},Id=()=>{const[i,t]=g.useState(!1),[r,n]=g.useState(null),[s,o]=g.useState("unknown"),[c,d]=g.useState([]),h=async()=>{t(!0),n(null),d([]),o("unknown");const u=[];try{a("SupabaseTest","Starting Supabase connection tests","info");try{const f=await A();u.push({name:"Initialize Supabase Client",status:"success",message:"Supabase client initialized successfully"});try{const x=performance.now(),{data:k,error:v}=await f.from("books").select("count").limit(1),E=performance.now();if(v)throw v;u.push({name:"Ping Supabase",status:"success",message:`Connected to Supabase in ${Math.round(E-x)}ms`});try{const{data:b,error:w}=await f.from("books").select("id, title, author").limit(5);if(w)throw w;u.push({name:"Fetch Books",status:"success",message:`Successfully fetched ${(b==null?void 0:b.length)||0} books`});try{const{data:_,error:D}=await f.auth.getSession();if(D)throw D;u.push({name:"Check Auth",status:"success",message:_!=null&&_.session?"User is authenticated":"No active session"}),o("success")}catch(_){u.push({name:"Check Auth",status:"error",message:`Auth error: ${_.message}`}),o("error")}}catch(b){u.push({name:"Fetch Books",status:"error",message:`Error fetching books: ${b.message}`}),o("error")}}catch(x){u.push({name:"Ping Supabase",status:"error",message:`Error connecting to Supabase: ${x.message}`}),o("error")}}catch(f){u.push({name:"Initialize Supabase Client",status:"error",message:`Error initializing Supabase client: ${f.message}`}),o("error")}}catch(f){n(`An unexpected error occurred: ${f.message}`),o("error")}finally{d(u),t(!1),a("SupabaseTest","Supabase connection tests completed","info")}};return e.jsxs(p,{sx:{maxWidth:800,mx:"auto",p:3},children:[e.jsx(l,{variant:"h4",gutterBottom:!0,children:"Supabase Connection Test"}),e.jsxs(O,{sx:{p:3,mb:3},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Configuration"}),e.jsx(p,{sx:{mb:2},children:e.jsxs(l,{variant:"body1",children:[e.jsx("strong",{children:"Backend Mode:"})," "," ",e.jsx("span",{style:{color:"#2196f3",fontWeight:"bold"},children:"REAL Supabase"})]})}),e.jsx(z,{variant:"contained",color:"primary",onClick:h,disabled:i,startIcon:i?e.jsx(le,{size:20,color:"inherit"}):null,children:i?"Testing...":"Run Connection Test"})]}),s!=="unknown"&&e.jsxs(O,{sx:{p:3},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Test Results"}),s==="success"?e.jsx(fe,{severity:"success",sx:{mb:2},children:"Successfully connected to Supabase!"}):e.jsx(fe,{severity:"error",sx:{mb:2},children:"Failed to connect to Supabase. Check the test results below for details."}),r&&e.jsx(fe,{severity:"error",sx:{mb:2},children:r}),e.jsx(nt,{children:c.map((u,f)=>e.jsxs(At.Fragment,{children:[e.jsx(Oe,{children:e.jsx(ee,{primary:e.jsxs(p,{sx:{display:"flex",alignItems:"center"},children:[e.jsx("span",{style:{color:u.status==="success"?"#4caf50":"#f44336",marginRight:"8px",fontWeight:"bold"},children:u.status==="success"?"✓":"✗"}),e.jsx("span",{style:{fontWeight:"bold"},children:u.name})]}),secondary:u.message})}),f<c.length-1&&e.jsx(he,{})]},f))})]})]})},Ed=async()=>{a("Services","Initializing services using new registry pattern","info"),console.log("Services: Initializing services using new registry pattern");try{console.log("Services: Importing serviceInitializers module");const i=await ge(()=>Promise.resolve().then(()=>tl),void 0);if(console.log("Services: serviceInitializers module imported:",i),typeof i.initializeServices!="function")throw console.error("Services: initializeServices is not a function in the imported module:",i),new Error("initializeServices is not a function in the serviceInitializers module");console.log("Services: Calling initializeServices from serviceInitializers"),i.initializeServices(),console.log("Services: Manually initializing authService");const{createAuthService:t}=await ge(()=>Promise.resolve().then(()=>An),void 0);console.log("Services: authService module imported, createAuthService:",t),console.log("Services: Manually initializing bookService");const{createBookService:r}=await ge(()=>Promise.resolve().then(()=>Vn),void 0);return console.log("Services: bookService module imported, createBookService:",r),a("Services","Services initialized successfully","success"),console.log("Services: Services initialized successfully"),!0}catch(i){return a("Services",`Error initializing services: ${i.message}`,"error"),console.error("Services: Error initializing services:",i),!1}};function Cd(){console.log("App.tsx: Component rendering");const[i,t]=g.useState(!1),[r,n]=g.useState(null);if(g.useEffect(()=>{const o=async()=>{try{a("App","Initializing services","info"),console.log("App: Initializing services - VERBOSE DEBUG"),console.log("App: Environment check - VITE_SUPABASE_URL exists:",!0),console.log("App: Environment check - VITE_SUPABASE_ANON_KEY exists:",!0),console.log("App: About to call initializeServices()");const c=await Ed();console.log("App: Services initialization result:",c),await Wl(),console.log("App: Setting initialized state to true"),t(!0),a("App","Services initialized successfully","success"),console.log("App: Services initialized successfully"),Ga({type:"app_start",timestamp:new Date().toISOString()})}catch(c){console.error("App: Failed to initialize services:",c),console.error("App: Error details:",c.stack||"No stack trace available"),a("App",`Failed to initialize services: ${c.message}`,"error"),n("Failed to initialize application. Please check the console for details.")}};console.log("App: Running init effect"),o()},[]),r)return e.jsxs("div",{className:"error-container",children:[e.jsx("h2",{children:"Initialization Error"}),e.jsx("p",{children:r}),e.jsx("button",{onClick:()=>window.location.reload(),children:"Retry"})]});if(!i)return e.jsxs("div",{className:"loading-container",children:[e.jsx("h2",{children:"Initializing Application..."}),e.jsx("p",{children:"Please wait while the services are being initialized."})]});const s=()=>e.jsx(Wa,{children:e.jsxs("div",{className:"App",children:[e.jsx(Ic,{contentId:"main-content"}),e.jsx(Jc,{}),e.jsx("main",{id:"main-content",children:e.jsxs(qa,{children:[e.jsx(ue,{path:"/",element:e.jsx(pe,{routeType:"public",children:e.jsx(Xi,{})})}),e.jsx(ue,{path:"/login",element:e.jsx(pe,{routeType:"public",children:e.jsx(en,{})})}),e.jsx(ue,{path:"/login-legacy",element:e.jsx(pe,{routeType:"public",children:e.jsx(en,{})})}),e.jsx(ue,{path:"/register",element:e.jsx(pe,{routeType:"public",children:e.jsx(ml,{})})}),e.jsx(ue,{path:"/forgot-password",element:e.jsx(pe,{routeType:"public",children:e.jsx(yl,{})})}),e.jsx(ue,{path:"/consultant-landing",element:e.jsx(pe,{routeType:"public",children:e.jsx(Xi,{})})}),e.jsx(ue,{path:"/verify",element:e.jsx(pe,{routeType:"auth",children:e.jsx(vl,{})})}),e.jsx(ue,{path:"/welcome",element:e.jsx(pe,{routeType:"auth",children:e.jsx(pl,{})})}),e.jsx(ue,{path:"/reader",element:e.jsx(pe,{routeType:"verified",children:e.jsx(Yl,{})})}),e.jsx(ue,{path:"/reader/interaction",element:e.jsx(pe,{routeType:"verified",children:e.jsx(nn,{})})}),e.jsx(ue,{path:"/reader/book/:bookId",element:e.jsx(pe,{routeType:"verified",children:e.jsx(nn,{})})}),e.jsx(ue,{path:"/reader/:bookId/page/:pageNumber",element:e.jsx(pe,{routeType:"verified",children:e.jsx(cd,{})})}),e.jsx(ue,{path:"/reader/statistics",element:e.jsx(pe,{routeType:"verified",children:e.jsx(dd,{})})}),e.jsx(ue,{path:"/admin",element:e.jsx(pe,{routeType:"admin",children:e.jsx(kd,{})})}),e.jsx(ue,{path:"/service-status",element:e.jsx(pe,{routeType:"admin",children:e.jsx(yc,{})})}),e.jsx(ue,{path:"/supabase-test",element:e.jsx(Id,{})}),!1,!1,!1,!1,!1,!1,!1]})})]})});return e.jsx(Ec,{children:e.jsx(jc,{children:e.jsx(kc,{children:e.jsx(Gl,{children:e.jsx(s,{})})})})})}const Vd=Object.freeze(Object.defineProperty({__proto__:null,default:Cd},Symbol.toStringTag,{value:"Module"}));export{Vd as A,Md as B,jt as I,G as S,Nd as a,Bd as b,Ld as d,Jn as g,te as h,Nt as l,S as r,Ud as s};
